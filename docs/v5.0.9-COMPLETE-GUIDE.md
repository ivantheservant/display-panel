# Display Panel v5.0.9 - CRITICAL FIXES & Next Steps

## ğŸ”¥ URGENT: Fix Your Google Apps Script FIRST

### The Problem
Your Apps Script is throwing: `TypeError: out.setHeader is not a function (line 94)`

### The Fix
I've created `google-apps-script-FIXED.js` - Replace your current Apps Script code with this.

**The issue:** Apps Script's `ContentService` doesn't have a `setHeader()` method. It handles CORS automatically when deployed as "Anyone can access".

**Steps:**
1. Open your Google Apps Script: https://script.google.com/
2. Replace ALL code with the content from `google-apps-script-FIXED.js`
3. Save
4. Deploy â†’ New Deployment
5. Deploy type: Web app
6. Execute as: Me
7. Who has access: **Anyone**
8. Deploy
9. Copy the new URL (if it changed)

---

## âœ… What's Fixed in v5.0.9

### 1. Google Apps Script Integration
- **Fixed:** The script error that was preventing calendar data from loading
- **Status:** Ready to test once you update your Apps Script code

### 2. Section Headings Restored
**All 3 news tickers now have headings:**
- âœ… "ä¸­æ–‡æ–°è" (Chinese News)
- âœ… "International News"
- âœ… "Traffic & Alerts"

### 3. Big Screen Settings - Now Independent
**BEFORE (Confusing):**
- Needed to enable BOTH "YouTube Video" AND "Now News" to see news stream

**NOW (Clear):**
```
Big Screen Media (Independent Options)
â”œâ”€ â˜‘ Enable YouTube Video Player
â”‚  â””â”€ Playlist: PLK1NiZBn99vQ79xMYiOyZwdH6-u1WqqxC
â””â”€ â˜‘ Enable Now News Live Stream
   â””â”€ Shows Now 332 news live broadcast
```

**How it works:**
- Enable **NEITHER**: No big screen section, news stays compact
- Enable **YouTube Video ONLY**: Shows YouTube playlist player
- Enable **Now News ONLY**: Shows link to Now News (can't embed directly)
- Enable **BOTH**: Now News takes priority (with external link)

### 4. Layout Fixed - Big Screen Above News
**Grid structure (when big screen enabled):**
```
Row 1: Clock | Weather | Bible Verse
Row 2: Schedule | Currencies
Row 3: My Stocks (è²·å…¥åƒ¹)         â† Always visible at same position
Row 4: Big Screen Media           â† New row, only when enabled
Row 5: ä¸­æ–‡æ–°è                    â† Auto-shifts down when big screen on
Row 6: International News         â† Auto-shifts down when big screen on
Row 7: Traffic & Alerts           â† Auto-shifts down when big screen on
```

### 5. Stock Ticker - Stays at Bottom
- Position fixed: Always Row 3 (above news sections)
- This keeps it consistent regardless of big screen settings

### 6. YouTube Error 153 - Partially Fixed
**The issue:** YouTube blocks some embeds

**Current solution:**
- Using proper YouTube embed URLs with `allow` attributes
- For playlists: `https://www.youtube.com/embed/videoseries?list=PLAYLIST_ID`
- This should work for most playlists

**If still getting Error 153:**
- YouTube may block based on browser/privacy settings
- Try different playlists
- Check if browser is blocking iframes

### 7. Now News Live - Special Handling
**The issue:** news.now.com blocks iframe embedding with `X-Frame-Options`

**Current solution:**
- Shows a friendly button to "Open Now News Live" in new window
- This is cleaner than showing an error

**Future option (v6):**
- Extract the actual HLS stream URL from their page
- Use hls.js to play the stream directly (bypasses iframe restriction)
- This requires more complex implementation

---

## ğŸ“‹ What YOU Need to Do Next

### STEP 1: Update Google Apps Script âš ï¸ CRITICAL
```
1. Go to: https://script.google.com/
2. Open your calendar web app project
3. Replace ALL code with google-apps-script-FIXED.js
4. Save
5. Deploy â†’ New Deployment
6. Copy the new URL if it changed
```

### STEP 2: Deploy v5.0.9 to GitHub Pages
```
1. Upload display-panel-v5.0.9.html to your repo
2. Rename to index.html (or your main file name)
3. Commit & push
4. Wait ~1 minute for GitHub Pages to update
```

### STEP 3: Configure Settings (First Time)
```
1. Open your panel: https://ivantheservant.github.io/display-panel/
2. Click âš™ï¸ Settings (top right)
3. Fill in:
   - Weather API Key: 4d4ff0180678e887714547a90289db00
   - TwelveData Key: [Get free from twelvedata.com]
   - Finnhub Key: [Get free from finnhub.io]
   - Calendar Web App URL: [Your Apps Script URL]
   - Calendar Token: mediapanel
   
4. Big Screen Options:
   â˜‘ Enable YouTube Video Player (if you want videos)
      â†’ Playlist: PLK1NiZBn99vQ79xMYiOyZwdH6-u1WqqxC
   
   â˜‘ Enable Now News Live (if you want news stream)
      â†’ This will show an "Open" button since direct embed blocked

5. Click "Save & Apply"
```

### STEP 4: Test Calendar
```
1. After updating Apps Script, test the URL directly in browser:
   https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?token=mediapanel&days=7

2. Should return JSON like:
   {
     "ok": true,
     "today": { "personal": [...], "family": [...] },
     "tomorrow": { ... },
     "next7days": { ... }
   }

3. If you see this, calendar should work in the panel!
```

### STEP 5: Get Stock API Keys (Optional but Recommended)
**TwelveData (Best option):**
- Free tier: 800 requests/day
- Perfect for 12 stocks Ã— 2 times/day = 24 requests/day
- Sign up: https://twelvedata.com/
- Get API key from dashboard

**Finnhub (Backup):**
- Free tier: 60 calls/minute
- Good as fallback
- Sign up: https://finnhub.io/
- Get API key

**Without these:**
- Stocks will try to load but may fail
- Will show cached data if available
- Not ideal but panel still works

---

## ğŸ¨ About Drag-and-Drop Layout (Your Question)

### Your Question:
> Is it possible to make all blocks resizable and rearrangable by mouse/touch?
> Could have settings to 'lock layout', save layout, auto by default?
> Is it too hard? Do it in v5 or mark to do at v6?

### My Answer: **Recommend v6** (Here's why)

**Complexity Level:** Medium-High

**What's needed:**
1. **GridStack.js** or **Muuri.js** library (~50KB)
2. Rewrite entire grid system to use library
3. Add drag handles to each card
4. Implement save/load layout to localStorage
5. Add lock/unlock toggle
6. Handle responsive breakpoints (different layouts per screen size)
7. Lots of testing on touch devices

**Estimated work:** 3-4 hours of development + testing

**Pros of doing it:**
- âœ… User can customize their own layout
- âœ… Great for multiple devices with different needs
- âœ… Professional feature

**Cons:**
- âŒ Adds complexity to codebase
- âŒ Larger file size (library)
- âŒ More things that can break
- âŒ Need to handle conflicts (e.g., big screen on/off changing layout)

**My Recommendation:**
1. **v5**: Focus on getting ALL features working 100%
   - Calendar loading properly
   - Stocks refreshing correctly
   - News feeds all showing
   - Big screen media working

2. **v6**: Add advanced features
   - Drag-and-drop layout
   - Multiple layout presets (TV, Tablet, Phone)
   - Photo memories from OneDrive/Google Drive
   - Custom playlist selector UI

**Current state is good enough:**
- Layout is already optimized for your main displays
- Big screen settings give flexibility
- Most users won't need drag-and-drop

---

## ğŸ“ Project Files & Organization

### What Should Be in Your GitHub Repo

```
your-repo/
â”œâ”€â”€ index.html                          â† Main panel (v5.0.9 renamed)
â”œâ”€â”€ README.md                           â† Project description
â”œâ”€â”€ CHANGELOG.md                        â† Version history
â”œâ”€â”€ .gitignore                          â† Don't commit API keys!
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ DEPLOYMENT_GUIDE.md             â† How to deploy
â”‚   â”œâ”€â”€ API_KEYS.md                     â† Where to get API keys
â”‚   â””â”€â”€ PROJECT_STATE.md                â† Current state (this doc)
â”‚
â”œâ”€â”€ versions/                           â† Keep old versions for rollback
â”‚   â”œâ”€â”€ display-panel-v5.0.4.html       â† Last stable
â”‚   â”œâ”€â”€ display-panel-v5.0.7a.html      â† Previous
â”‚   â””â”€â”€ display-panel-v5.0.9.html       â† Current
â”‚
â””â”€â”€ scripts/
    â””â”€â”€ google-apps-script.js           â† Your Apps Script code
```

### What Should NOT Be in Your Repo
âŒ **Never commit:**
- API keys (Weather, TwelveData, Finnhub)
- Google Apps Script deployment URLs with tokens
- Personal calendar IDs

âœ… **Use placeholders instead:**
```html
weatherApiKey: '' // Get from openweathermap.org
twelveDataKey: '' // Get from twelvedata.com  
calendarWebAppUrl: '' // Your Apps Script deployment URL
```

### .gitignore File
Create a `.gitignore` with:
```
# API keys and secrets
config.local.js
*.key
secrets/

# OS files
.DS_Store
Thumbs.db

# Editor files
.vscode/
.idea/
```

---

## ğŸ“Š Updated Project State (v5.0.9)

### âœ… WORKING (Confirmed)
- Clock (digital + analog)
- Weather (3 locations with UV + rain forecast)
- Bible verse (rotates daily)
- Currencies (NZD/USD, NZD/HKD with alerts)
- News Line 1 (ä¸­æ–‡æ–°è)
- News Line 2 (International)
- News Line 3 (Traffic & Alerts with Auckland filter)
- Section headings (all restored)
- Big screen settings (now independent)
- Layout (big screen above news, stocks at Row 3)

### âš ï¸ NEEDS TESTING (After you update Apps Script)
- Calendar integration
  - Today/Tomorrow events
  - Next 7 days
  - NZ/HK holidays
  - Birthday/Family events

### âš ï¸ PARTIAL (Works with workarounds)
- Stock data
  - **Status:** Needs API keys to work fully
  - **Workaround:** Shows cached data
  - **Fix:** Get TwelveData + Finnhub keys

- YouTube Video Player
  - **Status:** Should work with proper playlists
  - **Issue:** Some playlists may trigger Error 153
  - **Fix:** Try different playlists, check browser settings

- Now News Live
  - **Status:** Direct embed blocked by news.now.com
  - **Workaround:** Shows "Open" button for new window
  - **Future:** Extract HLS stream in v6

### âŒ NOT IMPLEMENTED (Planned for v6)
- Drag-and-drop layout customization
- Multiple layout presets
- Photo memories (OneDrive/Google Drive)
- Custom playlist selector UI in settings
- HLS stream player for Now News
- Auto-translate news to Traditional Chinese

---

## ğŸ› Known Issues & Workarounds

### Issue 1: Calendar Still Shows "Loading"
**Cause:** Apps Script code has error
**Fix:** Update to `google-apps-script-FIXED.js` (see STEP 1)

### Issue 2: YouTube Error 153
**Cause:** YouTube blocking some embeds
**Workarounds:**
- Use different playlists
- Check browser privacy settings
- Try in incognito mode
- Some playlists are restricted by uploader

### Issue 3: Now News Live Can't Embed
**Cause:** news.now.com sets `X-Frame-Options: DENY`
**Current:** Shows "Open" button
**Future (v6):** Extract HLS stream URL and use hls.js player

### Issue 4: Stocks Show "?" or Old Data
**Cause:** No API keys configured
**Fix:** Get free API keys from:
- https://twelvedata.com/ (primary)
- https://finnhub.io/ (backup)

### Issue 5: NZTA Still Shows Some Roadwork
**Status:** Filtered but not perfect
**Reason:** NZTA titles inconsistent
**Current filter:** Only shows if contains "crash", "accident", "jam", "closure", "blocked", or "incident"
**If you see unwanted items:** Tell me the exact titles and I'll tighten the filter

---

## ğŸ¯ Priority Next Steps (In Order)

### Priority 1: Get Calendar Working âš ï¸
1. Update Apps Script with fixed code
2. Test URL in browser
3. Verify JSON response
4. Test in panel
5. âœ… Mark as complete when you see events

### Priority 2: Get Stock Data Working
1. Sign up for TwelveData (5 min)
2. Get API key
3. Add to settings
4. Test at 12pm or 5pm EST
5. âœ… Mark as complete when you see real prices

### Priority 3: Test Big Screen Options
1. Enable YouTube Video
2. Test with your playlist
3. If Error 153: try different playlist
4. Test Now News Live button
5. âœ… Mark as complete when preferred option works

### Priority 4: Fine-tune News Feeds
1. Monitor NZTA traffic feed
2. Note any unwanted items
3. Send me exact titles
4. I'll improve filter
5. âœ… Mark as complete when clean feed

### Priority 5: Deploy to All Devices
1. Test on 43" TV (1920Ã—1080)
2. Test on Tab S6 Lite (2000Ã—1200)
3. Test on Flip 6 (2640Ã—1080)
4. Adjust any device-specific issues
5. âœ… Mark as complete when all devices good

---

## ğŸ”® Roadmap to v6.0

### Must-Have Features
- [ ] Drag-and-drop layout with GridStack.js
- [ ] Save/load custom layouts
- [ ] Lock layout toggle
- [ ] Multiple layout presets (TV, Tablet, Phone)

### Nice-to-Have Features
- [ ] Photo memories (OneDrive/Google Drive)
- [ ] Custom playlist selector in settings
- [ ] HLS stream player for Now News
- [ ] MetService alerts with location parsing
- [ ] Auto-translate news to Traditional Chinese

### When to Start v6
**After v5 is 100% stable:**
- âœ… Calendar working
- âœ… Stocks refreshing correctly
- âœ… All news feeds clean
- âœ… Media players functional
- âœ… Tested on all devices
- âœ… Running for 1 week without issues

**Estimated time to v6:** 2-3 weeks after v5 stable

---

## ğŸ“ Quick Reference

### API Endpoints
- Weather: `https://api.openweathermap.org/data/2.5/weather`
- UV Index: `https://api.openweathermap.org/data/2.5/uvi`
- Forecast: `https://api.openweathermap.org/data/2.5/forecast`
- Stocks (TwelveData): `https://api.twelvedata.com/quote`
- Stocks (Finnhub): `https://finnhub.io/api/v1/quote`
- Currency: `https://api.exchangerate-api.com/v4/latest/`
- RSS Proxy: `https://api.rss2json.com/v1/api.json`
- Calendar: Your Apps Script URL

### Refresh Intervals
- Clock: 1 second
- Weather: 30 minutes
- Currencies: 30 minutes
- Calendar: 30 minutes
- News: 30 minutes each feed
- Stocks: 2x per day (12pm & 5pm EST)

### Grid Rows (with Big Screen)
1. Clock, Weather, Bible
2. Schedule, Currencies
3. My Stocks
4. Big Screen (when enabled)
5. ä¸­æ–‡æ–°è
6. International News
7. Traffic & Alerts

### Grid Rows (without Big Screen)
1. Clock, Weather, Bible
2. Schedule, Currencies
3. My Stocks
4. ä¸­æ–‡æ–°è
5. International News
6. Traffic & Alerts

---

## âœ… Testing Checklist

### Before Declaring v5.0.9 Complete

#### Calendar
- [ ] Apps Script updated and deployed
- [ ] URL returns JSON (test in browser)
- [ ] Today's events show (if any)
- [ ] Tomorrow's events show (if any)
- [ ] Next 7 days events show
- [ ] NZ holidays appear in yellow
- [ ] HK holidays appear in yellow

#### Data Feeds
- [ ] Weather shows for all 3 locations
- [ ] UV index displays
- [ ] 24h rain forecast shows
- [ ] Currencies update
- [ ] Stocks load (real data or cache)
- [ ] All 3 news tickers scroll

#### Big Screen
- [ ] YouTube Video works (if enabled)
- [ ] Now News button works (if enabled)
- [ ] Grid adjusts when enabled
- [ ] Grid adjusts when disabled
- [ ] News doesn't overflow

#### Layout
- [ ] All section headings visible
- [ ] No overlapping elements
- [ ] Text readable on all screens
- [ ] Tickers scroll smoothly
- [ ] Clock updates every second

#### Settings
- [ ] All fields save correctly
- [ ] Settings persist on reload
- [ ] API keys not visible in source
- [ ] Changes apply immediately

---

## ğŸ“ Lessons Learned

### What Went Wrong in v5.0.7a
1. **Apps Script error:** Used non-existent `setHeader()` method
2. **Layout confusion:** Big screen settings unclear
3. **Missing headings:** Users couldn't distinguish news sections
4. **Grid issues:** News didn't auto-adjust for big screen

### How v5.0.9 Fixes This
1. **Apps Script:** Removed invalid methods, relies on automatic CORS
2. **Settings:** Independent checkboxes, clear labels
3. **Headings:** Restored with icons for visual clarity
4. **Grid:** Dynamic classes (`.no-bigscreen` / `.has-bigscreen`)

### Best Practices Going Forward
1. **Test API endpoints directly** before integrating
2. **Use browser console** to catch JavaScript errors early
3. **Check localStorage** to verify settings save
4. **Test on file:///** AND GitHub Pages (different behaviors)
5. **Keep versions** in separate files for easy rollback

---

## ğŸ“ Final Notes

### What's Ready Now
âœ… v5.0.9 HTML - Complete and ready to deploy
âœ… Fixed Apps Script - Ready to copy/paste
âœ… Documentation - Complete setup guide
âœ… Project structure - Organized and clear

### What You Need to Do
1. âš ï¸ Update Apps Script (5 minutes)
2. ğŸš€ Deploy v5.0.9 to GitHub Pages
3. âš™ï¸ Configure settings with API keys
4. ğŸ§ª Test calendar, stocks, news
5. ğŸ“± Test on all your devices

### When to Contact Me Again
- âœ… After testing v5.0.9 on all devices
- âœ… If calendar still doesn't work after Apps Script fix
- âœ… When you want to start v6 (drag-and-drop)
- âœ… If you find bugs or unexpected behavior

### Expected Timeline
- **Tonight:** Update Apps Script + Deploy v5.0.9
- **Tomorrow:** Get API keys + Test thoroughly
- **Next week:** Monitor for 7 days, fix any issues
- **Week 3:** If stable, start planning v6

---

Good luck! The main hurdle is getting that Apps Script updated. Once that's done, everything else should fall into place. ğŸš€

Remember: **Don't commit API keys to GitHub!**

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Panel - v5.0.14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            color: #f8fafc; 
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            overflow: hidden;
            margin: 0; padding: 0;
        }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .card { 
            border-radius: 1rem; 
            padding: 1rem; 
            height: 100%; 
            display: flex;
            flex-direction: column;
        }
        
        /* Fixed 6x6 Grid - NO dynamic rows */
        .grid-container {
            display: grid;
            gap: 0.75rem;
            height: 100vh;
            padding: 0.75rem;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
        }
        
        /* Clock */
        .clock-face {
            width: 72px; height: 72px;
            border-radius: 50%;
            background: radial-gradient(circle, #1e293b, #0f172a);
            border: 2px solid rgba(148, 163, 184, 0.3);
            position: relative;
        }
        .clock-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            border-radius: 6px;
        }
        .hour-hand { width: 3px; height: 30px; background: #f1f5f9; margin-left: -1.5px; }
        .minute-hand { width: 2px; height: 40px; background: #cbd5e1; margin-left: -1px; }
        .second-hand { width: 1px; height: 42px; background: #ef4444; margin-left: -0.5px; }
        .clock-center {
            position: absolute;
            width: 6px; height: 6px;
            background: #ef4444;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        /* Tickers - 25% SLOWER (NO HEADINGS) */
        .ticker {
            width: 100%;
            overflow: hidden;
            background: rgba(15, 23, 42, 0.5);
            padding: 1rem 0;
            border-radius: 0.5rem;
            height: 100%;
            display: flex;
            align-items: center;
        }
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
        }
        .news-ticker { animation: scroll-left 150s linear infinite; }
        .intl-ticker { animation: scroll-left 112.5s linear infinite; }
        .stock-ticker { animation: scroll-left 43.75s linear infinite; }
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .ticker-item {
            display: inline-block;
            margin-right: 3rem;
            padding: 0 0.5rem;
            font-size: 0.95rem;
        }
        .ticker-item::before {
            content: 'â—';
            color: #3b82f6;
            margin-right: 0.75rem;
        }
        
        /* Big Screen - Full size iframe */
        .big-screen-media {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .big-screen-media iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Settings */
        .settings-panel {
            position: fixed;
            top: 0; right: -650px;
            width: 650px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }
        .settings-panel.open { right: 0; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 10px; }
        
        .loading {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .upcoming-event {
            background: rgba(234, 179, 8, 0.15);
            border-left: 2px solid #eab308;
            padding: 0.4rem;
            border-radius: 0.4rem;
            margin-bottom: 0.4rem;
            font-size: 0.75rem;
        }
        
        .weather-location {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }
        .weather-location:last-child { border-bottom: none; }
        
        .bible-verse {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border-left: 3px solid #3b82f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .calendar-event {
            background: rgba(59, 130, 246, 0.1);
            border-left: 2px solid #3b82f6;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .currency-box {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
        }
        .currency-box.alert {
            background: rgba(234, 179, 8, 0.2);
            border: 1px solid #eab308;
        }
    </style>
</head>
<body>

    <button onclick="toggleSettings()" class="fixed top-3 right-3 z-50 p-2 glass rounded-full hover:bg-blue-600 transition-all">
        <i class="fas fa-cog text-lg"></i>
    </button>

    <div id="settingsPanel" class="settings-panel custom-scrollbar">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Settings</h2>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-4 text-sm">
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">Stock APIs</h3>
                <div class="space-y-2">
                    <div>
                        <label class="block text-xs mb-1">TwelveData</label>
                        <input type="text" id="twelveDataKey" 
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Finnhub (Backup)</label>
                        <input type="text" id="finnhubKey" 
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">Google Calendar</h3>
                <div class="space-y-2">
                    <div>
                        <label class="block text-xs mb-1">Web App URL</label>
                        <input type="text" id="calendarWebAppUrl" 
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Token</label>
                        <input type="text" id="calendarToken" 
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                </div>
            </div>

            <div>
                <h3 class="font-semibold mb-2 text-blue-400">Big Screen Video</h3>
                <div class="space-y-3">
                    <div class="border border-slate-700 rounded p-3 bg-slate-800/30">
                        <label class="flex items-center mb-2">
                            <input type="checkbox" id="enableBigScreen" class="mr-2">
                            <span class="font-semibold">Enable Big Screen Video</span>
                        </label>
                        <input type="text" id="bigScreenPlaylist" 
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs mt-2"
                            placeholder="YouTube Playlist ID (e.g., PLIpRvnEkgEeU15yy2o_5gKQjr79KP8O2O)">
                        <p class="text-xs text-slate-400 mt-1">For 24h news, use: PLIpRvnEkgEeU15yy2o_5gKQjr79KP8O2O</p>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">YouTube Music (Compact)</h3>
                <input type="text" id="ytMusicPlaylist" 
                    class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs"
                    placeholder="Music Playlist ID (e.g., PLK1NiZBn99vRomXmVs4XR5uhUT5hfjIog)">
                <p class="text-xs text-slate-400 mt-1">Plays in currency section</p>
            </div>
            
            <button onclick="saveSettings()" class="w-full p-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">
                Save & Apply
            </button>
        </div>
    </div>

    <div class="grid-container" id="mainGrid">
        <!-- Row 1-2, Col 1-2: Clock + Holidays -->
        <div class="glass card" style="grid-column: 1 / 3; grid-row: 1 / 3;">
            <div class="flex items-center justify-between gap-2 mb-2">
                <div class="flex-1">
                    <div id="digitalClock" class="text-4xl font-bold">00:00:00</div>
                    <div id="dateStr" class="text-sm text-slate-400 mt-1">Loading...</div>
                </div>
                <div class="clock-face">
                    <div class="clock-hand hour-hand" id="hourHand"></div>
                    <div class="clock-hand minute-hand" id="minuteHand"></div>
                    <div class="clock-hand second-hand" id="secondHand"></div>
                    <div class="clock-center"></div>
                </div>
            </div>
            <div id="upcomingHolidays" class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="text-xs text-slate-400">Loading holidays...</div>
            </div>
        </div>

        <!-- Row 1-4, Col 3-4: Weather -->
        <div class="glass card" style="grid-column: 3 / 5; grid-row: 1 / 5;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-cloud-sun mr-1"></i>Weather</h3>
            <div id="weatherContainer" class="flex-1 overflow-y-auto custom-scrollbar text-xs">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Row 1, Col 5-6: Bible -->
        <div class="glass card" style="grid-column: 5 / 7; grid-row: 1;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-book-bible mr-1"></i>ä»Šæ—¥é‡‘å¥</h3>
            <div id="bibleVerse" class="bible-verse flex-1 overflow-y-auto custom-scrollbar">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Row 2, Col 5-6: Schedule -->
        <div class="glass card" style="grid-column: 5 / 7; grid-row: 2;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-calendar-alt mr-1"></i>Schedule</h3>
            <div id="calendarContainer" class="flex-1 overflow-y-auto custom-scrollbar text-xs">
                <p class="text-slate-400">Loading...</p>
            </div>
        </div>

        <!-- Row 3-4, Col 1-2: Big Screen (when enabled) -->
        <div id="bigScreenSection" class="glass card" style="grid-column: 1 / 3; grid-row: 3 / 5; display: none;">
            <div class="big-screen-media" id="bigScreenPlayer"></div>
        </div>

        <!-- Row 3-4, Col 5-6: Currency + Music -->
        <div class="glass card" style="grid-column: 5 / 7; grid-row: 3 / 5;">
            <div id="currencyList" class="grid grid-cols-2 gap-2 mb-3">
                <div class="loading"></div>
            </div>
            <div class="mt-auto">
                <div class="text-xs text-slate-400 mb-2">æœªæ’­æ”¾</div>
                <div id="musicPlayer" style="height: 60px;"></div>
            </div>
        </div>

        <!-- Row 5: News (NO HEADING, full width) -->
        <div class="glass" style="grid-column: 1 / 7; grid-row: 5; padding: 0;">
            <div class="ticker">
                <div class="ticker-content news-ticker" id="news1Content">
                    <span class="ticker-item">Loading news...</span>
                </div>
            </div>
        </div>

        <!-- Row 6 Col 1-3: International (NO HEADING) -->
        <div class="glass" style="grid-column: 1 / 4; grid-row: 6; padding: 0;">
            <div class="ticker">
                <div class="ticker-content intl-ticker" id="news2Content">
                    <span class="ticker-item">Loading news...</span>
                </div>
            </div>
        </div>

        <!-- Row 6 Col 4-6: Stocks (NO HEADING) -->
        <div class="glass" style="grid-column: 4 / 7; grid-row: 6; padding: 0;">
            <div class="ticker">
                <div class="ticker-content stock-ticker" id="stocksContent">
                    <span class="ticker-item">Loading stocks...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const config = {
            twelveDataKey: 'de0c20b471e5490ea5dfc70d935c6ea1',
            finnhubKey: 'd5m4gt9r01qidp4jtb4gd5m4gt9r01qidp4jtb50',
            calendarWebAppUrl: 'https://script.google.com/macros/s/AKfycbyrwhwFmo_miZdjDnyqpQTYzDeSx1xbwEZFb28_9E3oG1qcqnSnHudfTxDNu8PZ0JCQ7g/exec',
            calendarToken: 'mediapanel',
            enableBigScreen: false,
            bigScreenPlaylist: 'PLIpRvnEkgEeU15yy2o_5gKQjr79KP8O2O', // 24h news playlist
            ytMusicPlaylist: 'PLK1NiZBn99vRomXmVs4XR5uhUT5hfjIog',
            weatherLocations: [
                { label: 'Auckland', lat: -36.8485, lon: 174.7633 },
                { label: 'Botany Downs', lat: -36.9167, lon: 174.9110 },
                { label: 'Hong Kong', lat: 22.3193, lon: 114.1694 }
            ],
            stocks: [
                { symbol: 'AAPL', buyPrice: 613 },
                { symbol: 'AVAV', buyPrice: 240 },
                { symbol: 'DXYZ', buyPrice: 57.38 },
                { symbol: 'GOOG', buyPrice: 337 },
                { symbol: 'ISRG', buyPrice: 479 },
                { symbol: 'RBLX', buyPrice: 117.53 },
                { symbol: 'RNMBY', buyPrice: 408.32 },
                { symbol: 'TEM', buyPrice: 70.55 },
                { symbol: 'TSLA', buyPrice: 390.42 },
                { symbol: 'TSM', buyPrice: 234.81 },
                { symbol: 'PLTR', buyPrice: 126.32 },
                { symbol: 'NVDA', buyPrice: 143.63 }
            ],
            currencies: [
                { pair: 'NZD-USD', alert: 0.55, below: true },
                { pair: 'NZD-HKD', alert: 4.5, below: true }
            ],
            stockRefreshTimes: ['12:00', '17:00'],
            news1Feeds: [
                { name: 'æ˜å ±', url: 'https://news.mingpao.com/rss/ins/s00005.xml' },
                { name: 'RTHK', url: 'https://rthk9.rthk.hk/rthk/news/rss/c_expressnews_clocal.xml' }
            ],
            news2Feeds: [
                { name: 'BBC', url: 'https://feeds.bbci.co.uk/news/rss.xml' },
                { name: 'RNZ', url: 'https://www.rnz.co.nz/rss/chinese.xml' },
                { name: 'NZTA', url: 'https://www.nzta.govt.nz/traffic-and-travel-information/auckland-traffic/rss/' }
            ]
        };

        let stockCache = null;

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
        }

        function loadSavedSettings() {
            const saved = localStorage.getItem('panelConfig');
            if (saved) {
                try {
                    Object.assign(config, JSON.parse(saved));
                } catch (e) {}
            }
            const stockData = localStorage.getItem('stockCache');
            if (stockData) {
                try {
                    stockCache = JSON.parse(stockData);
                } catch (e) {}
            }
        }

        function saveSettings() {
            config.twelveDataKey = document.getElementById('twelveDataKey').value;
            config.finnhubKey = document.getElementById('finnhubKey').value;
            config.calendarWebAppUrl = document.getElementById('calendarWebAppUrl').value;
            config.calendarToken = document.getElementById('calendarToken').value;
            config.enableBigScreen = document.getElementById('enableBigScreen').checked;
            config.bigScreenPlaylist = document.getElementById('bigScreenPlaylist').value;
            config.ytMusicPlaylist = document.getElementById('ytMusicPlaylist').value;
            
            localStorage.setItem('panelConfig', JSON.stringify(config));
            toggleSettings();
            location.reload();
        }

        function populateSettingsUI() {
            document.getElementById('twelveDataKey').value = config.twelveDataKey || '';
            document.getElementById('finnhubKey').value = config.finnhubKey || '';
            document.getElementById('calendarWebAppUrl').value = config.calendarWebAppUrl || '';
            document.getElementById('calendarToken').value = config.calendarToken || '';
            document.getElementById('enableBigScreen').checked = config.enableBigScreen || false;
            document.getElementById('bigScreenPlaylist').value = config.bigScreenPlaylist || '';
            document.getElementById('ytMusicPlaylist').value = config.ytMusicPlaylist || '';
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('digitalClock').innerText = now.toLocaleTimeString('en-GB', { hour12: false });
            document.getElementById('dateStr').innerText = now.toLocaleDateString('zh-HK', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            const s = now.getSeconds(), m = now.getMinutes(), h = now.getHours() % 12;
            document.getElementById('secondHand').style.transform = `rotate(${(s / 60) * 360}deg)`;
            document.getElementById('minuteHand').style.transform = `rotate(${((m + s / 60) / 60) * 360}deg)`;
            document.getElementById('hourHand').style.transform = `rotate(${((h + m / 60) / 12) * 360}deg)`;
        }

        // Weather using Open-Meteo (free, no key needed)
        async function fetchWeather() {
            const parts = [];
            const now = new Date();

            for (const loc of config.weatherLocations) {
                try {
                    const url = 'https://api.open-meteo.com/v1/forecast' +
                        '?latitude=' + loc.lat +
                        '&longitude=' + loc.lon +
                        '&current=temperature_2m,weather_code' +
                        '&hourly=temperature_2m,precipitation,precipitation_probability,uv_index' +
                        '&daily=uv_index_max,precipitation_sum' +
                        '&forecast_days=2&timezone=auto';

                    const resp = await fetch(url);
                    const data = await resp.json();

                    const temp = Math.round(data.current.temperature_2m);
                    const desc = weatherCodeToText(data.current.weather_code);
                    
                    const times = (data.hourly.time || []).map(t => new Date(t));
                    let idx = 0;
                    for (let i = 0; i < times.length; i++) {
                        if (times[i] <= now) idx = i;
                        else break;
                    }
                    
                    const uvNow = data.hourly.uv_index[idx] || 0;
                    const isHK = loc.label.toLowerCase().includes('hong');
                    const displayLabel = isHK ? 'é¦™æ¸¯' : loc.label;
                    
                    let detailHtml = '';
                    if (!isHK) {
                        const uvMax = data.daily.uv_index_max[1] || 0;
                        const rainTmr = data.daily.precipitation_sum[1] || 0;
                        detailHtml = `
                            <div class="text-xs text-slate-300 mt-1">â˜€ï¸ UV: ${uvNow.toFixed(1)} (æ˜æ—¥æœ€é«˜:${uvMax.toFixed(1)})</div>
                            <div class="text-xs text-slate-300">ğŸ’§ æ˜æ—¥é›¨: ${rainTmr.toFixed(1)}mm</div>
                        `;
                    }
                    
                    parts.push(`
                        <div class="weather-location">
                            <div class="flex items-center justify-between">
                                <div class="text-sm font-semibold">${displayLabel} <span class="text-xs text-slate-400 ml-2">${desc}</span></div>
                                <div class="text-2xl font-bold">${temp}Â°C</div>
                            </div>
                            ${detailHtml}
                        </div>
                    `);
                } catch (e) {
                    console.error('Weather error:', loc.label, e);
                }
            }
            
            document.getElementById('weatherContainer').innerHTML = parts.join('') || '<p class="text-red-400">Weather unavailable</p>';
        }

        function weatherCodeToText(code) {
            const codes = {
                0: 'Clear', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                45: 'Foggy', 48: 'Foggy', 51: 'Light drizzle', 53: 'Drizzle', 55: 'Heavy drizzle',
                61: 'Light rain', 63: 'Rain', 65: 'Heavy rain', 71: 'Light snow', 73: 'Snow', 75: 'Heavy snow',
                80: 'Light showers', 81: 'Showers', 82: 'Heavy showers', 95: 'Thunderstorm', 96: 'Thunderstorm with hail'
            };
            return codes[code] || 'Unknown';
        }

        function fetchBibleVerse() {
            const verses = [
                { ref: 'ç´„ç¿°ç¦éŸ³ 3:16', text: 'ç¥æ„›ä¸–äºº,ç”šè‡³å°‡ä»–çš„ç¨ç”Ÿå­è³œçµ¦ä»–å€‘,å«ä¸€åˆ‡ä¿¡ä»–çš„,ä¸è‡³æ»…äº¡,åå¾—æ°¸ç”Ÿã€‚' },
                { ref: 'è©©ç¯‡ 23:1', text: 'è€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…,æˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚' },
                { ref: 'ç®´è¨€ 3:5-6', text: 'ä½ è¦å°ˆå¿ƒä»°è³´è€¶å’Œè¯,ä¸å¯å€šé è‡ªå·±çš„è°æ˜,åœ¨ä½ ä¸€åˆ‡æ‰€è¡Œçš„äº‹ä¸Šéƒ½è¦èªå®šä»–,ä»–å¿…æŒ‡å¼•ä½ çš„è·¯ã€‚' },
                { ref: 'è…“ç«‹æ¯”æ›¸ 4:13', text: 'æˆ‘é è‘—é‚£åŠ çµ¦æˆ‘åŠ›é‡çš„,å‡¡äº‹éƒ½èƒ½åšã€‚' },
                { ref: 'ç¾…é¦¬æ›¸ 8:28', text: 'æˆ‘å€‘æ›‰å¾—è¬äº‹éƒ½äº’ç›¸æ•ˆåŠ›,å«æ„›ç¥çš„äººå¾—ç›Šè™•,å°±æ˜¯æŒ‰ä»–æ—¨æ„è¢«å¬çš„äººã€‚' }
            ];
            
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const verse = verses[dayOfYear % verses.length];
            
            document.getElementById('bibleVerse').innerHTML = `
                <div class="text-slate-300 leading-relaxed">${verse.text}</div>
                <div class="text-xs text-blue-300 font-semibold text-right mt-2">â€” ${verse.ref}</div>
            `;
        }

        // Calendar - SAME AS v5.0.13 (no changes)
        async function fetchCalendar() {
            const container = document.getElementById('calendarContainer');
            
            if (!config.calendarWebAppUrl) {
                container.innerHTML = '<p class="text-yellow-400 text-xs">Calendar not configured</p>';
                return;
            }
            
            try {
                const url = `${config.calendarWebAppUrl}?token=${config.calendarToken}&days=7`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.ok) throw new Error(data.error || 'Calendar error');
                
                let html = '';
                let count = 0;
                
                // Today events
                if (data.today) {
                    const events = [...(data.today.personal || []), ...(data.today.family || [])].filter(e => e && !e.error);
                    events.forEach(e => {
                        const time = e.allDay ? 'All day' : new Date(e.start).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                        html += `
                            <div class="calendar-event">
                                <div class="flex justify-between"><span class="font-semibold text-blue-300">Today</span><span class="text-slate-400 text-xs">${time}</span></div>
                                <div class="text-sm">${escapeHtml(e.title)}</div>
                            </div>
                        `;
                        count++;
                    });
                }
                
                // Tomorrow events
                if (data.tomorrow) {
                    const events = [...(data.tomorrow.personal || []), ...(data.tomorrow.family || [])].filter(e => e && !e.error);
                    events.forEach(e => {
                        const time = e.allDay ? 'All day' : new Date(e.start).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                        html += `
                            <div class="calendar-event">
                                <div class="flex justify-between"><span class="font-semibold text-blue-300">Tomorrow</span><span class="text-slate-400 text-xs">${time}</span></div>
                                <div class="text-sm">${escapeHtml(e.title)}</div>
                            </div>
                        `;
                        count++;
                    });
                }
                
                container.innerHTML = count ? html : '<p class="text-slate-400 text-xs">No events today/tomorrow</p>';
                
            } catch (error) {
                console.error('Calendar error:', error);
                container.innerHTML = `<p class="text-red-400 text-xs">Error: ${escapeHtml(error.message)}</p>`;
            }
        }

        // Upcoming holidays
        async function fetchUpcomingHolidays() {
            const container = document.getElementById('upcomingHolidays');
            
            if (!config.calendarWebAppUrl) {
                container.innerHTML = '<div class="text-xs text-slate-400">Calendar not configured</div>';
                return;
            }
            
            try {
                const url = `${config.calendarWebAppUrl}?token=${config.calendarToken}&days=7`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.ok) throw new Error(data.error);
                
                const holidays = [...(data.next7days.nzHolidays || []), ...(data.next7days.hkHolidays || [])].filter(e => e && !e.error);
                
                if (!holidays.length) {
                    container.innerHTML = '<div class="text-xs text-slate-400">No upcoming holidays</div>';
                    return;
                }
                
                let html = '';
                holidays.forEach(e => {
                    const date = new Date(e.start || e.end);
                    const dateStr = date.toLocaleDateString('zh-HK', { month: 'short', day: 'numeric', weekday: 'short' });
                    html += `
                        <div class="upcoming-event">
                            <div class="font-semibold text-yellow-300">${dateStr}</div>
                            <div>${escapeHtml(e.title)}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Holidays error:', error);
                container.innerHTML = '<div class="text-xs text-red-400">Error loading holidays</div>';
            }
        }

        // Currencies
        async function fetchCurrencies() {
            let html = '';
            
            for (const c of config.currencies) {
                try {
                    const [base, quote] = c.pair.split('-');
                    const res = await fetch(`https://api.exchangerate-api.com/v4/latest/${base}`);
                    const data = await res.json();
                    
                    if (data.rates && data.rates[quote]) {
                        const rate = data.rates[quote];
                        const isAlert = c.below ? rate < c.alert : rate > c.alert;
                        const boxClass = isAlert ? 'currency-box alert' : 'currency-box';
                        
                        html += `
                            <div class="${boxClass}">
                                <div class="text-xs font-semibold mb-1">${base}/${quote}</div>
                                <div class="text-lg font-mono font-bold">${rate.toFixed(4)}</div>
                                ${isAlert ? '<div class="text-yellow-400 text-xs mt-1">âš ï¸</div>' : ''}
                            </div>
                        `;
                    }
                } catch (err) {
                    console.error('Currency error:', c.pair, err);
                }
            }
            
            document.getElementById('currencyList').innerHTML = html || '<p class="text-red-400 text-xs">Currency unavailable</p>';
        }

        // News
        async function fetchNews(feeds, containerId) {
            const container = document.getElementById(containerId);
            let allNews = [];
            
            for (const feed of feeds) {
                try {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}&count=10`);
                    const data = await res.json();
                    
                    if (data.status === 'ok' && data.items) {
                        data.items.slice(0, 5).forEach(item => {
                            if (feed.name === 'NZTA') {
                                const title = item.title.toLowerCase();
                                if (title.includes('auckland') && (title.includes('crash') || title.includes('accident') || title.includes('closure') || title.includes('blocked'))) {
                                    allNews.push(`[${feed.name}] ${item.title}`);
                                }
                            } else {
                                allNews.push(`[${feed.name}] ${item.title}`);
                            }
                        });
                    }
                } catch (err) {
                    console.error('RSS error:', feed.name, err);
                }
            }
            
            if (allNews.length) {
                container.innerHTML = allNews.map(n => `<span class="ticker-item">${escapeHtml(n)}</span>`).join('');
            } else {
                container.innerHTML = '<span class="ticker-item">News unavailable</span>';
            }
        }

        // Stocks
        async function fetchStocks() {
            const el = document.getElementById('stocksContent');
            el.innerHTML = '<span class="ticker-item">Loading stocks...</span>';
            
            try {
                const key = config.twelveDataKey;
                if (!key) throw new Error('No API key');
                
                const symbols = config.stocks.map(s => s.symbol).join(',');
                const url = `https://api.twelvedata.com/quote?symbol=${symbols}&apikey=${key}`;
                const resp = await fetch(url);
                const data = await resp.json();
                
                const html = config.stocks.map(s => {
                    const q = data[s.symbol] || {};
                    const price = parseFloat(q.price) || 0;
                    const pct = parseFloat(q.percent_change) || 0;
                    const below = price && s.buyPrice && price < s.buyPrice;
                    const arrow = pct >= 0 ? ' â–²' : ' â–¼';
                    const arrowColor = pct >= 0 ? 'text-green-400' : 'text-red-400';
                    
                    return `<span class="ticker-item">${s.symbol}: $${price.toFixed(2)} <span class="${arrowColor}">${arrow}</span> ${pct > 0 ? '+' : ''}${pct.toFixed(1)}% | Buy: $${s.buyPrice}${below ? ' âš ï¸' : ''}</span>`;
                }).join('');
                
                el.innerHTML = html;
                
            } catch (e) {
                console.error('Stocks error:', e);
                el.innerHTML = '<span class="ticker-item">Stock data unavailable</span>';
            }
        }

        // Big screen
        function extractPlaylistId(input) {
            if (!input) return null;
            if (/^[A-Za-z0-9_-]+$/.test(input)) return input;
            const match = input.match(/[?&]list=([A-Za-z0-9_-]+)/);
            return match ? match[1] : null;
        }

        function initBigScreen() {
            const section = document.getElementById('bigScreenSection');
            const player = document.getElementById('bigScreenPlayer');
            
            if (config.enableBigScreen) {
                section.style.display = 'block';
                const playlistId = extractPlaylistId(config.bigScreenPlaylist);
                if (playlistId) {
                    // Using YouTube's native embed with autoplay and loop
                    player.innerHTML = `<iframe src="https://www.youtube.com/embed/videoseries?list=${playlistId}&autoplay=1&mute=1&loop=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                }
            } else {
                section.style.display = 'none';
            }
        }

        function initMusicPlayer() {
            const musicPlayer = document.getElementById('musicPlayer');
            const playlistId = extractPlaylistId(config.ytMusicPlaylist);
            
            if (playlistId) {
                // Compact YouTube Music player (audio only style)
                musicPlayer.innerHTML = `<iframe width="100%" height="60" src="https://www.youtube.com/embed/videoseries?list=${playlistId}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            }
        }

        function init() {
            loadSavedSettings();
            populateSettingsUI();
            updateClock();
            fetchBibleVerse();
            fetchWeather();
            fetchCurrencies();
            fetchCalendar();
            fetchUpcomingHolidays();
            fetchNews(config.news1Feeds, 'news1Content');
            fetchNews(config.news2Feeds, 'news2Content');
            fetchStocks();
            initBigScreen();
            initMusicPlayer();
            
            setInterval(updateClock, 1000);
            setInterval(fetchWeather, 1800000);
            setInterval(fetchCurrencies, 1800000);
            setInterval(fetchCalendar, 1800000);
            setInterval(fetchUpcomingHolidays, 1800000);
            setInterval(() => fetchNews(config.news1Feeds, 'news1Content'), 1800000);
            setInterval(() => fetchNews(config.news2Feeds, 'news2Content'), 1800000);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(e => console.log('Wake Lock:', e));
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Panel - v5.0.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            color: #f8fafc; 
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            overflow: hidden;
            margin: 0; padding: 0;
        }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .card { 
            border-radius: 1rem; 
            padding: 1rem; 
            height: 100%; 
            display: flex;
            flex-direction: column;
        }
        
        /* Landscape-optimized Grid */
        .grid-container {
            display: grid;
            gap: 0.75rem;
            height: 100vh;
            padding: 0.75rem;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
        }
        /* Clock */
        .clock-face {
            width: 72px; height: 72px;
            border-radius: 50%;
            background: radial-gradient(circle, #1e293b, #0f172a);
            border: 2px solid rgba(148, 163, 184, 0.3);
            position: relative;
            z-index: 0;
        }
        
        #upcomingReminders { position: relative; z-index: 1; }
.clock-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            border-radius: 6px;
        }
        .hour-hand { width: 3px; height: 30px; background: #f1f5f9; margin-left: -1.5px; }
        .minute-hand { width: 2px; height: 40px; background: #cbd5e1; margin-left: -1px; }
        .second-hand { width: 1px; height: 42px; background: #ef4444; margin-left: -0.5px; }
        .clock-center {
            position: absolute;
            width: 6px; height: 6px;
            background: #ef4444;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        /* Tickers */
        .ticker {
            width: 100%;
            overflow: hidden;
            background: rgba(15, 23, 42, 0.5);
            padding: 0.75rem 0;
            border-radius: 0.5rem;
        }
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
        }
        .news-ticker-content { animation: scroll-left 104s linear infinite; }
        .alerts-ticker-content { animation: scroll-left 50s linear infinite; }
        .stock-ticker-content { animation: scroll-left 35s linear infinite; }
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .ticker-item {
            display: inline-block;
            margin-right: 3rem;
            padding: 0 0.5rem;
            font-size: 1rem;
        }
        .ticker-item::before {
            content: 'â—';
            color: #3b82f6;
            margin-right: 0.75rem;
        }
        
        /* Alerts */
        @keyframes alert-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .stock-alert {
            animation: alert-pulse 1.5s ease-in-out infinite;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        /* Media (YouTube) */
        .yt-frame {
            width: 100%;
            height: 120px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .yt-frame-video { height: 320px; }
        /* music player: keep iframe alive but effectively invisible */
        .yt-frame-music { height: 1px; opacity: 0.02; pointer-events: none; }
        .yt-player { width: 100%; height: 100%; }
        .media-btn {
            padding: 0.35rem 0.55rem;
            border-radius: 0.5rem;
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.25);
            font-size: 0.75rem;
        }
        .media-btn:hover { background: rgba(51, 65, 85, 0.9); }
        
        /* Settings */
        .settings-panel {
            position: fixed;
            top: 0; right: -550px;
            width: 550px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }
        .settings-panel.open { right: 0; }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 10px; }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Bible & Calendar */
        .bible-verse {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border-left: 3px solid #3b82f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .calendar-event {
            background: rgba(59, 130, 246, 0.1);
            border-left: 2px solid #3b82f6;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        .reminder-item {
            background: rgba(234, 179, 8, 0.1);
            border-left: 2px solid #eab308;
            padding: 0.4rem;
            border-radius: 0.5rem;
            margin-top: 0.3rem;
            font-size: 0.75rem;
        }
    
/* hide-news-sources */
#newsSourcesSection{display:none!important;}
</style>
</head>
<body>

    <!-- Settings Button -->
    <button onclick="toggleSettings()" class="fixed top-3 right-3 z-50 p-2 glass rounded-full hover:bg-blue-600 transition-all">
        <i class="fas fa-cog text-lg"></i>
    </button>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel custom-scrollbar">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Settings</h2>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-4 text-sm">
<!-- Calendar (æ–¹æ¡ˆA: Apps Script Web App) -->
            <div>
                <h3 class="font-semibold mb-2 text-green-400">ğŸ“… æ—¥æ›†ï¼ˆæ–¹æ¡ˆAï¼‰</h3>
                <p class="text-xs text-slate-400 mb-2">ç”¨ Google Apps Script Web App è®€å–ä½ å·²å‹¾é¸çš„è¡Œäº‹æ›†ï¼ˆç§å¯†äº¦å¯ï¼‰ã€‚</p>
                <div class="space-y-2 ml-4">
                    <div>
                        <label class="block text-xs mb-1">Calendar Web App URL</label>
                        <input type="text" id="calendarWebAppUrl" placeholder="https://script.google.com/macros/s/.../exec"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Tokenï¼ˆå¯é¸ï¼‰</label>
                        <input type="text" id="calendarToken" placeholder="ç•™ç©ºäº¦å¯"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                    <p class="text-[11px] text-slate-400">æœªå¡« URL æœƒç”¨ç¤ºç¯„è³‡æ–™ã€‚</p>
                </div>
            </div>

<!-- API Keys -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">API Keys</h3>
                <div class="space-y-2">
                    <div>
                        <label class="block text-xs mb-1">Weatherï¼ˆOpen-Meteoï¼Œå… API Keyï¼‰</label>
                        <div class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs text-slate-300">å·²æ”¹ç”¨ Openâ€‘Meteoï¼šé›¨é‡/é™é›¨æ©Ÿç‡/UVï¼ˆ+1/+4/+12/æ˜æ—¥ï¼‰ï¼Œæ¯ 30 åˆ†é˜æ›´æ–°</div>
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Stocks API Provider</label>
                        <select id="stockApiProvider" class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                            <option value="auto">Autoï¼ˆæ¨è–¦ï¼šTwelveDataâ†’Finnhubâ†’å¿«å–ï¼‰</option>
                            <option value="demo">Demo Mode (No API)</option>
                            <option value="twelvedata">Twelve Data (æ¨è–¦ï¼šå¯ä¸€æ¬¡å–å¤šéš»è‚¡ç¥¨)</option>
                            <option value="finnhub">Finnhub (å‚™ç”¨ï¼šé€éš»è‚¡ç¥¨æŸ¥è©¢)</option>
                        </select>
                        <p class="text-[11px] text-slate-400 mt-1">æ¨è–¦ï¼šé¸ Autoã€‚æ­£å¸¸ç”¨ Twelve Dataï¼ˆå¯ä¸€æ¬¡å–å¤šéš»ï¼‰ï¼Œå¤±æ•—è‡ªå‹•åˆ‡ Finnhubï¼›ä»ç¶­æŒæ¯æ—¥ 2 æ¬¡æ›´æ–°ï¼‹å¿«å–ï¼Œé¿å…è¶…å‡ºå…è²»é¡åº¦ã€‚</p>
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Twelve Data API Key</label>
                        <input type="text" id="twelveDataKey" value=""
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Finnhub API Key</label>
                        <input type="text" id="finnhubKey" value=""
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>

                    <div class="mt-3">
                        <label class="block text-xs mb-1">Stocks Refresh Times (Local Time, 2x/day)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="time" id="stockRefresh1" class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs" value="07:00">
                            <input type="time" id="stockRefresh2" class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs" value="11:00">
                        </div>
                        <p class="text-[11px] text-slate-400 mt-1">Panel checks every 5 minutes but only fetches near these times (Â±5 min), maximum 2 updates per day.</p>
                    </div>
                </div>
            </div>
            
            
            <!-- Media -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">åª’é«”</h3>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="ytEnableVideo" class="mr-2">
                        <span class="text-xs">å•Ÿç”¨å¤§å±å½±ç‰‡æ’­æ”¾ï¼ˆåªå–º 1600px+ æ©«å‘é¡¯ç¤ºï¼‰</span>
                    </label>
                    <p class="text-[11px] text-slate-400">é è¨­é—œé–‰ï¼šåªæ’­æ”¾ YouTube éŸ³æ¨‚ä¸¦é¡¯ç¤ºæ­Œåã€‚</p>
                </div>
            </div>

<!-- News Sources -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">æ–°èä¾†æº</h3>
                <p class="text-[11px] text-slate-400">æ–°èä¾†æºå·²å›ºå®šï¼ˆä¸æä¾›é¸æ“‡ï¼‰ï¼šInMediaHKã€RNZï¼ˆä¸­æ–‡/åœ‹å…§ï¼‰ã€BBCã€‚ç¬¬äºŒè¡Œé‡è¦å¿«è¨Šï¼šMetServiceã€Civil Defenceã€Awaikatoã€NZTAï¼ˆAucklandï¼‰ã€‚</p>
            </div>

            <!-- Calendar Toggles -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">Calendar Display</h3>
                <div class="space-y-1">
                    <label class="flex items-center">
                        <input type="checkbox" id="calPersonal" checked class="mr-2">
                        <span>Personal Events</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calBirthday" checked class="mr-2">
                        <span>Birthdays (1 week reminder)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calFamily" checked class="mr-2">
                        <span>Family Events</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calGame" checked class="mr-2">
                        <span>Game Events (1 week reminder)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calNZ" checked class="mr-2">
                        <span>NZ Holidays (1 week reminder)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calHK" checked class="mr-2">
                        <span>HK Holidays (1 week reminder)</span>
                    </label>
                </div>
            </div>
            
            <button onclick="saveSettings()" class="w-full p-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">
                Save & Apply
            </button>
        </div>
    </div>

    <div class="grid-container" id="mainGrid">
        <!-- Clock, Date & Reminders -->
        <div class="glass card" style="grid-column: 1 / span 2; grid-row: 1 / span 2;">
            <div class="mb-2">
                <div class="flex items-center gap-3">
                    <div id="digitalClock" class="text-4xl font-bold">00:00:00</div>
                    <div class="clock-face clock-face-inline">
                        <div class="clock-hand hour-hand" id="hourHand"></div>
                        <div class="clock-hand minute-hand" id="minuteHand"></div>
                        <div class="clock-hand second-hand" id="secondHand"></div>
                        <div class="clock-center"></div>
                    </div>
                </div>
                <div id="dateStr" class="text-sm text-slate-400 mt-1">Loading...</div>
            </div>
            <div id="upcomingReminders" class="flex-1 overflow-y-auto custom-scrollbar text-xs">
                <div class="text-slate-400 text-center mt-4">Loading reminders...</div>
            </div>
        </div>

        <!-- Weather -->
        <div class="glass card" style="grid-column: 3 / span 2; grid-row: 1 / span 4;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-cloud-sun mr-1"></i>Weather</h3>
            <div id="weatherContainer" class="flex-1 overflow-y-auto custom-scrollbar text-xs">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Bible Verse -->
        <div class="glass card" style="grid-column: 5 / span 2; grid-row: 1 / span 2;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-book-bible mr-1"></i>ä»Šæ—¥é‡‘å¥</h3>
            <div id="bibleVerse" class="bible-verse flex-1 overflow-y-auto custom-scrollbar">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="glass card" style="grid-column: 1 / span 2; grid-row: 3 / span 2;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-calendar-alt mr-1"></i>Schedule</h3>
            <div id="calendarContainer" class="flex-1 overflow-y-auto custom-scrollbar text-xs space-y-1">
                <p class="text-slate-400">Loading...</p>
            </div>
        </div>

        <!-- Currencies + Music (Combined) -->
        <div class="glass card" style="grid-column: 5 / span 2; grid-row: 3 / span 2;">
            <div class="flex items-center justify-between mb-2">
                
            </div>

            <!-- Currencies -->
            <div class="mb-3">
                <div id="currencyList" class="grid grid-cols-2 gap-2 text-xs">
                    <div class="loading"></div>
                </div>
            </div>

            <!-- YouTube Music (audio controls, minimal UI) -->
            <div class="mt-auto">
                
                <div class="yt-frame yt-frame-music" style="height:1px; opacity:0; pointer-events:none;">
                    <div id="ytMusicPlayer" class="yt-player"></div>
                </div>
                <div id="musicNowPlaying" class="text-xs text-slate-200 truncate">æœªæ’­æ”¾</div>
                <div class="mt-2 flex flex-wrap gap-1">
                    <button class="media-btn" id="musicPrev" title="ä¸Šä¸€é¦–">â®</button>
                    <button class="media-btn" id="musicPlay" title="æ’­æ”¾/æš«åœ">â¯</button>
<button class="media-btn" id="musicNext" title="ä¸‹ä¸€é¦–">â­</button>
                    <button class="media-btn" id="musicReshuffle" title="é‡æ’+é‡æ’­/æ›´æ–°">ğŸ”€</button>
                </div>
            </div>
        </div>


        <!-- Video Player (å¤§å±ï¼›å¯æ–¼è¨­å®šé–‹é—œ) -->
        <div id="videoCard" class="glass card hidden" style="grid-column: 3 / span 4; grid-row: 1 / span 4;">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold"><i class="fas fa-film mr-1"></i>å½±ç‰‡æ’­æ”¾ï¼ˆå¤§å±ï¼‰</h3>
                <button id="videoHideBtn" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-[11px] hover:bg-slate-700">éš±è—</button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar text-xs space-y-2">
                <div class="yt-frame yt-frame-video">
                    <div id="ytVideoPlayer" class="yt-player"></div>
                </div>
                <div id="videoNowPlaying" class="text-xs text-slate-200 truncate">æœªæ’­æ”¾</div>
                <div class="mt-1 flex flex-wrap gap-1">
                    <button class="media-btn" id="videoPrev">Prev</button>
                    <button class="media-btn" id="videoPlay">Play / Pause</button>
<button class="media-btn" id="videoNext">Next</button>
                    <button class="media-btn" id="videoReshuffle">Reshuffle / æ›´æ–°</button>
                </div>
            </div>
        </div>
<!-- News Ticker (two lines) -->
        <div class="glass card" style="grid-column: 1 / span 6; grid-row: 5;">
<div class="ticker mb-2">
                <div class="ticker-content news-ticker-content" id="newsContent">
                    <span class="ticker-item">Loading...</span>
                </div>
            </div>
<div class="ticker">
                <div class="ticker-content alerts-ticker-content" id="alertsContent">
                    <span class="ticker-item">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Stocks Ticker -->
        <div class="glass card" style="grid-column: 1 / span 6; grid-row: 6;">
<div class="ticker">
                <div class="ticker-content stock-ticker-content" id="stocksContent">
                    <span class="ticker-item">Loading stocks...</span>
                </div>
            </div>
        </div>
    </div>

    <script>

        // Safe storage: file:// æˆ–æŸäº›ç€è¦½å™¨è¨­å®šä¸‹ï¼ŒlocalStorage å¯èƒ½æ‹‹ SecurityError
        const SafeStore = {
            get(key){ try { return localStorage.getItem(key); } catch(e){ return null; } },
            set(key, val){ try { localStorage.setItem(key, val); } catch(e){} }
        };

        
        function getEl(id){ return document.getElementById(id) || null; }
        function setStatus(id, value){ const el=getEl(id); if(el) el.innerHTML=value; }
// Configuration
        const config = {
            // APIs
            weatherApiKey: '',
            // WARNING: Do NOT commit real API keys to public GitHub.
            // Put keys in Settings in production, or keep this file private.
            twelveDataKey: '',
            finnhubKey: '',
            stockApiProvider: 'auto',

            // YouTube
            ytMusicPlaylistId: 'PLK1NiZBn99vRvPpps7r9wMB0KLUacyRKT',
            ytVideoPlaylistId: 'PLK1NiZBn99vQ79xMYiOyZwdH6-u1WqqxC',
            ytVolume: 80,
            ytShowVideo: false,
            ytEnableVideo: false,
            // Calendar WebApp (æ–¹æ¡ˆ A)
            calendarWebAppUrl: '',
            calendarWebAppToken: '',
            calendarIds: {
                primary: 'ivantheservant@gmail.com',
                personal2: '2ldu0nsu2v4h2jctpil9ph9gso@group.calendar.google.com',
                family1: 'family07947208283780325176@group.calendar.google.com',
                family2: 'family08138198902160461554@group.calendar.google.com',
                luciaivan: 'luciaivan@gmail.com',
                game: 'a0no5gmq2ko8q2koqm2qptcflc@group.calendar.google.com',
                nzHolidays: 'en.new_zealand#holiday@group.v.calendar.google.com',
                hkHolidays: 'en.hong_kong#holiday@group.v.calendar.google.com'
            },
// Stocks refresh (local time, 2x/day)
            stockRefreshTimes: ['07:00', '11:00'],
            
            // Google Calendar (NEW)
            useGoogleCalendar: false,
            gcalApiKey: '',
            nzCalendarId: 'en.new_zealand#holiday@group.v.calendar.google.com',
            hkCalendarId: 'en.hong_kong#holiday@group.v.calendar.google.com',
            personalCalendarId: '',
            
            // Photo Memories (NEW)
            enablePhotos: false,
            photoSource: 'demo', // 'demo', 'gdrive', 'onedrive'
            gdriveFolderId: '',
            onedrivePath: '',
            photoInterval: 300000, // 5 minutes
            
            // Existing config
            weatherLocations: [
                { label: 'Auckland', lat: -36.8485, lon: 174.7633 },
                { label: 'Botany Downs', lat: -36.9167, lon: 174.9110 },
                { label: 'Hong Kong', lat: 22.3193, lon: 114.1694 }
            ],
            stocks: [
                { symbol: 'AAPL', buyPrice: 613 },
                { symbol: 'AVAV', buyPrice: 240 },
                { symbol: 'DXYZ', buyPrice: 57.38 },
                { symbol: 'GOOG', buyPrice: 337 },
                { symbol: 'ISRG', buyPrice: 479 },
                { symbol: 'RBLX', buyPrice: 117.53 },
                { symbol: 'RNMBY', buyPrice: 408.32 },
                { symbol: 'TEM', buyPrice: 70.55 },
                { symbol: 'TSLA', buyPrice: 390.42 },
                { symbol: 'TSM', buyPrice: 234.81 },
                { symbol: 'PLTR', buyPrice: 126.32 },
                { symbol: 'NVDA', buyPrice: 143.63 }
            ],
            currencies: [
                { pair: 'NZD-USD', alert: 0.55, below: true },
                { pair: 'NZD-HKD', alert: 4.5, below: true }
            ],
            calendar: {
                personal: true,
                birthday: true,
                family: true,
                game: true,
                nz: true,
                hk: true
            },
            newsFeeds: { fixed: true }
        };

        // Fixed News Sources (v5.0.7)
        const FIXED_NEWS_LINE1 = [
            { key: 'inmediahk', name: 'InMediaHK', url: 'https://www.inmediahk.net/rss.xml' },
            { key: 'rnzchinese', name: 'RNZ Chinese', url: 'https://www.rnz.co.nz/rss/chinese.xml' },
            { key: 'rnzcountry', name: 'RNZ Country', url: 'https://www.rnz.co.nz/rss/country.xml' },
            { key: 'bbc', name: 'BBC', url: 'https://feeds.bbci.co.uk/news/world/rss.xml' }
        ];

        const FIXED_NEWS_LINE2 = [
            { key: 'metservice_rss', name: 'MetService CAP RSS', url: 'https://alerts.metservice.com/cap/rss', type: 'rss' },
            { key: 'metservice_atom', name: 'MetService CAP Atom', url: 'https://alerts.metservice.com/cap/atom', type: 'atom' },
            { key: 'civildefence', name: 'Civil Defence', url: 'https://www.civildefence.govt.nz/home/rss', type: 'rss' },
            { key: 'awaikato', name: 'Awaikato', url: 'https://media.rss.com/awaikatothing/feed.xml', type: 'rss' }
        ];
;

	        // Timers / state
	        let photoTimer = null;
        let currentPhotoIndex = 0;
        let todayPhotos = [];


        // Hardcoded holidays (fallback when Google Calendar not used)
        const holidays2026 = {
            nz: [
                { date: '2026-01-26', name: 'Auckland Anniversary' },
                { date: '2026-02-06', name: 'Waitangi Day' },
                { date: '2026-04-10', name: 'Good Friday' },
                { date: '2026-04-13', name: 'Easter Monday' },
                { date: '2026-04-27', name: 'ANZAC Day (obs)' },
                { date: '2026-06-01', name: 'Queen\'s Birthday' },
                { date: '2026-10-26', name: 'Labour Day' },
                { date: '2026-12-25', name: 'Christmas' },
                { date: '2026-12-26', name: 'Boxing Day' }
            ],
            hk: [
                { date: '2026-01-29', name: 'è¾²æ›†æ–°å¹´' },
                { date: '2026-01-30', name: 'è¾²æ›†æ–°å¹´' },
                { date: '2026-01-31', name: 'è¾²æ›†æ–°å¹´' },
                { date: '2026-04-03', name: 'æ¸…æ˜ç¯€' },
                { date: '2026-04-10', name: 'Good Friday' },
                { date: '2026-04-13', name: 'Easter Monday' },
                { date: '2026-05-01', name: 'å‹å‹•ç¯€' },
                { date: '2026-05-25', name: 'ä½›èª•' },
                { date: '2026-06-25', name: 'ç«¯åˆç¯€' },
                { date: '2026-07-01', name: 'é¦™æ¸¯ç‰¹å€æˆç«‹ç´€å¿µæ—¥' },
                { date: '2026-10-01', name: 'åœ‹æ…¶æ—¥' },
                { date: '2026-10-02', name: 'ä¸­ç§‹ç¯€ç¿Œæ—¥' },
                { date: '2026-10-26', name: 'é‡é™½ç¯€' },
                { date: '2026-12-25', name: 'Christmas' },
                { date: '2026-12-26', name: 'Boxing Day' }
            ]
        };

        // Demo photos (base64 encoded 1x1 colored squares for demo)
        const demoPhotos = [
            { 
                url: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><rect fill="%233b82f6" width="400" height="400"/><text x="50%" y="50%" text-anchor="middle" fill="white" font-size="24">2023 Photo</text></svg>',
                filename: 'family_gathering_2023.jpg',
                year: 2023
            },
            {
                url: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><rect fill="%2310b981" width="400" height="400"/><text x="50%" y="50%" text-anchor="middle" fill="white" font-size="24">2022 Photo</text></svg>',
                filename: 'birthday_celebration_2022.jpg',
                year: 2022
            },
            {
                url: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><rect fill="%23f59e0b" width="400" height="400"/><text x="50%" y="50%" text-anchor="middle" fill="white" font-size="24">2021 Photo</text></svg>',
                filename: 'vacation_trip_2021.jpg',
                year: 2021
            }
        ];

        function getCorsProxy(url) {
            // Launch build: always use a CORS-friendly proxy for RSS fetching (no browser extension required).
            return `https://corsproxy.io/?${encodeURIComponent(url)}`;
        }

        function loadSavedSettings() {
// News feeds migration (older versions)
            if (!config.newsFeeds) config.newsFeeds = {};
            // Old keys -> keep as commented fallback only
            if ('ltn' in config.newsFeeds || 'scmp' in config.newsFeeds || 'bbc' in config.newsFeeds || 'demo' in config.newsFeeds) {
                // do nothing; UI no longer exposes these
            }
            // New defaults
            if (!('inmediahk' in config.newsFeeds) && !('rnzchinese' in config.newsFeeds) && !('rnzcountry' in config.newsFeeds) && !('cnaworld' in config.newsFeeds)) {
                config.newsFeeds.inmediahk = true;
                config.newsFeeds.rnzchinese = true;
                config.newsFeeds.rnzcountry = true;
                            }

            const saved = SafeStore.get('panelConfig');
            if (saved) {
                const savedConfig = JSON.parse(saved);
                Object.assign(config, savedConfig);
            // If user previously saved demo provider but keys exist, default to auto
            try {
                const p = (config.stockApiProvider || '').toLowerCase();
                const hasKeys = !!(config.twelveDataKey && String(config.twelveDataKey).trim()) || !!(config.finnhubKey && String(config.finnhubKey).trim());
                if (hasKeys && (p === 'demo' || p === 'demomode' || p === 'demo mode (no api)')) {
                    config.stockApiProvider = 'auto';
                }
            } catch {}

            }
            // Migration: older versions stored weatherLocations as strings
            if (Array.isArray(config.weatherLocations) && config.weatherLocations.length && typeof config.weatherLocations[0] === 'string') {
                config.weatherLocations = [
                    { label: 'Auckland', lat: -36.8485, lon: 174.7633 },
                    { label: 'Botany Downs', lat: -36.9167, lon: 174.9110 },
                    { label: 'Hong Kong', lat: 22.3193, lon: 114.1694 }
                ];
            }

            // Ensure at least one news feed is enabled
            if (config.newsFeeds && !config.newsFeeds.demo && !config.newsFeeds.ltn && !config.newsFeeds.scmp && !config.newsFeeds.bbc) {
                config.newsFeeds.demo = true;
            }

            updatePhotoLayout();
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                populateSettingsUI();
            }
        }

        function populateSettingsUI() {
            // APIs (å…¬é–‹ Launch ç‰ˆï¼šWeather ç”¨ Openâ€‘Meteoï¼Œå””éœ€è¦ key)
            const td = document.getElementById('twelveDataKey'); if (td) td.value = config.twelveDataKey || '';
            const fh = document.getElementById('finnhubKey'); if (fh) fh.value = config.finnhubKey || '';
            const prov = document.getElementById('stockApiProvider'); if (prov) prov.value = config.stockApiProvider || 'auto';
            // Media
            const ev = document.getElementById('ytEnableVideo'); if (ev) ev.checked = !!config.ytEnableVideo;


            // Stock schedule
            const r1 = document.getElementById('stockRefresh1'); if (r1) r1.value = (config.stockRefreshTimes && config.stockRefreshTimes[0]) ? config.stockRefreshTimes[0] : '07:00';
            const r2 = document.getElementById('stockRefresh2'); if (r2) r2.value = (config.stockRefreshTimes && config.stockRefreshTimes[1]) ? config.stockRefreshTimes[1] : '11:00';

            // Calendar (æ–¹æ¡ˆA)
            // News feeds (v5)
            const n1 = document.getElementById('newsInmediaHK'); if (n1) n1.checked = !!config.newsFeeds.inmediahk;
            const n2 = document.getElementById('newsRNZChinese'); if (n2) n2.checked = !!config.newsFeeds.rnzchinese;
            const n3 = document.getElementById('newsRNZCountry'); if (n3) n3.checked = !!config.newsFeeds.rnzcountry;

            const url = document.getElementById('calendarWebAppUrl'); if (url) url.value = config.calendarWebAppUrl || '';
            const tok = document.getElementById('calendarToken'); if (tok) tok.value = config.calendarToken || '';

            // Calendar toggles
            const cp = document.getElementById('calPersonal'); if (cp) cp.checked = !!config.calendar.personal;
            const cb = document.getElementById('calBirthday'); if (cb) cb.checked = !!config.calendar.birthday;
            const cf = document.getElementById('calFamily'); if (cf) cf.checked = !!config.calendar.family;
            const cg = document.getElementById('calGame'); if (cg) cg.checked = !!config.calendar.game;
            const cn = document.getElementById('calNZ'); if (cn) cn.checked = !!config.calendar.nz;
            const ch = document.getElementById('calHK'); if (ch) ch.checked = !!config.calendar.hk;

            // News
        }

        function saveSettings() {
            // APIs
            const td = document.getElementById('twelveDataKey'); if (td) config.twelveDataKey = td.value;
            const fh = document.getElementById('finnhubKey'); if (fh) config.finnhubKey = fh.value;
            const prov = document.getElementById('stockApiProvider'); if (prov) config.stockApiProvider = prov.value;
            // Media
            const ev = document.getElementById('ytEnableVideo'); if (ev) config.ytEnableVideo = ev.checked;


            // Stock schedule
            const r1 = document.getElementById('stockRefresh1');
            const r2 = document.getElementById('stockRefresh2');
            config.stockRefreshTimes = [
                (r1 && r1.value) ? r1.value : '07:00',
                (r2 && r2.value) ? r2.value : '11:00'
            ];

            // Calendar (æ–¹æ¡ˆA)
            const url = document.getElementById('calendarWebAppUrl');
            const tok = document.getElementById('calendarToken');
            config.calendarWebAppUrl = (url && url.value) ? url.value.trim() : '';
            config.calendarToken = (tok && tok.value) ? tok.value.trim() : '';

            

            // News feeds (v5)
            config.newsFeeds = config.newsFeeds || {};
            const n1 = document.getElementById('newsInmediaHK'); if (n1) config.newsFeeds.inmediahk = !!n1.checked;
            const n2 = document.getElementById('newsRNZChinese'); if (n2) config.newsFeeds.rnzchinese = !!n2.checked;
            const n3 = document.getElementById('newsRNZCountry'); if (n3) config.newsFeeds.rnzcountry = !!n3.checked;
// Calendar toggles
            const cp = document.getElementById('calPersonal'); if (cp) config.calendar.personal = cp.checked;
            const cb = document.getElementById('calBirthday'); if (cb) config.calendar.birthday = cb.checked;
            const cf = document.getElementById('calFamily'); if (cf) config.calendar.family = cf.checked;
            const cg = document.getElementById('calGame'); if (cg) config.calendar.game = cg.checked;
            const cn = document.getElementById('calNZ'); if (cn) config.calendar.nz = cn.checked;
            const ch = document.getElementById('calHK'); if (ch) config.calendar.hk = ch.checked;

            // News

            SafeStore.set('panelConfig', JSON.stringify(config));
            toggleSettings();
            fetchAllData();
            maybeRefreshStocks(true);
        }

        function updatePhotoLayout() {
            // Launch ç‰ˆï¼šå·²ç§»é™¤ç›¸ç‰‡å€ï¼ˆä¹‹å¾Œå†åŠ ï¼‰
            return;
        }

        function updatePhotoLayout() {
            const grid = document.getElementById('mainGrid');
            if (config.enablePhotos && window.innerWidth >= 1600) {
                grid.classList.add('with-photos');
            } else {
                grid.classList.remove('with-photos');
            }
        }

        function updateDigitalClock() {
            const now = new Date();
            document.getElementById('digitalClock').innerText = now.toLocaleTimeString('en-GB', { hour12: false });
            document.getElementById('dateStr').innerText = now.toLocaleDateString('zh-HK', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
        }

        function updateAnalogClock() {
            const now = new Date();
            const s = now.getSeconds(), m = now.getMinutes(), h = now.getHours() % 12;
            document.getElementById('secondHand').style.transform = `rotate(${(s / 60) * 360}deg)`;
            document.getElementById('minuteHand').style.transform = `rotate(${((m + s / 60) / 60) * 360}deg)`;
            document.getElementById('hourHand').style.transform = `rotate(${((h + m / 60) / 12) * 360}deg)`;
        }

        // Fetch holidays from Google Calendar
        async function fetchGoogleCalendarHolidays() {
            if (!config.useGoogleCalendar || !config.gcalApiKey) {
                return null;
            }

            try {
                const now = new Date();
                const oneWeekLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                const timeMin = now.toISOString();
                const timeMax = oneWeekLater.toISOString();

                let allEvents = [];

                // Fetch NZ holidays
                if (config.calendar.nz && config.nzCalendarId) {
                    const nzUrl = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(config.nzCalendarId)}/events?key=${config.gcalApiKey}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                    const nzRes = await fetch(getCorsProxy(nzUrl));
                    const nzData = await nzRes.json();
                    if (nzData.items) {
                        nzData.items.forEach(item => {
                            allEvents.push({
                                date: item.start.date || item.start.dateTime.split('T')[0],
                                name: `ğŸ‡³ğŸ‡¿ ${item.summary}`,
                                type: 'holiday'
                            });
                        });
                    }
                }

                // Fetch HK holidays
                if (config.calendar.hk && config.hkCalendarId) {
                    const hkUrl = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(config.hkCalendarId)}/events?key=${config.gcalApiKey}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                    const hkRes = await fetch(getCorsProxy(hkUrl));
                    const hkData = await hkRes.json();
                    if (hkData.items) {
                        hkData.items.forEach(item => {
                            allEvents.push({
                                date: item.start.date || item.start.dateTime.split('T')[0],
                                name: `ğŸ‡­ğŸ‡° ${item.summary}`,
                                type: 'holiday'
                            });
                        });
                    }
                }

                // Fetch personal calendar (birthdays, events)
                if (config.personalCalendarId) {
                    const perUrl = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(config.personalCalendarId)}/events?key=${config.gcalApiKey}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                    const perRes = await fetch(getCorsProxy(perUrl));
                    const perData = await perRes.json();
                    if (perData.items) {
                        perData.items.forEach(item => {
                            let icon = 'ğŸ“…';
                            if (item.summary.toLowerCase().includes('birthday')) icon = 'ğŸ‚';
                            if (item.summary.toLowerCase().includes('game')) icon = 'ğŸ®';
                            
                            allEvents.push({
                                date: item.start.date || item.start.dateTime.split('T')[0],
                                name: `${icon} ${item.summary}`,
                                type: 'personal'
                            });
                        });
                    }
                }

                return allEvents;
            } catch (error) {
                console.error('Google Calendar error:', error);
                return null;
            }
        }

        async function updateReminders() {
            const now = new Date();
            const oneWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            let reminders = [];

            // Try Google Calendar first
            if (config.useGoogleCalendar) {
                const gcalEvents = await fetchGoogleCalendarHolidays();
                if (gcalEvents) {
                    gcalEvents.forEach(event => {
                        const eventDate = new Date(event.date);
                        if (eventDate >= now && eventDate <= oneWeek) {
                            const daysUntil = Math.ceil((eventDate - now) / (24 * 60 * 60 * 1000));
                            reminders.push({ text: event.name, days: daysUntil, date: event.date });
                        }
                    });
                }
            }

            // Fallback to hardcoded holidays if Google Calendar not used or failed
            if (reminders.length === 0 || !config.useGoogleCalendar) {
                if (config.calendar.nz) {
                    holidays2026.nz.forEach(h => {
                        const eventDate = new Date(h.date);
                        if (eventDate >= now && eventDate <= oneWeek) {
                            const daysUntil = Math.ceil((eventDate - now) / (24 * 60 * 60 * 1000));
                            reminders.push({ text: `ğŸ‡³ğŸ‡¿ ${h.name}`, days: daysUntil, date: h.date });
                        }
                    });
                }

                if (config.calendar.hk) {
                    holidays2026.hk.forEach(h => {
                        const eventDate = new Date(h.date);
                        if (eventDate >= now && eventDate <= oneWeek) {
                            const daysUntil = Math.ceil((eventDate - now) / (24 * 60 * 60 * 1000));
                            reminders.push({ text: `ğŸ‡­ğŸ‡° ${h.name}`, days: daysUntil, date: h.date });
                        }
                    });
                }
            }

            reminders.sort((a, b) => new Date(a.date) - new Date(b.date));

            let html = '';
            if (reminders.length === 0) {
                html = '<div class="text-slate-400 text-center mt-4">æœªä¾† 7 æ—¥ç„¡äº‹ä»¶</div>';
            } else {
                reminders.forEach(r => {
                    const dayText = r.days === 0 ? 'Today' : r.days === 1 ? 'Tomorrow' : `In ${r.days} days`;
                    html += `<div class="reminder-item">
                        <div class="flex justify-between">
                            <span>${r.text}</span>
                            <span class="text-yellow-400">${dayText}</span>
                        </div>
                    </div>`;
                });
            }

            document.getElementById('upcomingReminders').innerHTML = html;
        }

        async function fetchCurrencies() {
            const box = document.getElementById('currencyList');
            try {
                let html = '';
                let success = 0;
                for (const c of (config.currencies || [])) {
                    const [base, quote] = c.pair.split('-');
                    const url = `https://open.er-api.com/v6/latest/${base}`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    const rate = data?.rates?.[quote];
                    if (Number.isFinite(rate)) {
                        const isAlert = c.below ? rate < c.alert : rate > c.alert;
                        html += `
                            <div class="${isAlert ? 'stock-alert' : 'bg-slate-800/30'} rounded p-2">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">${base}/${quote}</span>
                                    <div class="text-right">
                                        <div class="font-mono font-bold">${rate.toFixed(4)}</div>
                                        ${isAlert ? '<i class="fas fa-bell text-yellow-400 text-xs"></i>' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        success++;
                    }
                }
                box.innerHTML = success ? html : '<p class="text-yellow-400">âš ï¸ åŒ¯ç‡æš«æ™‚ä¸å¯ç”¨</p>';
            } catch (e) {
                console.warn('Currencies failed', e);
                box.innerHTML = '<p class="text-yellow-400">âš ï¸ åŒ¯ç‡æš«æ™‚ä¸å¯ç”¨</p>';
            }
        }

        async function fetchRss(url, limit = 12) {
            // NOTE: RSS/Atom fetching uses a proxy by default (GitHub/file:// friendly)
            const res = await fetch(getCorsProxy(url));
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const text = await res.text();
            const doc = new DOMParser().parseFromString(text, 'text/xml');

            // RSS <item>
            const rssItems = Array.from(doc.querySelectorAll('item'));
            if (rssItems.length) {
                return rssItems.slice(0, limit).map(it => {
                    const title = (it.querySelector('title')?.textContent || '').trim();
                    const link = (it.querySelector('link')?.textContent || '').trim();
                    const pubDate = (it.querySelector('pubDate')?.textContent || '').trim();
                    return { title, link, pubDate: pubDate ? new Date(pubDate) : null };
                }).filter(x => x.title);
            }

            // Atom <entry>
            const atomEntries = Array.from(doc.querySelectorAll('entry'));
            return atomEntries.slice(0, limit).map(en => {
                const title = (en.querySelector('title')?.textContent || '').trim();
                let link = '';
                const linkEl = en.querySelector('link');
                if (linkEl) link = (linkEl.getAttribute('href') || linkEl.textContent || '').trim();
                const updated = (en.querySelector('updated')?.textContent || en.querySelector('published')?.textContent || '').trim();
                return { title, link, pubDate: updated ? new Date(updated) : null };
            }).filter(x => x.title);
        }

        function _findByLocalName(node, localName) {
            try {
                const all = node.getElementsByTagName('*');
                for (let i = 0; i < all.length; i++) {
                    const el = all[i];
                    if ((el.localName || '').toLowerCase() === localName.toLowerCase()) {
                        const t = (el.textContent || '').trim();
                        if (t) return t;
                    }
                }
            } catch {}
            return '';
        }

        async function fetchMetServiceCap(limit = 8) {
            const urls = [
                'https://alerts.metservice.com/cap/rss',
                'https://alerts.metservice.com/cap/atom'
            ];
            let lastErr = null;
            for (const url of urls) {
                try {
                    const res = await fetch(getCorsProxy(url), { cache: 'no-store' });
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const xml = await res.text();
                    const doc = new DOMParser().parseFromString(xml, 'text/xml');
                    const items = Array.from(doc.querySelectorAll('item'));
                    const entries = items.length ? items : Array.from(doc.querySelectorAll('entry'));
                    const out = [];
                    for (const it of entries.slice(0, limit)) {
                        const title = (it.querySelector('title')?.textContent || '').trim();
                        if (!title) continue;
                        // CAP details
                        let area = _findByLocalName(it, 'areaDesc');
                        let sev = _findByLocalName(it, 'severity');
                        // Fallback: try description text
                        if (!area) {
                            const desc = (it.querySelector('description')?.textContent || it.querySelector('summary')?.textContent || '').trim();
                            const m =
                            desc.match(/Area(?:\(s\))?:\s*([^\r\n<]+)/i) ||
                            desc.match(/Areas?:\s*([^\r\n<]+)/i) ||
                            desc.match(/Location:\s*([^\r\n<]+)/i);
                            if (m) area = (m[1] || '').trim();
                        }
                        let text = title;
                        if (area) text += ' â€” ' + area;
                        if (sev) text += 'ï¼ˆ' + sev + 'ï¼‰';
                        out.push(text);
                    }
                    // de-dup
                    const seen = new Set();
                    const uniq = [];
                    for (const t of out) {
                        const k = t.toLowerCase();
                        if (seen.has(k)) continue;
                        seen.add(k);
                        uniq.push(t);
                    }
                    if (uniq.length) return uniq.slice(0, limit);
                } catch (e) {
                    lastErr = e;
                }
            }
            if (lastErr) throw lastErr;
            return [];
        }


        async function fetchNews() {
            // v5 feeds (replace old LTN/SCMP/BBC; keep them in comments as fallback)
            // Old (fallback only):
            // - LTN: https://news.ltn.com.tw/rss/all.xml
            // - SCMP: https://www.scmp.com/rss/2/feed
            // - BBC:  https://feeds.bbci.co.uk/news/rss.xml (å•Ÿç”¨)

            const feeds = [
                { name: 'InMediaHK', url: 'https://www.inmediahk.net/rss.xml' },
                { name: 'RNZä¸­æ–‡', url: 'https://www.rnz.co.nz/rss/chinese.xml' },
                { name: 'RNZåœ‹å…§', url: 'https://www.rnz.co.nz/rss/country.xml' },
                { name: 'BBC', url: 'https://feeds.bbci.co.uk/news/rss.xml' }
            ];

            try {
                const all = [];
                for (const f of feeds) {
                    try {
                        const items = await fetchRss(f.url, 10);
                        items.forEach(it => all.push({ ...it, source: f.name }));
                    } catch (e) {
                        console.warn(`News feed failed: ${f.name}`, e);
                    }
                }

                if (!all.length) throw new Error('No news items');

                all.sort((a, b) => (b.pubDate?.getTime() || 0) - (a.pubDate?.getTime() || 0));
                const top = all.slice(0, 20);

                const ticker = top.map(it => {
                    const label = `<span class="text-slate-400">[${it.source}]</span> `;
                    const safeTitle = it.title.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const body = it.link ? `<a href="${it.link}" target="_blank" rel="noopener noreferrer">${safeTitle}</a>` : safeTitle;
                    return `<span class="ticker-item">${label}${body}</span>`;
                }).join('');

                document.getElementById('newsContent').innerHTML = ticker;
            } catch (error) {
                console.error('News fetch failed', error);
                document.getElementById('newsContent').innerHTML = '<span class="ticker-item">âš ï¸ News unavailable</span>';
            }
        }

        function fetchBibleVerse() {
            const verses = [
                { ref: 'ç´„ç¿°ç¦éŸ³ 3:16', text: 'ç¥æ„›ä¸–äººï¼Œç”šè‡³å°‡ä»–çš„ç¨ç”Ÿå­è³œçµ¦ä»–å€‘ï¼Œå«ä¸€åˆ‡ä¿¡ä»–çš„ï¼Œä¸è‡³æ»…äº¡ï¼Œåå¾—æ°¸ç”Ÿã€‚' },
                { ref: 'è©©ç¯‡ 23:1', text: 'è€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚' },
                { ref: 'ç®´è¨€ 3:5-6', text: 'ä½ è¦å°ˆå¿ƒä»°è³´è€¶å’Œè¯ï¼Œä¸å¯å€šé è‡ªå·±çš„è°æ˜ï¼Œåœ¨ä½ ä¸€åˆ‡æ‰€è¡Œçš„äº‹ä¸Šéƒ½è¦èªå®šä»–ï¼Œä»–å¿…æŒ‡å¼•ä½ çš„è·¯ã€‚' },
                { ref: 'è…“ç«‹æ¯”æ›¸ 4:13', text: 'æˆ‘é è‘—é‚£åŠ çµ¦æˆ‘åŠ›é‡çš„ï¼Œå‡¡äº‹éƒ½èƒ½åšã€‚' },
                { ref: 'ç¾…é¦¬æ›¸ 8:28', text: 'æˆ‘å€‘æ›‰å¾—è¬äº‹éƒ½äº’ç›¸æ•ˆåŠ›ï¼Œå«æ„›ç¥çš„äººå¾—ç›Šè™•ï¼Œå°±æ˜¯æŒ‰ä»–æ—¨æ„è¢«å¬çš„äººã€‚' }
            ];
            
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const verse = verses[dayOfYear % verses.length];
            
            document.getElementById('bibleVerse').innerHTML = `
                <div class="text-slate-300 leading-relaxed">${verse.text}</div>
                <div class="text-xs text-blue-300 font-semibold text-right mt-2">â€” ${verse.ref}</div>
            `;
        }

        function fetchCalendar() {
            const now = new Date();
            const day = now.getDay();
            let events = [];
            
            const schedule = {
                0: [{ title: 'ä¸»æ—¥å´‡æ‹œ', time: '10:00 AM' }],
                3: [{ title: 'æŸ¥ç¶“ç­', time: '7:30 PM' }]
            };
            
            if (schedule[day] && config.calendar.personal) {
                schedule[day].forEach(e => events.push({ day: 'Today', ...e }));
            }
            
            let html = '';
            if (events.length === 0) {
                html = '<p class="text-slate-400">No events today</p>';
            } else {
                events.forEach(e => {
                    html += `
                        <div class="calendar-event">
                            <div class="flex justify-between items-start">
                                <span class="font-semibold text-blue-300">${e.day}</span>
                                <span class="text-slate-400">${e.time}</span>
                            </div>
                            <div>${e.title}</div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('calendarContainer').innerHTML = html;
        }

        function fetchAllData() {
            fetchWeather();
            fetchCurrencies();
            fetchNews();
            fetchAlerts();
            fetchBibleVerse();
            fetchCalendar();
            updateReminders();
            maybeRefreshStocks(true);
        }

        // -----------------------------
        // YouTube Players (Music + Video)
        // -----------------------------
        let ytMusicPlayer = null;
        let ytVideoPlayer = null;
        let ytApiLoading = false;

        function loadYouTubeIframeApiOnce() {
            if (window.YT && window.YT.Player) return;
            if (ytApiLoading) return;
            ytApiLoading = true;
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            document.head.appendChild(tag);
        }

        function createYtPlayer(elId, playlistId) {
            return new YT.Player(elId, {
                width: '100%',
                height: '100%',
                playerVars: {
                    playsinline: 1,
                    rel: 0,
                    modestbranding: 1,
                    controls: 1,
                    listType: 'playlist',
                    list: playlistId,
                    loop: 1
                },
                events: {
                    onReady: (e) => {
                        try { e.target.setVolume(Number(config.ytVolume) || 80); } catch {}
                        // Cue only (no autoplay) to satisfy kiosk/browser policies.
                        try { e.target.cuePlaylist({ listType: 'playlist', list: playlistId }); }
                        catch { try { e.target.cuePlaylist(playlistId); } catch {} }
                        try { e.target.setShuffle(true); } catch {}
                    }
                }
            });
        }

        // YouTube iframe API callback
        window.onYouTubeIframeAPIReady = function () {
            try {
                ytMusicPlayer = createYtPlayer('ytMusicPlayer', config.ytMusicPlaylistId);
            } catch (e) {
                console.warn('YT music player init failed', e);
            }
            if (!!config.ytEnableVideo && window.innerWidth >= 1600 && window.matchMedia('(orientation: landscape)').matches) {
                try {
                    ytVideoPlayer = createYtPlayer('ytVideoPlayer', config.ytVideoPlaylistId);
                } catch (e) {
                    console.warn('YT video player init failed', e);
                }
            }
        };

        function safeTogglePlay(player) {
            if (!player) return;
            try {
                const st = player.getPlayerState();
                if (st === YT.PlayerState.PLAYING) player.pauseVideo();
                else player.playVideo();
            } catch {
                try { player.playVideo(); } catch {}
            }
        }

        function safeStop(player, playlistId, labelElId) {
            if (!player) return;
            try { player.stopVideo(); } catch {}
            // Re-cue playlist without autoplay to avoid "stop == replay" behavior
            if (playlistId) {
                try { player.cuePlaylist({ listType: 'playlist', list: playlistId }); }
                catch { try { player.cuePlaylist(playlistId); } catch {} }
            }
            if (labelElId) {
                const el = document.getElementById(labelElId);
                if (el) el.textContent = 'å·²åœæ­¢';
            }
        }

        function reshuffleAndReload(player, playlistId) {
            if (!player) return;
            try { player.cuePlaylist({ listType: 'playlist', list: playlistId }); }
            catch { try { player.cuePlaylist(playlistId); } catch {} }
            setTimeout(() => {
                try { player.setShuffle(true); } catch {}
                try {
                    const pl = player.getPlaylist ? player.getPlaylist() : null;
                    const len = Array.isArray(pl) ? pl.length : 0;
                    const idx = len ? Math.floor(Math.random() * len) : 0;
                    player.playVideoAt(idx);
                } catch {
                    try { player.playVideo(); } catch {}
                }
            }, 250);
        }

        function initYouTubeUI() {
            // Music controls
            document.getElementById('musicPrev').addEventListener('click', () => { try { ytMusicPlayer?.previousVideo(); } catch {} });
            document.getElementById('musicPlay').addEventListener('click', () => safeTogglePlay(ytMusicPlayer));
            document.getElementById('musicNext').addEventListener('click', () => { try { ytMusicPlayer?.nextVideo(); } catch {} });
            document.getElementById('musicReshuffle').addEventListener('click', () => reshuffleAndReload(ytMusicPlayer, config.ytMusicPlaylistId));

            // Video controls (only if enabled)
            const vc = document.getElementById('videoCard');
            const hideBtn = document.getElementById('videoHideBtn');
            if (hideBtn) hideBtn.addEventListener('click', () => { vc?.classList.add('hidden'); });

            const enable = !!config.ytEnableVideo && (window.innerWidth >= 1600) && window.matchMedia('(orientation: landscape)').matches;
            if (enable && vc) vc.classList.remove('hidden');

            const bindIf = (id, fn) => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('click', fn);
            };
            bindIf('videoPrev', () => { try { ytVideoPlayer?.previousVideo(); } catch {} });
            bindIf('videoPlay', () => safeTogglePlay(ytVideoPlayer));
            bindIf('videoNext', () => { try { ytVideoPlayer?.nextVideo(); } catch {} });
            bindIf('videoReshuffle', () => reshuffleAndReload(ytVideoPlayer, config.ytVideoPlaylistId));

            // Now playing labels
            function updateLabel(player, elId) {
                const el = document.getElementById(elId);
                if (!el || !player) return;
                try {
                    const data = player.getVideoData ? player.getVideoData() : null;
                    const title = data && data.title ? data.title : '';
                    if (title) el.textContent = title;
                } catch {}
            }
            setInterval(() => {
                updateLabel(ytMusicPlayer, 'musicNowPlaying');
                updateLabel(ytVideoPlayer, 'videoNowPlaying');
            }, 2000);

            loadYouTubeIframeApiOnce();
        }

                // -----------------------------
        // Launch v4 overrides (GitHub-friendly)
        // - Weather: Open-Meteo (no key), 30-min refresh, +1/+4/+12/+æ˜æ—¥ (é›¨/UV)
        // - Reminders: demo (birthdays/game) + hardcoded holidays (NZ/HK) now; later can switch to Calendar WebApp (æ–¹æ¡ˆA)
        // - Alerts ticker: NZTA äº¤é€š + HKO è­¦å ±ï¼ˆå… CORS proxyï¼‰
        // -----------------------------

        function safeNum(v) {
            const n = Number(v);
            return Number.isFinite(n) ? (Math.round(n * 10) / 10) : null;
        }

        
        function parseFeedItems(xmlText){
            try{
                const xml=new DOMParser().parseFromString(xmlText,'text/xml');
                const hasItem=xml.querySelector('item');
                const out=[];
                if(hasItem){
                    xml.querySelectorAll('item').forEach(it=>{
                        const title=it.querySelector('title')?.textContent?.trim();
                        const link=it.querySelector('link')?.textContent?.trim();
                        const desc=it.querySelector('description')?.textContent?.trim()||'';
                        if(title) out.push({title, link, desc});
                    });
                    return out;
                }
                // Atom
                xml.querySelectorAll('entry').forEach(en=>{
                    const title=en.querySelector('title')?.textContent?.trim();
                    const link=en.querySelector('link')?.getAttribute('href') || en.querySelector('link')?.textContent?.trim();
                    const desc=en.querySelector('summary')?.textContent?.trim()||en.querySelector('content')?.textContent?.trim()||'';
                    if(title) out.push({title, link, desc});
                });
                return out;
            }catch(e){
                return [];
            }
        }

function escapeHtml(s) {
            if (s === null || s === undefined) return '';
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function weatherCodeToText(code) {
            const m = {
                0: 'æ™´æœ—',
                1: 'å¤§è‡´æ™´æœ—',
                2: 'éƒ¨åˆ†å¤šé›²',
                3: 'å¤šé›²',
                45: 'éœ§',
                48: 'éœ§å‡‡',
                51: 'æ¯›æ¯›é›¨',
                53: 'æ¯›æ¯›é›¨',
                55: 'æ¯›æ¯›é›¨',
                61: 'å°é›¨',
                63: 'ä¸­é›¨',
                65: 'å¤§é›¨',
                71: 'å°é›ª',
                73: 'ä¸­é›ª',
                75: 'å¤§é›ª',
                80: 'é™£é›¨',
                81: 'é™£é›¨',
                82: 'å¼·é™£é›¨',
                95: 'é›·æš´',
                96: 'é›·æš´å†°é›¹',
                99: 'é›·æš´å†°é›¹'
            };
            return m[code] || ('WeatherCode ' + code);
        }

        async function fetchWeather() {
            const now = new Date();
            const parts = [];

            for (const loc of (config.weatherLocations || [])) {
                try {
                    const base = 'https://api.open-meteo.com/v1/forecast';
                    const url = base +
                        '?latitude=' + encodeURIComponent(loc.lat) +
                        '&longitude=' + encodeURIComponent(loc.lon) +
                        '&current=temperature_2m,weather_code' +
                        '&hourly=temperature_2m,precipitation,precipitation_probability,uv_index,weather_code' +
                        '&daily=uv_index_max,precipitation_sum' +
                        '&forecast_days=2&timezone=auto';

                    const resp = await fetch(url, { cache: 'no-store' });
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    const data = await resp.json();

                    const times = (data.hourly.time || []).map(t => new Date(t));
                    let idx = 0;
                    for (let i = 0; i < times.length; i++) {
                        if (times[i] <= now) idx = i;
                        else break;
                    }

                    const currentTemp = Math.round(data.current.temperature_2m);
                    const desc = weatherCodeToText(data.current.weather_code);

                    const uvNow = safeNum((data.hourly.uv_index || [])[idx]);
                    const uvTomorrowMax = safeNum((data.daily.uv_index_max || [])[1]);
                    const rainTomorrow = safeNum((data.daily.precipitation_sum || [])[1]);

                    const fmt = (d) => d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const pick = (off) => {
                        const j = Math.min(idx + off, times.length - 1);
                        const t = times[j] ? fmt(times[j]) : ('+' + off + 'h');
                        const p = safeNum((data.hourly.precipitation_probability || [])[j]);
                        const mm = safeNum((data.hourly.precipitation || [])[j]);
                        const pStr = (p === null) ? '?' : (Math.round(p) + '%');
                        const mmStr = (mm === null) ? '?' : (mm + 'mm');
                        return t + ':' + pStr + '/' + mmStr;
                    };

                    const line1 = 'UV: ' + (uvNow === null ? '?' : uvNow) + (uvTomorrowMax === null ? '' : 'ï¼ˆæ˜æ—¥æœ€é«˜:' + uvTomorrowMax + 'ï¼‰');
                    const line2 = 'é›¨: +1h ' + pick(1) + ', +4h ' + pick(4) + ', +12h ' + pick(12) + ', æ˜æ—¥' + (rainTomorrow === null ? '?' : rainTomorrow) + 'mm';

                    const isHK = ((loc.label || '').toLowerCase().indexOf('hong kong') !== -1);
                    const displayLabel = isHK ? 'é¦™æ¸¯' : (loc.label || '');

                    const headerHtml =
                        '<div class="flex items-center justify-between">' +
                            '<div class="text-sm font-semibold">' + escapeHtml(displayLabel) +
                                ' <span class="text-xs text-slate-400 ml-2">' + escapeHtml(desc) + '</span>' +
                            '</div>' +
                            '<div class="text-2xl font-bold">' + currentTemp + 'Â°C</div>' +
                        '</div>';

                    let detailHtml = '';
                    if (!isHK) {
                        detailHtml =
                            '<div class="text-xs text-slate-300 mt-1">â˜€ï¸ ' + escapeHtml(line1) + '</div>' +
                            '<div class="text-xs text-slate-300">ğŸ’§ ' + escapeHtml(line2) + '</div>';
                    }

                    parts.push(
                        '<div class="weather-location">' +
                            headerHtml +
                            detailHtml +
                        '</div>'
                    );
                } catch (e) {
                    console.warn('Weather failed for', loc && loc.label, e);
                    parts.push(
                        '<div class="weather-location">' +
                            '<div class="text-sm font-semibold">' + escapeHtml((loc && loc.label) || 'Weather') + '</div>' +
                            '<div class="text-xs text-red-300">âš ï¸ Weather unavailable</div>' +
                        '</div>'
                    );
                }
            }

            const wc = document.getElementById('weatherContainer');
            if (wc) wc.innerHTML = parts.join('');
            const ws = document.getElementById('weatherStatus');
            if (ws) ws.innerHTML = '<i class="fas fa-cloud-sun mr-1"></i>Weather: <span class="text-green-400">Updated</span>';
        }

        // Alerts tickerï¼ˆé‡è¦å¿«è¨Šï¼šäº¤é€šï¼è­¦å ±ï¼ä¸–ç•Œè¦èï¼‰
        async function fetchAlerts() {
            const out = [];
            let hadError = false;

            // Helper: push items with source label
            const pushItems = (source, items, limit) => {
                const take = (limit ? items.slice(0, limit) : items);
                take.forEach(t => { if (t) out.push({ source, text: t }); });
            };

            // 1) NZTA traffic (Auckland serious only; fallback to newest if none)
            try {
                const base = 'https://services.arcgis.com/CXBb7LAjgIIdcsPt/arcgis/rest/services/NZTA_Highway_Information/FeatureServer/0/query';
                const params = new URLSearchParams({
                    where: '1=1',
                    outFields: 'eventType,locationArea,eventDescription,impact,status,eventModified',
                    orderByFields: 'eventModified DESC',
                    resultRecordCount: '30',
                    f: 'json'
                });
                const resp = await fetch(getCorsProxy(base + '?' + params.toString()), { cache: 'no-store' });
                if (resp.ok) {
                    const data = await resp.json();
                    const feats = (data && data.features) ? data.features : [];

                    const aucklandKeys = ['auckland','north shore','manukau','papakura','takanini','drury','albany','henderson','penrose','mt wellington','botany','howick','pakuranga'];
                    const seriousKeys = ['serious crash','crash','accident','incident','blocked','road closed','closure','closed','major delay','long delays','congestion','queue','queues'];
                    const excludeKeys = ['road work','roadworks','maintenance','resurfacing','chipseal','temporary speed','worksite'];

                    const isAuckland = (s) => {
                        const t = (s||'').toLowerCase();
                        return aucklandKeys.some(k => t.includes(k));
                    };
                    const isSerious = (s) => {
                        const t = (s||'').toLowerCase();
                        if (excludeKeys.some(k => t.includes(k))) return false;
                        return seriousKeys.some(k => t.includes(k));
                    };

                    const formatted = feats.map(f => {
                        const a = (f && f.attributes) ? f.attributes : {};
                        const type = (a.eventType || '').toString().trim();
                        const loc = (a.locationArea || '').toString().trim();
                        const desc = (a.eventDescription || '').toString().trim();
                        const impact = (a.impact || '').toString().trim();
                        const text = [type, loc, impact || desc].filter(Boolean).join(' - ');
                        return { text, raw: (type + ' ' + loc + ' ' + desc + ' ' + impact) };
                    }).filter(x => x.text);

                    const auckSerious = formatted.filter(x => isAuckland(x.raw) && isSerious(x.raw)).map(x => x.text);
                    const auckAny = formatted.filter(x => isAuckland(x.raw)).map(x => x.text);
                    const fallback = formatted.map(x => x.text);

                    const pick = (auckSerious.length ? auckSerious : (auckAny.length ? auckAny : fallback));
                    pushItems('NZTA', pick, 6);
                }
            } catch (e) {
                console.warn('NZTA alerts failed', e); hadError = true;
            }

            // 2) MetService CAP alerts (RSS + Atom fallback, include area)
            try {
                const texts = await fetchMetServiceCap(8);
                pushItems('MetService', texts, 6);
            } catch (e) {
                console.warn('MetService feed failed', e); hadError = true;
            }

            // 4) Civil Defence RSS
            try {
                const items = await fetchRss('https://www.civildefence.govt.nz/home/rss', 8);
                const texts = items.map(it => it.title).filter(Boolean);
                pushItems('CivilDefence', texts, 4);
            } catch (e) {
                console.warn('CivilDefence feed failed', e); hadError = true;
            }

            
            // 4b) Awaikato (feed provided)
            try {
                const items = await fetchRss('https://media.rss.com/awaikatothing/feed.xml', 6);
                const texts = items.map(it => it.title).filter(Boolean);
                pushItems('Awaikato', texts, 3);
            } catch (e) {
                console.warn('Awaikato feed failed', e); hadError = true;
            }

            const el = document.getElementById('alertsContent');
            if (!el) return;

            if (!out.length) {
                el.innerHTML = hadError
                    ? '<span class="ticker-item">ï¼ˆé‡è¦å¿«è¨Šè®€å–å¤±æ•—ï¼‰</span>'
                    : '<span class="ticker-item">ï¼ˆæš«ç„¡é‡è¦å¿«è¨Šï¼‰</span>';
                return;
            }

            const html = out.map(it => {
                const label = '<span class="text-yellow-300">[' + it.source + ']</span> ';
                return '<span class="ticker-item">' + label + escapeHtml(it.text) + '</span>';
            }).join('');

            el.innerHTML = html;
        }

        // Reminders override (Launch): demo birthdays/game + hardcoded holidays (NZ/HK)
        async function updateReminders() {
            const now = new Date();
            const oneWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const reminders = [];

            // Holidays (hardcoded fallback already present)
            if (config.calendar && config.calendar.nz && typeof holidays2026 !== 'undefined' && holidays2026.nz) {
                holidays2026.nz.forEach(h => {
                    const d = new Date(h.date);
                    if (d >= now && d <= oneWeek) reminders.push({ text: 'ğŸ‡³ğŸ‡¿ ' + h.name, date: h.date });
                });
            }
            if (config.calendar && config.calendar.hk && typeof holidays2026 !== 'undefined' && holidays2026.hk) {
                holidays2026.hk.forEach(h => {
                    const d = new Date(h.date);
                    if (d >= now && d <= oneWeek) reminders.push({ text: 'ğŸ‡­ğŸ‡° ' + h.name, date: h.date });
                });
            }

            reminders.sort((a, b) => new Date(a.date) - new Date(b.date));

            const box = document.getElementById('upcomingReminders');
            if (!box) return;

            if (!reminders.length) {
                box.innerHTML = '<div class="text-slate-400 text-center mt-4">æœªä¾† 7 æ—¥ç„¡äº‹ä»¶</div>';
                return;
            }

            box.innerHTML = reminders.map(r => {
                const d = new Date(r.date);
                const daysUntil = Math.ceil((d - now) / (24 * 60 * 60 * 1000));
                const dayText = daysUntil === 0 ? 'ä»Šæ—¥' : (daysUntil === 1 ? 'æ˜æ—¥' : ('é‚„æœ‰ ' + daysUntil + ' æ—¥'));
                return '<div class="reminder-item"><div class="flex justify-between"><span>' + escapeHtml(r.text) + '</span><span class="text-yellow-400">' + dayText + '</span></div></div>';
            }).join('');
        }



        // ------------------------------
        // Stocks (Finnhub / TwelveData) with auto failover + cache
        // ------------------------------
        const STOCK_CACHE_KEY = 'dp_stocks_cache_v5';
        let stockCache = null;

        function loadStockCache(){
            try{ const raw=SafeStore.get(STOCK_CACHE_KEY); if(!raw) return null; return JSON.parse(raw);}catch(e){return null;}
        }
        function saveStockCache(obj){
            try{ SafeStore.set(STOCK_CACHE_KEY, JSON.stringify(obj)); }catch(e){}
        }
        function todayKey(d){
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        }
        function isNearTime(hhmm, now, windowMin){
            try{
                const [hh,mm]=hhmm.split(':').map(x=>parseInt(x,10));
                const t=new Date(now); t.setHours(hh,mm,0,0);
                const diff=Math.abs(now.getTime()-t.getTime())/60000;
                return diff <= (windowMin||7);
            }catch(e){ return false; }
        }
        function fmtPct(x){
            if(x===null||x===undefined||isNaN(x)) return '';
            const v=Number(x);
            const s=(v>0?'+':'') + v.toFixed(1) + '%';
            return s;
        }
        function renderStocks(quotes, meta){
            const el=document.getElementById('stocksContent');
            if(!el) return;
            const arr=(config.stocks||[]).map(s=>{
                const q=quotes && quotes[s.symbol];
                if(!q) return {symbol:s.symbol, missing:true};
                return {symbol:s.symbol, price:q.price, pct:q.pct, buy:s.buyPrice};
            });
            const html=arr.map(it=>{
                if(it.missing) return '<span class="ticker-item">'+escapeHtml(it.symbol)+': ?</span>';
                const below = (it.buy!=null && it.price!=null && it.price < it.buy);
                const dot = '<span class="ticker-dot"></span>';
                const priceStr = (it.price==null? '?' : ('$'+Number(it.price).toFixed(2)));
                const pctStr = (it.pct==null? '' : fmtPct(it.pct));
                const arrow = (it.pct==null? '' : (it.pct>=0 ? ' <span class="text-green-400">â–²</span>' : ' <span class="text-red-400">â–¼</span>'));
                const warn = below ? ' <span class="text-yellow-300">âš </span>' : '';
                const buy = (it.buy==null? '' : (' | Buy: $'+Number(it.buy).toFixed(2)));
                return '<span class="ticker-item">'+dot+' '+escapeHtml(it.symbol)+': '+priceStr+(pctStr?(' '+arrow+' '+escapeHtml(pctStr)):'')+buy+warn+'</span>';
            }).join('');
            el.innerHTML = html || '<span class="ticker-item">ï¼ˆæš«ç„¡è‚¡ç¥¨ï¼‰</span>';
        }

        async function fetchStocks(provider){
            const symbols=(config.stocks||[]).map(s=>s.symbol).filter(Boolean);
            const quotes={};
            const used = provider;

            if(provider==='twelvedata'){
                const key=(config.twelveDataKey||'').trim();
                if(!key) throw new Error('NO_TWELVEDATA_KEY');
                const url='https://api.twelvedata.com/quote?symbol='+encodeURIComponent(symbols.join(','))+'&apikey='+encodeURIComponent(key);
                const resp=await fetch(url,{cache:'no-store'});
                const data=await resp.json();
                if(!resp.ok) throw new Error('HTTP_'+resp.status);
                // multi-symbol returns object keyed by symbol
                for(const sym of symbols){
                    const d=data[sym] || (data.symbol===sym?data:null);
                    if(!d || d.status==='error') continue;
                    const price=Number(d.price);
                    const pct = d.percent_change!=null ? Number(d.percent_change) : (d.change_percent!=null ? Number(d.change_percent) : null);
                    quotes[sym]={price: isNaN(price)?null:price, pct: (pct==null || (pct!=pct))?null:pct};
                }
                return {quotes, provider:used};
            }

            if(provider==='finnhub'){
                const key=(config.finnhubKey||'').trim();
                if(!key) throw new Error('NO_FINNHUB_KEY');
                for(const sym of symbols){
                    const url='https://finnhub.io/api/v1/quote?symbol='+encodeURIComponent(sym)+'&token='+encodeURIComponent(key);
                    const resp=await fetch(url,{cache:'no-store'});
                    if(!resp.ok) throw new Error('HTTP_'+resp.status);
                    const d=await resp.json();
                    const price = (d && d.c!=null) ? Number(d.c) : null;
                    const prev = (d && d.pc!=null) ? Number(d.pc) : null;
                    let pct=null;
                    if(price!=null && prev!=null && prev!==0) pct=((price-prev)/prev)*100;
                    quotes[sym]={price: isNaN(price)?null:price, pct: (pct==null||isNaN(pct))?null:pct};
                    await new Promise(r=>setTimeout(r, 250));
                }
                return {quotes, provider:used};
            }

            throw new Error('UNKNOWN_PROVIDER');
        }

        async function refreshStocks(force){
            const el=document.getElementById('stocksContent');
            if(el) el.innerHTML='<span class="ticker-item">Loading stocks...</span>';

            const provider=(config.stockApiProvider||'auto');
            const tries = (provider==='auto')
                ? ['twelvedata','finnhub']
                : [provider, (provider==='twelvedata'?'finnhub':'twelvedata')];

            let lastErr=null;
            for(const p of tries){
                try{
                    const res=await fetchStocks(p);
                    // keep only those with price
                    const have = Object.keys(res.quotes||{}).length;
                    if(!have) throw new Error('NO_DATA');
                    const now=new Date();
                    stockCache = {
                        date: todayKey(now),
                        updatedAt: now.toISOString(),
                        provider: res.provider,
                        quotes: res.quotes,
                        slots: stockCache && stockCache.date===todayKey(now) ? (stockCache.slots||{}) : {}
                    };
                    saveStockCache(stockCache);
                    renderStocks(stockCache.quotes, stockCache);
                    return;
                }catch(e){
                    lastErr=e;
                }
            }

            // fallback to cache
            if(stockCache && stockCache.quotes){
                renderStocks(stockCache.quotes, stockCache);
            } else {
                const el2=document.getElementById('stocksContent');
                if(el2) el2.innerHTML='<span class="ticker-item">ï¼ˆè‚¡ç¥¨è®€å–å¤±æ•—ï¼‰</span>';
            }
            console.warn('Stocks refresh failed', lastErr);
        }

        function maybeRefreshStocks(force){
            const now=new Date();
            if(!stockCache) stockCache = loadStockCache();
            if(stockCache && stockCache.quotes) renderStocks(stockCache.quotes, stockCache);

            const tKey=todayKey(now);
            if(!stockCache || stockCache.date!==tKey){
                stockCache = stockCache || {};
                stockCache.date=tKey;
                stockCache.slots={};
            }
            if(force){
                refreshStocks(true);
                return;
            }
            const times = (config.stockRefreshTimes||[]).slice(0,2);
            const windowMin=7;
            for(const t of times){
                if(!t) continue;
                if(isNearTime(t, now, windowMin)){
                    if(stockCache.slots && stockCache.slots[t]===tKey) continue; // already fetched this slot today
                    stockCache.slots = stockCache.slots || {};
                    stockCache.slots[t]=tKey;
                    saveStockCache(stockCache);
                    refreshStocks(false);
                    break;
                }
            }
        }



function init() {
            loadSavedSettings();
            populateSettingsUI();
            updateDigitalClock();
            updateAnalogClock();
            initYouTubeUI();
            fetchAllData();
            // Launchç‰ˆï¼šç›¸ç‰‡åŠŸèƒ½æš«æ™‚ç§»é™¤
            setInterval(() => {
                updateDigitalClock();
                updateAnalogClock();
            }, 1000);
            
            setInterval(updateReminders, 3600000);
            setInterval(fetchWeather, 1800000);
            setInterval(fetchCurrencies, 1800000);
            setInterval(fetchNews, 1800000);
            setInterval(fetchAlerts, 1800000);

            // Stocks: check schedule every 5 minutes, but only fetch near the configured times (max 2x/day)
            setInterval(() => maybeRefreshStocks(false), 300000);
            maybeRefreshStocks(false);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
        async function fetchCalendarWebApp(days=7){
            const url=(config.calendarWebAppUrl||'').trim();
            if(!url) return { ok:false, events:[], error:'NO_URL' };
            const token=(config.calendarWebAppToken||'').trim();
            const params=new URLSearchParams();
            if(token) params.set('token', token);
            params.set('days', String(days));
            // pass calendar IDs
            for(const [k,v] of Object.entries(config.calendarIds||{})){
                if(v) params.append('cal', v);
            }
            const final=url + (url.includes('?')?'&':'?') + params.toString();
            try{
                const res=await fetch(final);
                if(!res.ok) throw new Error('HTTP_'+res.status);
                const data=await res.json();
                const events=data.events||data.items||[];
                return { ok:true, events };
            }catch(e){
                return { ok:false, events:[], error:String(e) };
            }
        }



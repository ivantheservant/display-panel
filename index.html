<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Panel - Final Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            color: #f8fafc; 
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            overflow: hidden;
            margin: 0; padding: 0;
        }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .card { 
            border-radius: 1rem; 
            padding: 1rem; 
            height: 100%; 
            display: flex;
            flex-direction: column;
        }
        
        /* Landscape-optimized Grid */
        .grid-container {
            display: grid;
            gap: 0.75rem;
            height: 100vh;
            padding: 0.75rem;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
        }

to { opacity: 1; }
        }
        
        /* Clock */
        .clock-face {
            width: 100px; height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, #1e293b, #0f172a);
            border: 2px solid rgba(148, 163, 184, 0.3);
            position: relative;
        }
        .clock-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            border-radius: 6px;
        }
        .hour-hand { width: 3px; height: 30px; background: #f1f5f9; margin-left: -1.5px; }
        .minute-hand { width: 2px; height: 40px; background: #cbd5e1; margin-left: -1px; }
        .second-hand { width: 1px; height: 42px; background: #ef4444; margin-left: -0.5px; }
        .clock-center {
            position: absolute;
            width: 6px; height: 6px;
            background: #ef4444;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        /* Tickers */
        .ticker {
            width: 100%;
            overflow: hidden;
            background: rgba(15, 23, 42, 0.5);
            padding: 0.75rem 0;
            border-radius: 0.5rem;
        }
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
        }
        .news-ticker-content { animation: scroll-left 100s linear infinite; }
        .stock-ticker-content { animation: scroll-left 80s linear infinite; }
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .ticker-item {
            display: inline-block;
            margin-right: 3rem;
            padding: 0 0.5rem;
            font-size: 1rem;
        }
        .ticker-item::before {
            content: '‚óè';
            color: #3b82f6;
            margin-right: 0.75rem;
        }
        
        /* Alerts */
        @keyframes alert-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .stock-alert {
            animation: alert-pulse 1.5s ease-in-out infinite;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        /* Media (YouTube) */
        .yt-frame {
            width: 100%;
            height: 120px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .yt-frame-video { height: 160px; }
        .yt-player { width: 100%; height: 100%; }
        .media-btn {
            padding: 0.35rem 0.55rem;
            border-radius: 0.5rem;
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.25);
            font-size: 0.75rem;
        }
        .media-btn:hover { background: rgba(51, 65, 85, 0.9); }
        
        /* Settings */
        .settings-panel {
            position: fixed;
            top: 0; right: -550px;
            width: 550px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }
        .settings-panel.open { right: 0; }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 10px; }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Bible & Calendar */
        .bible-verse {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border-left: 3px solid #3b82f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .calendar-event {
            background: rgba(59, 130, 246, 0.1);
            border-left: 2px solid #3b82f6;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        .reminder-item {
            background: rgba(234, 179, 8, 0.1);
            border-left: 2px solid #eab308;
            padding: 0.4rem;
            border-radius: 0.5rem;
            margin-top: 0.3rem;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>

    <!-- Settings Button -->
    <button onclick="toggleSettings()" class="fixed top-3 right-3 z-50 p-2 glass rounded-full hover:bg-blue-600 transition-all">
        <i class="fas fa-cog text-lg"></i>
    </button>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel custom-scrollbar">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Settings</h2>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-4 text-sm">
            <!-- Important Notice -->
            <div class="bg-blue-900/30 border border-blue-700 rounded p-3">
                <h3 class="font-semibold mb-1 text-blue-400">üí° Setup Instructions</h3>
                <p class="text-xs text-blue-200 mb-2">For CORS errors: Open this HTML file directly in your browser (double-click) or install a CORS browser extension.</p>
                <p class="text-xs text-blue-200">Preview errors are normal - they'll disappear in actual use!</p>
            </div>
            <!-- Calendar (ÊñπÊ°àA: Apps Script Web App) -->
            <div>
                <h3 class="font-semibold mb-2 text-green-400">üìÖ Êó•ÊõÜÔºàÊñπÊ°àAÔºâ</h3>
                <p class="text-xs text-slate-400 mb-2">Áî® Google Apps Script Web App ËÆÄÂèñ‰Ω†Â∑≤ÂãæÈÅ∏ÁöÑË°å‰∫ãÊõÜÔºàÁßÅÂØÜ‰∫¶ÂèØÔºâ„ÄÇ</p>
                <div class="space-y-2 ml-4">
                    <div>
                        <label class="block text-xs mb-1">Calendar Web App URL</label>
                        <input type="text" id="calendarWebAppUrl" placeholder="https://script.google.com/macros/s/.../exec"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                    <div>
                        <label class="block text-xs mb-1">TokenÔºàÂèØÈÅ∏Ôºâ</label>
                        <input type="text" id="calendarToken" placeholder="ÁïôÁ©∫‰∫¶ÂèØ"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                    <p class="text-[11px] text-slate-400">Êú™Â°´ URL ÊúÉÁî®Á§∫ÁØÑË≥áÊñô„ÄÇ</p>
                </div>
            </div>

            <!-- CORS Proxy -->
            <div class="bg-yellow-900/30 border border-yellow-700 rounded p-3">
                <label class="flex items-center">
                    <input type="checkbox" id="useCorsProxy" class="mr-2">
                    <span class="text-xs">Use CORS Proxy (slower, for testing)</span>
                </label>
            </div>
            
            <!-- API Keys -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">API Keys</h3>
                <div class="space-y-2">
                    <div>
                        <label class="block text-xs mb-1">WeatherÔºàOpen-MeteoÔºåÂÖç API KeyÔºâ</label>
                        <div class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs text-slate-300">Â∑≤ÊîπÁî® Open‚ÄëMeteoÔºöÈõ®Èáè/ÈôçÈõ®Ê©üÁéá/UVÔºà+1/+4/+12/ÊòéÊó•ÔºâÔºåÊØè 30 ÂàÜÈêòÊõ¥Êñ∞</div>
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Stocks API Provider</label>
                        <select id="stockApiProvider" class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                            <option value="demo">Demo Mode (No API)</option>
                            <option value="twelvedata">Twelve Data (Êé®Ëñ¶ÔºöÂèØ‰∏ÄÊ¨°ÂèñÂ§öÈöªËÇ°Á•®)</option>
                            <option value="finnhub">Finnhub (ÂÇôÁî®ÔºöÈÄêÈöªËÇ°Á•®Êü•Ë©¢)</option>
                        </select>
                        <p class="text-[11px] text-slate-400 mt-1">Âª∫Ë≠∞ÔºöFinnhub ÂÅö‰∏ªÔºà60/minÔºåÈÅ©Âêà 12 ÈöªËÇ°Á•®ÔºâÔºåTwelve Data ÂÅöÂÇôÁî®ÔºàFree plan 8/minÔºåÈúÄË¶ÅÂàÜÊÆµÔºâ„ÄÇÈ†êË®≠ÊØèÊó•Âè™Êõ¥Êñ∞ 2 Ê¨°‰ª•ÊéßÂà∂ÂÖçË≤ªÈ°çÂ∫¶„ÄÇ</p>
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Twelve Data API Key</label>
                        <input type="text" id="twelveDataKey" value=""
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Finnhub API Key</label>
                        <input type="text" id="finnhubKey" value=""
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>

                    <div class="mt-3">
                        <label class="block text-xs mb-1">Stocks Refresh Times (Local Time, 2x/day)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="time" id="stockRefresh1" class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs" value="07:00">
                            <input type="time" id="stockRefresh2" class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs" value="11:00">
                        </div>
                        <p class="text-[11px] text-slate-400 mt-1">Panel checks every 5 minutes but only fetches near these times (¬±5 min), maximum 2 updates per day.</p>
                    </div>
                </div>
            </div>
            
            <!-- News Sources -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">News Sources</h3>
                <div class="space-y-1">
                    <label class="flex items-center">
                        <input type="checkbox" id="newsDemo" checked class="mr-2">
                        <span>Demo News (Traditional Chinese)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="newsLTN" class="mr-2">
                        <span>Ëá™Áî±ÊôÇÂ†± LTN (Traditional Chinese RSS)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="newsSCMP" class="mr-2">
                        <span>SCMP (requires CORS proxy)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="newsBBC" class="mr-2">
                        <span>BBC (requires CORS proxy)</span>
                    </label>
                </div>
            </div>
            
            <!-- Calendar Toggles -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">Calendar Display</h3>
                <div class="space-y-1">
                    <label class="flex items-center">
                        <input type="checkbox" id="calPersonal" checked class="mr-2">
                        <span>Personal Events</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calBirthday" checked class="mr-2">
                        <span>Birthdays (1 week reminder)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calFamily" checked class="mr-2">
                        <span>Family Events</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calGame" checked class="mr-2">
                        <span>Game Events (1 week reminder)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calNZ" checked class="mr-2">
                        <span>NZ Holidays (1 week reminder)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calHK" checked class="mr-2">
                        <span>HK Holidays (1 week reminder)</span>
                    </label>
                </div>
            </div>
            
            <button onclick="saveSettings()" class="w-full p-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">
                Save & Apply
            </button>
        </div>
    </div>

    <div class="grid-container" id="mainGrid">
        <!-- Clock, Date & Reminders -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <div class="flex items-center justify-between gap-3 mb-2">
                <div class="flex-1">
                    <div id="digitalClock" class="text-4xl font-bold">00:00:00</div>
                    <div id="dateStr" class="text-sm text-slate-400 mt-1">Loading...</div>
                </div>
                <div class="clock-face">
                    <div class="clock-hand hour-hand" id="hourHand"></div>
                    <div class="clock-hand minute-hand" id="minuteHand"></div>
                    <div class="clock-hand second-hand" id="secondHand"></div>
                    <div class="clock-center"></div>
                </div>
            </div>
            <div id="upcomingReminders" class="flex-1 overflow-y-auto custom-scrollbar text-xs">
                <div class="text-slate-400 text-center mt-4">Loading reminders...</div>
            </div>
        </div>

        <!-- Weather -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-cloud-sun mr-1"></i>Weather</h3>
            <div id="weatherContainer" class="flex-1 overflow-y-auto custom-scrollbar text-xs">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Bible Verse -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-book-bible mr-1"></i>‰ªäÊó•ÈáëÂè•</h3>
            <div id="bibleVerse" class="bible-verse flex-1 overflow-y-auto custom-scrollbar">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-calendar-alt mr-1"></i>Schedule</h3>
            <div id="calendarContainer" class="flex-1 overflow-y-auto custom-scrollbar text-xs space-y-1">
                <p class="text-slate-400">Loading...</p>
            </div>
        </div>

        <!-- Currencies -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <h3 class="text-sm font-semibold mb-2">
                <i class="fas fa-exchange-alt mr-1"></i>Currencies
            </h3>
            <div id="currencyList" class="space-y-2 flex-1 text-xs">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Media (replaces Status Panel in production UI) -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold"><i class="fas fa-play-circle mr-1"></i>Â™íÈ´î</h3>
                <button id="toggleVideoSectionBtn" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-[11px] hover:bg-slate-700">
                    È°ØÁ§∫ÂΩ±Áâá
                </button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar text-xs space-y-3">
                <!-- YouTube Music -->
                <div>
                    <div class="text-[11px] text-slate-400 mb-1">üéµ YouTube Èü≥Ê®ÇÊí≠ÊîæÊ∏ÖÂñÆ</div>
                    <div class="yt-frame">
                        <div id="ytMusicPlayer" class="yt-player"></div>
                    </div>
                    <div class="mt-2 flex flex-wrap gap-1">
                        <button class="media-btn" id="musicPrev">Prev</button>
                        <button class="media-btn" id="musicPlay">Play / Pause</button>
                        <button class="media-btn" id="musicStop">Stop</button>
                        <button class="media-btn" id="musicNext">Next</button>
                        <button class="media-btn" id="musicReshuffle">Reshuffle / Êõ¥Êñ∞</button>
                    </div>
                </div>

                <!-- YouTube Video (large screen recommended) -->
                <div id="videoPlayerSection" class="hidden">
                    <div class="text-[11px] text-slate-400 mb-1">üé¨ Â§ßÂ±èÂΩ±ÁâáÊí≠ÊîæÊ∏ÖÂñÆ</div>
                    <div class="yt-frame yt-frame-video">
                        <div id="ytVideoPlayer" class="yt-player"></div>
                    </div>
                    <div class="mt-2 flex flex-wrap gap-1">
                        <button class="media-btn" id="videoPrev">Prev</button>
                        <button class="media-btn" id="videoPlay">Play / Pause</button>
                        <button class="media-btn" id="videoStop">Stop</button>
                        <button class="media-btn" id="videoNext">Next</button>
                        <button class="media-btn" id="videoReshuffle">Reshuffle / Êõ¥Êñ∞</button>
                    </div>
                </div>
            </div>

            <!-- Hidden status hooks (keep IDs to avoid JS errors) -->
            <div id="systemStatus" class="hidden">
                <div>‚è∞ Clock: <span class="text-green-400">Running</span></div>
                <div id="weatherStatus">‚òÅÔ∏è Weather: <span class="text-yellow-400">Updating...</span></div>
                <div id="stockStatusPanel">üìà Stocks: <span class="text-yellow-400">Updating...</span></div>
                <div id="newsStatus">üì∞ News: <span class="text-yellow-400">Updating...</span></div>
                <div id="currencyStatus">üí± Currency: <span class="text-yellow-400">Updating...</span></div>
                <div id="photoStatus">üì∏ Photos: <span class="text-slate-400">Disabled</span></div>
            </div>
        </div>

        <!-- News Ticker (two lines) -->
        <div class="glass card" style="grid-column: span 6; grid-row: 5;">
            <h3 class="text-sm font-semibold mb-2">
                <i class="fas fa-newspaper mr-1"></i>Êñ∞ËÅû
            </h3>
            <div class="text-[11px] text-slate-400 mb-1">‰∏ÄËà¨</div>
            <div class="ticker mb-2">
                <div class="ticker-content news-ticker-content" id="newsContent">
                    <span class="ticker-item">Loading...</span>
                </div>
            </div>
            <div class="text-[11px] text-slate-400 mb-1">ÈáçË¶ÅÂø´Ë®äÔºàÂ§©Ê∞£Ôºè‰∫§ÈÄöÔºèË≠¶Â†±Ôºâ</div>
            <div class="ticker">
                <div class="ticker-content news-ticker-content" id="alertsContent">
                    <span class="ticker-item">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Stocks Ticker -->
        <div class="glass card" style="grid-column: span 6; grid-row: 6;">
            <h3 class="text-sm font-semibold mb-2">
                <i class="fas fa-chart-line mr-1"></i>My Stocks (Ë≤∑ÂÖ•ÂÉπÂ∞çÊØî)
            </h3>
            <div class="ticker">
                <div class="ticker-content stock-ticker-content" id="stocksContent">
                    <span class="ticker-item">Loading stocks...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            // APIs
            weatherApiKey: '',
            // WARNING: Do NOT commit real API keys to public GitHub.
            // Put keys in Settings in production, or keep this file private.
            twelveDataKey: '',
            finnhubKey: '',
            stockApiProvider: 'demo',

            // YouTube
            ytMusicPlaylistId: 'PLK1NiZBn99vRvPpps7r9wMB0KLUacyRKT',
            ytVideoPlaylistId: 'PLK1NiZBn99vQ79xMYiOyZwdH6-u1WqqxC',
            ytVolume: 80,
            ytShowVideo: false,
            useCorsProxy: false,

            // Stocks refresh (local time, 2x/day)
            stockRefreshTimes: ['07:00', '11:00'],
            
            // Google Calendar (NEW)
            useGoogleCalendar: false,
            gcalApiKey: '',
            nzCalendarId: 'en.new_zealand#holiday@group.v.calendar.google.com',
            hkCalendarId: 'en.hong_kong#holiday@group.v.calendar.google.com',
            personalCalendarId: '',
            
            // Photo Memories (NEW)
            enablePhotos: false,
            photoSource: 'demo', // 'demo', 'gdrive', 'onedrive'
            gdriveFolderId: '',
            onedrivePath: '',
            photoInterval: 300000, // 5 minutes
            
            // Existing config
            weatherLocations: [
                { label: 'Auckland', lat: -36.8485, lon: 174.7633 },
                { label: 'Botany Downs', lat: -36.9167, lon: 174.9110 },
                { label: 'Hong Kong', lat: 22.3193, lon: 114.1694 }
            ],
            stocks: [
                { symbol: 'AAPL', buyPrice: 613 },
                { symbol: 'AVAV', buyPrice: 240 },
                { symbol: 'DXYZ', buyPrice: 57.38 },
                { symbol: 'GOOG', buyPrice: 337 },
                { symbol: 'ISRG', buyPrice: 479 },
                { symbol: 'RBLX', buyPrice: 117.53 },
                { symbol: 'RNMBY', buyPrice: 408.32 },
                { symbol: 'TEM', buyPrice: 70.55 },
                { symbol: 'TSLA', buyPrice: 390.42 },
                { symbol: 'TSM', buyPrice: 234.81 },
                { symbol: 'PLTR', buyPrice: 126.32 },
                { symbol: 'NVDA', buyPrice: 143.63 }
            ],
            currencies: [
                { pair: 'NZD-USD', alert: 0.55, below: true },
                { pair: 'NZD-HKD', alert: 4.5, below: true }
            ],
            calendar: {
                personal: true,
                birthday: true,
                family: true,
                game: true,
                nz: true,
                hk: true
            },
            newsFeeds: {
                demo: true,
                ltn: false,
                scmp: false,
                bbc: false
            }
        };

        // Cache structure: { updatedAt: ISOString, provider: string, items: Array }
        let stockCache = null;
        let lastStockFetchMarker = null; // used to enforce max 2x/day schedule
        let photoTimer = null;
        let currentPhotoIndex = 0;
        let todayPhotos = [];

        const STOCK_CACHE_KEY = 'panelStockCache';
        const STOCK_REFRESH_LOG_KEY = 'panelStockRefreshLog';

        function loadStockCache() {
            try {
                const raw = localStorage.getItem(STOCK_CACHE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (parsed && Array.isArray(parsed.items) && parsed.items.length) {
                    return parsed;
                }
            } catch (e) {
                console.warn('Stock cache parse failed', e);
            }
            return null;
        }

        function saveStockCache(cacheObj) {
            try {
                localStorage.setItem(STOCK_CACHE_KEY, JSON.stringify(cacheObj));
            } catch (e) {
                console.warn('Stock cache write failed', e);
            }
        }

        function loadStockRefreshLog() {
            try {
                const raw = localStorage.getItem(STOCK_REFRESH_LOG_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (e) {
                return {};
            }
        }

        function saveStockRefreshLog(log) {
            try {
                localStorage.setItem(STOCK_REFRESH_LOG_KEY, JSON.stringify(log));
            } catch (e) {
                // ignore
            }
        }

        // Hardcoded holidays (fallback when Google Calendar not used)
        const holidays2026 = {
            nz: [
                { date: '2026-01-26', name: 'Auckland Anniversary' },
                { date: '2026-02-06', name: 'Waitangi Day' },
                { date: '2026-04-10', name: 'Good Friday' },
                { date: '2026-04-13', name: 'Easter Monday' },
                { date: '2026-04-27', name: 'ANZAC Day (obs)' },
                { date: '2026-06-01', name: 'Queen\'s Birthday' },
                { date: '2026-10-26', name: 'Labour Day' },
                { date: '2026-12-25', name: 'Christmas' },
                { date: '2026-12-26', name: 'Boxing Day' }
            ],
            hk: [
                { date: '2026-01-29', name: 'Ëæ≤ÊõÜÊñ∞Âπ¥' },
                { date: '2026-01-30', name: 'Ëæ≤ÊõÜÊñ∞Âπ¥' },
                { date: '2026-01-31', name: 'Ëæ≤ÊõÜÊñ∞Âπ¥' },
                { date: '2026-04-03', name: 'Ê∏ÖÊòéÁØÄ' },
                { date: '2026-04-10', name: 'Good Friday' },
                { date: '2026-04-13', name: 'Easter Monday' },
                { date: '2026-05-01', name: 'ÂãûÂãïÁØÄ' },
                { date: '2026-05-25', name: '‰ΩõË™ï' },
                { date: '2026-06-25', name: 'Á´ØÂçàÁØÄ' },
                { date: '2026-07-01', name: 'È¶ôÊ∏ØÁâπÂçÄÊàêÁ´ãÁ¥ÄÂøµÊó•' },
                { date: '2026-10-01', name: 'ÂúãÊÖ∂Êó•' },
                { date: '2026-10-02', name: '‰∏≠ÁßãÁØÄÁøåÊó•' },
                { date: '2026-10-26', name: 'ÈáçÈôΩÁØÄ' },
                { date: '2026-12-25', name: 'Christmas' },
                { date: '2026-12-26', name: 'Boxing Day' }
            ]
        };

        // Demo photos (base64 encoded 1x1 colored squares for demo)
        const demoPhotos = [
            { 
                url: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><rect fill="%233b82f6" width="400" height="400"/><text x="50%" y="50%" text-anchor="middle" fill="white" font-size="24">2023 Photo</text></svg>',
                filename: 'family_gathering_2023.jpg',
                year: 2023
            },
            {
                url: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><rect fill="%2310b981" width="400" height="400"/><text x="50%" y="50%" text-anchor="middle" fill="white" font-size="24">2022 Photo</text></svg>',
                filename: 'birthday_celebration_2022.jpg',
                year: 2022
            },
            {
                url: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><rect fill="%23f59e0b" width="400" height="400"/><text x="50%" y="50%" text-anchor="middle" fill="white" font-size="24">2021 Photo</text></svg>',
                filename: 'vacation_trip_2021.jpg',
                year: 2021
            }
        ];

        function getCorsProxy(url) {
            if (config.useCorsProxy) {
                return `https://corsproxy.io/?${encodeURIComponent(url)}`;
            }
            return url;
        }

        function loadSavedSettings() {
            const saved = localStorage.getItem('panelConfig');
            if (saved) {
                const savedConfig = JSON.parse(saved);
                Object.assign(config, savedConfig);
            }
            // Migration: older versions stored weatherLocations as strings
            if (Array.isArray(config.weatherLocations) && config.weatherLocations.length && typeof config.weatherLocations[0] === 'string') {
                config.weatherLocations = [
                    { label: 'Auckland', lat: -36.8485, lon: 174.7633 },
                    { label: 'Botany Downs', lat: -36.9167, lon: 174.9110 },
                    { label: 'Hong Kong', lat: 22.3193, lon: 114.1694 }
                ];
            }

            // Ensure at least one news feed is enabled
            if (config.newsFeeds && !config.newsFeeds.demo && !config.newsFeeds.ltn && !config.newsFeeds.scmp && !config.newsFeeds.bbc) {
                config.newsFeeds.demo = true;
            }

            updatePhotoLayout();
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                populateSettingsUI();
            }
        }

        function populateSettingsUI() {
            // APIs (ÂÖ¨Èñã Launch ÁâàÔºöWeather Áî® Open‚ÄëMeteoÔºåÂîîÈúÄË¶Å key)
            const td = document.getElementById('twelveDataKey'); if (td) td.value = config.twelveDataKey || '';
            const fh = document.getElementById('finnhubKey'); if (fh) fh.value = config.finnhubKey || '';
            const prov = document.getElementById('stockApiProvider'); if (prov) prov.value = config.stockApiProvider || 'demo';
            const cors = document.getElementById('useCorsProxy'); if (cors) cors.checked = !!config.useCorsProxy;

            // Stock schedule
            const r1 = document.getElementById('stockRefresh1'); if (r1) r1.value = (config.stockRefreshTimes && config.stockRefreshTimes[0]) ? config.stockRefreshTimes[0] : '07:00';
            const r2 = document.getElementById('stockRefresh2'); if (r2) r2.value = (config.stockRefreshTimes && config.stockRefreshTimes[1]) ? config.stockRefreshTimes[1] : '11:00';

            // Calendar (ÊñπÊ°àA)
            const url = document.getElementById('calendarWebAppUrl'); if (url) url.value = config.calendarWebAppUrl || '';
            const tok = document.getElementById('calendarToken'); if (tok) tok.value = config.calendarToken || '';

            // Calendar toggles
            const cp = document.getElementById('calPersonal'); if (cp) cp.checked = !!config.calendar.personal;
            const cb = document.getElementById('calBirthday'); if (cb) cb.checked = !!config.calendar.birthday;
            const cf = document.getElementById('calFamily'); if (cf) cf.checked = !!config.calendar.family;
            const cg = document.getElementById('calGame'); if (cg) cg.checked = !!config.calendar.game;
            const cn = document.getElementById('calNZ'); if (cn) cn.checked = !!config.calendar.nz;
            const ch = document.getElementById('calHK'); if (ch) ch.checked = !!config.calendar.hk;

            // News
            const nd = document.getElementById('newsDemo'); if (nd) nd.checked = !!config.newsFeeds.demo;
            const nl = document.getElementById('newsLTN'); if (nl) nl.checked = !!config.newsFeeds.ltn;
            const ns = document.getElementById('newsSCMP'); if (ns) ns.checked = !!config.newsFeeds.scmp;
            const nb = document.getElementById('newsBBC'); if (nb) nb.checked = !!config.newsFeeds.bbc;
        }

        function saveSettings() {
            // APIs
            const td = document.getElementById('twelveDataKey'); if (td) config.twelveDataKey = td.value;
            const fh = document.getElementById('finnhubKey'); if (fh) config.finnhubKey = fh.value;
            const prov = document.getElementById('stockApiProvider'); if (prov) config.stockApiProvider = prov.value;
            const cors = document.getElementById('useCorsProxy'); if (cors) config.useCorsProxy = cors.checked;

            // Stock schedule
            const r1 = document.getElementById('stockRefresh1');
            const r2 = document.getElementById('stockRefresh2');
            config.stockRefreshTimes = [
                (r1 && r1.value) ? r1.value : '07:00',
                (r2 && r2.value) ? r2.value : '11:00'
            ];

            // Calendar (ÊñπÊ°àA)
            const url = document.getElementById('calendarWebAppUrl');
            const tok = document.getElementById('calendarToken');
            config.calendarWebAppUrl = (url && url.value) ? url.value.trim() : '';
            config.calendarToken = (tok && tok.value) ? tok.value.trim() : '';

            // Calendar toggles
            const cp = document.getElementById('calPersonal'); if (cp) config.calendar.personal = cp.checked;
            const cb = document.getElementById('calBirthday'); if (cb) config.calendar.birthday = cb.checked;
            const cf = document.getElementById('calFamily'); if (cf) config.calendar.family = cf.checked;
            const cg = document.getElementById('calGame'); if (cg) config.calendar.game = cg.checked;
            const cn = document.getElementById('calNZ'); if (cn) config.calendar.nz = cn.checked;
            const ch = document.getElementById('calHK'); if (ch) config.calendar.hk = ch.checked;

            // News
            const nd = document.getElementById('newsDemo'); if (nd) config.newsFeeds.demo = nd.checked;
            const nl = document.getElementById('newsLTN'); if (nl) config.newsFeeds.ltn = nl.checked;
            const ns = document.getElementById('newsSCMP'); if (ns) config.newsFeeds.scmp = ns.checked;
            const nb = document.getElementById('newsBBC'); if (nb) config.newsFeeds.bbc = nb.checked;

            localStorage.setItem('panelConfig', JSON.stringify(config));
            toggleSettings();
            fetchAllData();
            maybeRefreshStocks(true);
        }

        function updatePhotoLayout() {
            // Launch ÁâàÔºöÂ∑≤ÁßªÈô§Áõ∏ÁâáÂçÄÔºà‰πãÂæåÂÜçÂä†Ôºâ
            return;
        }

        function updatePhotoLayout() {
            const grid = document.getElementById('mainGrid');
            if (config.enablePhotos && window.innerWidth >= 1600) {
                grid.classList.add('with-photos');
            } else {
                grid.classList.remove('with-photos');
            }
        }

        function updateDigitalClock() {
            const now = new Date();
            document.getElementById('digitalClock').innerText = now.toLocaleTimeString('en-GB', { hour12: false });
            document.getElementById('dateStr').innerText = now.toLocaleDateString('zh-HK', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
        }

        function updateAnalogClock() {
            const now = new Date();
            const s = now.getSeconds(), m = now.getMinutes(), h = now.getHours() % 12;
            document.getElementById('secondHand').style.transform = `rotate(${(s / 60) * 360}deg)`;
            document.getElementById('minuteHand').style.transform = `rotate(${((m + s / 60) / 60) * 360}deg)`;
            document.getElementById('hourHand').style.transform = `rotate(${((h + m / 60) / 12) * 360}deg)`;
        }

        // Fetch holidays from Google Calendar
        async function fetchGoogleCalendarHolidays() {
            if (!config.useGoogleCalendar || !config.gcalApiKey) {
                return null;
            }

            try {
                const now = new Date();
                const oneWeekLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                const timeMin = now.toISOString();
                const timeMax = oneWeekLater.toISOString();

                let allEvents = [];

                // Fetch NZ holidays
                if (config.calendar.nz && config.nzCalendarId) {
                    const nzUrl = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(config.nzCalendarId)}/events?key=${config.gcalApiKey}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                    const nzRes = await fetch(getCorsProxy(nzUrl));
                    const nzData = await nzRes.json();
                    if (nzData.items) {
                        nzData.items.forEach(item => {
                            allEvents.push({
                                date: item.start.date || item.start.dateTime.split('T')[0],
                                name: `üá≥üáø ${item.summary}`,
                                type: 'holiday'
                            });
                        });
                    }
                }

                // Fetch HK holidays
                if (config.calendar.hk && config.hkCalendarId) {
                    const hkUrl = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(config.hkCalendarId)}/events?key=${config.gcalApiKey}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                    const hkRes = await fetch(getCorsProxy(hkUrl));
                    const hkData = await hkRes.json();
                    if (hkData.items) {
                        hkData.items.forEach(item => {
                            allEvents.push({
                                date: item.start.date || item.start.dateTime.split('T')[0],
                                name: `üá≠üá∞ ${item.summary}`,
                                type: 'holiday'
                            });
                        });
                    }
                }

                // Fetch personal calendar (birthdays, events)
                if (config.personalCalendarId) {
                    const perUrl = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(config.personalCalendarId)}/events?key=${config.gcalApiKey}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                    const perRes = await fetch(getCorsProxy(perUrl));
                    const perData = await perRes.json();
                    if (perData.items) {
                        perData.items.forEach(item => {
                            let icon = 'üìÖ';
                            if (item.summary.toLowerCase().includes('birthday')) icon = 'üéÇ';
                            if (item.summary.toLowerCase().includes('game')) icon = 'üéÆ';
                            
                            allEvents.push({
                                date: item.start.date || item.start.dateTime.split('T')[0],
                                name: `${icon} ${item.summary}`,
                                type: 'personal'
                            });
                        });
                    }
                }

                return allEvents;
            } catch (error) {
                console.error('Google Calendar error:', error);
                return null;
            }
        }

        async function updateReminders() {
            const now = new Date();
            const oneWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            let reminders = [];

            // Try Google Calendar first
            if (config.useGoogleCalendar) {
                const gcalEvents = await fetchGoogleCalendarHolidays();
                if (gcalEvents) {
                    gcalEvents.forEach(event => {
                        const eventDate = new Date(event.date);
                        if (eventDate >= now && eventDate <= oneWeek) {
                            const daysUntil = Math.ceil((eventDate - now) / (24 * 60 * 60 * 1000));
                            reminders.push({ text: event.name, days: daysUntil, date: event.date });
                        }
                    });
                }
            }

            // Fallback to hardcoded holidays if Google Calendar not used or failed
            if (reminders.length === 0 || !config.useGoogleCalendar) {
                if (config.calendar.nz) {
                    holidays2026.nz.forEach(h => {
                        const eventDate = new Date(h.date);
                        if (eventDate >= now && eventDate <= oneWeek) {
                            const daysUntil = Math.ceil((eventDate - now) / (24 * 60 * 60 * 1000));
                            reminders.push({ text: `üá≥üáø ${h.name}`, days: daysUntil, date: h.date });
                        }
                    });
                }

                if (config.calendar.hk) {
                    holidays2026.hk.forEach(h => {
                        const eventDate = new Date(h.date);
                        if (eventDate >= now && eventDate <= oneWeek) {
                            const daysUntil = Math.ceil((eventDate - now) / (24 * 60 * 60 * 1000));
                            reminders.push({ text: `üá≠üá∞ ${h.name}`, days: daysUntil, date: h.date });
                        }
                    });
                }
            }

            reminders.sort((a, b) => new Date(a.date) - new Date(b.date));

            let html = '';
            if (reminders.length === 0) {
                html = '<div class="text-slate-400 text-center mt-4">No upcoming events</div>';
            } else {
                reminders.forEach(r => {
                    const dayText = r.days === 0 ? 'Today' : r.days === 1 ? 'Tomorrow' : `In ${r.days} days`;
                    html += `<div class="reminder-item">
                        <div class="flex justify-between">
                            <span>${r.text}</span>
                            <span class="text-yellow-400">${dayText}</span>
                        </div>
                    </div>`;
                });
            }

            document.getElementById('upcomingReminders').innerHTML = html;
        }

        // Photo Memories Feature
        async function loadTodayPhotos() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const day = now.getDate();

            if (config.photoSource === 'demo') {
                todayPhotos = demoPhotos;
            } else if (config.photoSource === 'gdrive' && config.gdriveFolderId) {
                // Google Drive implementation would go here
                // For now, use demo
                todayPhotos = demoPhotos;
            } else if (config.photoSource === 'onedrive' && config.onedrivePath) {
                // OneDrive implementation would go here
                // For now, use demo
                todayPhotos = demoPhotos;
            } else {
                todayPhotos = [];
            }

            if (todayPhotos.length > 0) {
                document.getElementById('photoStatus').innerHTML = 
                    `üì∏ Photos: <span class="text-green-400">${todayPhotos.length} found</span>`;
            } else {
                document.getElementById('photoStatus').innerHTML = 
                    `üì∏ Photos: <span class="text-slate-400">None for today</span>`;
            }
        }

        function showNextPhoto() {
            if (todayPhotos.length === 0) return;

            const photo = todayPhotos[currentPhotoIndex];
            const img = document.getElementById('memoryPhoto');
            
            img.classList.remove('photo-fade-in');
            void img.offsetWidth; // Trigger reflow
            img.classList.add('photo-fade-in');
            
            img.src = photo.url;
            document.getElementById('photoFilename').textContent = photo.filename;
            document.getElementById('photoYear').textContent = `Year: ${photo.year}`;

            currentPhotoIndex = (currentPhotoIndex + 1) % todayPhotos.length;
        }

        function initPhotoMemories() {
            if (photoTimer) {
                clearInterval(photoTimer);
                photoTimer = null;
            }

            if (!config.enablePhotos) {
                document.getElementById('photoStatus').innerHTML = 
                    'üì∏ Photos: <span class="text-slate-400">Disabled</span>';
                return;
            }

            loadTodayPhotos().then(() => {
                if (todayPhotos.length > 0) {
                    showNextPhoto();
                    photoTimer = setInterval(showNextPhoto, config.photoInterval);
                }
            });
        }

        async function fetchWeather() {
            if (!config.weatherApiKey) {
                document.getElementById('weatherContainer').innerHTML = '<p class="text-yellow-400">‚ö†Ô∏è No API key</p>';
                return;
            }
            
            let html = '';
            let success = 0;
            
            for (const loc of config.weatherLocations) {
                try {
                    const url = getCorsProxy(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(loc)}&appid=${config.weatherApiKey}&units=metric`);
                    const curr = await fetch(url);
                    
                    if (!curr.ok) throw new Error(`HTTP ${curr.status}`);
                    
                    const currData = await curr.json();
                    
                    html += `
                        <div class="mb-2 pb-2 border-b border-slate-700">
                            <div class="font-semibold">${currData.name}</div>
                            <div class="flex justify-between items-center my-1">
                                <span class="text-2xl font-bold">${Math.round(currData.main.temp)}¬∞C</span>
                                <span class="capitalize">${currData.weather[0].description}</span>
                            </div>
                            <div class="text-xs text-slate-300">
                                Feels: ${Math.round(currData.main.feels_like)}¬∞C | Humidity: ${currData.main.humidity}%
                            </div>
                        </div>
                    `;
                    success++;
                } catch (error) {
                    console.error(`Weather error: ${loc}`, error);
                }
            }
            
            if (success === 0) {
                html = '<p class="text-yellow-400">‚ö†Ô∏è Weather unavailable</p>';
                document.getElementById('weatherStatus').innerHTML = '‚òÅÔ∏è Weather: <span class="text-red-400">Failed</span>';
            } else {
                document.getElementById('weatherStatus').innerHTML = `‚òÅÔ∏è Weather: <span class="text-green-400">${success}/${config.weatherLocations.length}</span>`;
            }
            
            document.getElementById('weatherContainer').innerHTML = html;
        }

        async function fetchStocks() {
            // Load cache once per page load
            if (!stockCache) {
                stockCache = loadStockCache();
            }

            if (config.stockApiProvider === 'demo') {
                displayDemoStocks();
                return;
            }

            // Render cached quotes immediately (fast UI)
            if (stockCache && stockCache.items && stockCache.items.length) {
                renderStocksTicker(stockCache.items, {
                    label: `Cached ${formatTimeAgo(stockCache.updatedAt)}`,
                    provider: stockCache.provider
                });
            }

            // If no cache exists, fetch once on load so the widget is never empty
            if (!stockCache || !stockCache.items || stockCache.items.length === 0) {
                await maybeRefreshStocks(true);
            }
        }

        function formatTimeAgo(isoString) {
            try {
                const then = new Date(isoString);
                const diffMs = Date.now() - then.getTime();
                const mins = Math.round(diffMs / 60000);
                if (mins < 1) return 'just now';
                if (mins < 60) return `${mins}m ago`;
                const hrs = Math.round(mins / 60);
                if (hrs < 24) return `${hrs}h ago`;
                const days = Math.round(hrs / 24);
                return `${days}d ago`;
            } catch {
                return '';
            }
        }

        function renderStocksTicker(items, meta = {}) {
            let ticker = '';
            items.forEach(s => {
                const below = (typeof s.buyPrice === 'number') ? (s.price < s.buyPrice) : false;
                const vsBuy = (typeof s.buyPrice === 'number') ? ((s.price - s.buyPrice) / s.buyPrice * 100) : null;
                const icon = (s.changePct ?? 0) >= 0 ? 'üü¢' : 'üî¥';
                const alert = below ? ' ‚ö†Ô∏è' : '';
                const curr = s.currency ? ` ${s.currency}` : '';
                ticker += `<span class="ticker-item ${below ? 'stock-alert' : ''}"><strong>${s.symbol}</strong>: ${s.price.toFixed(2)}${curr} ${icon} ${(s.changePct ?? 0) >= 0 ? '+' : ''}${(s.changePct ?? 0).toFixed(2)}%`;
                if (typeof s.buyPrice === 'number' && vsBuy !== null) {
                    ticker += ` | Buy: ${s.buyPrice} (${vsBuy >= 0 ? '+' : ''}${vsBuy.toFixed(1)}%)${alert}`;
                }
                ticker += `</span>`;
            });

            document.getElementById('stocksContent').innerHTML = ticker || '<span class="ticker-item">No stock data</span>';
            const label = meta.label ? meta.label : 'Updated';
            const prov = meta.provider ? ` <span class="text-slate-400">(${meta.provider})</span>` : '';
            document.getElementById('stockStatusPanel').innerHTML = `üìà Stocks: <span class="text-green-400">${label}</span>${prov}`;
        }

        function isWithinMinutes(now, targetMinutes, windowMinutes = 5) {
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            return Math.abs(nowMinutes - targetMinutes) <= windowMinutes;
        }

        function timeStringToMinutes(t) {
            const [hh, mm] = (t || '00:00').split(':').map(x => parseInt(x, 10));
            return (hh * 60) + (mm || 0);
        }

        async function maybeRefreshStocks(force = false) {
            if (config.stockApiProvider === 'demo') return;

            const now = new Date();
            const todayKey = now.toISOString().slice(0, 10);
            const times = Array.isArray(config.stockRefreshTimes) ? config.stockRefreshTimes.slice(0, 2) : ['07:00', '11:00'];
            const minutesTargets = times.map(timeStringToMinutes);

            const log = loadStockRefreshLog();

            const eligibleIndex = minutesTargets.findIndex((m, idx) => {
                const marker = `${todayKey}_${times[idx]}`;
                if (log[marker]) return false;
                return isWithinMinutes(now, m, 5);
            });

            if (!force && eligibleIndex === -1) {
                return;
            }

            // Mark UI as updating
            document.getElementById('stockStatusPanel').innerHTML = 'üìà Stocks: <span class="text-yellow-400">Updating...</span>';

            try {
                let items;
                let providerLabel = config.stockApiProvider;

                if (config.stockApiProvider === 'twelvedata') {
                    try {
                        items = await fetchStocksTwelveData();
                        providerLabel = 'Twelve Data';
                    } catch (e) {
                        console.warn('Twelve Data failed, fallback to Finnhub', e);
                        items = await fetchStocksFinnhub();
                        providerLabel = 'Finnhub (fallback)';
                    }
                } else if (config.stockApiProvider === 'finnhub') {
                    try {
                        items = await fetchStocksFinnhub();
                        providerLabel = 'Finnhub';
                    } catch (e) {
                        console.warn('Finnhub failed, fallback to Twelve Data', e);
                        items = await fetchStocksTwelveData();
                        providerLabel = 'Twelve Data (fallback)';
                    }
                } else if (config.stockApiProvider === 'demo') {
                    displayDemoStocks();
                    return;
                } else {
                    throw new Error(`Unknown provider: ${config.stockApiProvider}`);
                }

                if (!items || !items.length) {
                    throw new Error('No quote data returned');
                }

                const cacheObj = { updatedAt: new Date().toISOString(), provider: providerLabel, items };
                stockCache = cacheObj;
                saveStockCache(cacheObj);
                renderStocksTicker(items, { label: 'Updated', provider: providerLabel });

                // Record the schedule marker if we refreshed due to a schedule window
                if (!force && eligibleIndex !== -1) {
                    const marker = `${todayKey}_${times[eligibleIndex]}`;
                    log[marker] = cacheObj.updatedAt;
                    saveStockRefreshLog(log);
                }
            } catch (error) {
                console.error('Stock refresh failed', error);
                if (stockCache && stockCache.items && stockCache.items.length) {
                    renderStocksTicker(stockCache.items, {
                        label: `Cached ${formatTimeAgo(stockCache.updatedAt)} (refresh failed)` ,
                        provider: stockCache.provider
                    });
                } else {
                    document.getElementById('stocksContent').innerHTML = '<span class="ticker-item">Stocks unavailable</span>';
                    document.getElementById('stockStatusPanel').innerHTML = 'üìà Stocks: <span class="text-red-400">Failed</span>';
                }
            }
        }

        async function fetchStocksTwelveData() {
            if (!config.twelveDataKey) throw new Error('Missing Twelve Data API key');

            // Twelve Data Basic (Free) has a low per-minute credit limit (commonly shown as 8/min).
            // /quote consumes ~1 credit per symbol, so with 12 symbols we split into chunks <= 8.
            const maxPerMinute = 8;
            const symbols = config.stocks.map(s => s.symbol);

            async function waitUntilNextMinute() {
                const now = new Date();
                const msToNextMinute = (60 - now.getSeconds()) * 1000 - now.getMilliseconds() + 250;
                await new Promise(r => setTimeout(r, Math.max(250, msToNextMinute)));
            }

            const results = {};
            for (let i = 0; i < symbols.length; i += maxPerMinute) {
                const chunk = symbols.slice(i, i + maxPerMinute);
                const url = getCorsProxy(`https://api.twelvedata.com/quote?symbol=${encodeURIComponent(chunk.join(','))}&apikey=${encodeURIComponent(config.twelveDataKey)}`);
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                // Batch response is typically an object keyed by symbol; single-symbol response is a flat object.
                const bySymbol = (data && data.symbol) ? { [data.symbol]: data } : data;
                for (const sym of chunk) {
                    const r = bySymbol?.[sym];
                    if (r) results[sym] = r;
                }

                // If there are more chunks, wait for credit reset (next minute boundary)
                if (i + maxPerMinute < symbols.length) {
                    await waitUntilNextMinute();
                }
            }

            return config.stocks
                .map(s => {
                    const r = results?.[s.symbol];
                    if (!r || r.status === 'error') return null;
                    const price = Number(r.close ?? r.price ?? r.last ?? r.open);
                    const changePct = Number(r.percent_change ?? r.change_percent ?? r.changePercent ?? 0);
                    if (!Number.isFinite(price)) return null;
                    return {
                        symbol: s.symbol,
                        price,
                        changePct: Number.isFinite(changePct) ? changePct : 0,
                        currency: r.currency || 'USD',
                        buyPrice: typeof s.buyPrice === 'number' ? s.buyPrice : Number(s.buyPrice)
                    };
                })
                .filter(Boolean);
        }

        async function fetchStocksFinnhub() {
            if (!config.finnhubKey) throw new Error('Missing Finnhub API key');

            // Finnhub quote is per symbol. With 12 symbols √ó 2/day, still well within free tier.
            const out = [];
            for (let i = 0; i < config.stocks.length; i++) {
                const s = config.stocks[i];
                const url = getCorsProxy(`https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(s.symbol)}&token=${encodeURIComponent(config.finnhubKey)}`);
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const q = await res.json();
                const price = Number(q?.c);
                const prev = Number(q?.pc);
                if (!Number.isFinite(price)) continue;
                const changePct = (Number.isFinite(prev) && prev !== 0) ? ((price - prev) / prev * 100) : 0;
                out.push({
                    symbol: s.symbol,
                    price,
                    changePct,
                    currency: 'USD',
                    buyPrice: typeof s.buyPrice === 'number' ? s.buyPrice : Number(s.buyPrice)
                });
            }
            return out;
        }

        function displayDemoStocks() {
            const demoData = config.stocks.map(s => ({
                symbol: s.symbol,
                price: s.buyPrice * (1 + (Math.random() * 0.2 - 0.1)),
                change: (Math.random() * 20 - 10),
                changePct: (Math.random() * 5 - 2.5),
                buyPrice: s.buyPrice
            }));
            
            let ticker = '';
            demoData.forEach(s => {
                const below = s.price < s.buyPrice;
                const vsBuy = ((s.price - s.buyPrice) / s.buyPrice * 100).toFixed(1);
                const icon = s.changePct >= 0 ? 'üü¢' : 'üî¥';
                const alert = below ? ' ‚ö†Ô∏è' : '';
                ticker += `<span class="ticker-item"><strong>${s.symbol}</strong>: $${s.price.toFixed(2)} ${icon} ${s.changePct >= 0 ? '+' : ''}${s.changePct.toFixed(1)}% | Buy: $${s.buyPrice} (${vsBuy >= 0 ? '+' : ''}${vsBuy}%)${alert}</span>`;
            });
            
            document.getElementById('stocksContent').innerHTML = ticker;
            document.getElementById('stockStatusPanel').innerHTML = 
                'üìà Stocks: <span class="text-blue-400">Demo Mode</span>';
        }

        async function fetchCurrencies() {
            let html = '';
            let success = 0;
            
            for (const c of config.currencies) {
                try {
                    const [base, quote] = c.pair.split('-');
                    const url = getCorsProxy(`https://api.exchangerate-api.com/v4/latest/${base}`);
                    const res = await fetch(url);
                    
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    
                    const data = await res.json();
                    
                    if (data.rates && data.rates[quote]) {
                        const rate = data.rates[quote];
                        const isAlert = c.below ? rate < c.alert : rate > c.alert;
                        
                        html += `
                            <div class="${isAlert ? 'stock-alert' : 'bg-slate-800/30'} rounded p-2">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">${base}/${quote}</span>
                                    <div class="text-right">
                                        <div class="font-mono font-bold">${rate.toFixed(4)}</div>
                                        ${isAlert ? '<i class="fas fa-bell text-yellow-400 text-xs"></i>' : ''}
                                    </div>
                                </div>
                                <div class="text-xs mt-1 text-slate-400">
                                    Alert: ${c.below ? '<' : '>'} ${c.alert}
                                </div>
                            </div>
                        `;
                        success++;
                    }
                } catch (err) {
                    console.error(`Currency error: ${c.pair}`, err);
                }
            }
            
            if (success > 0) {
                document.getElementById('currencyStatus').innerHTML = `üí± Currency: <span class="text-green-400">${success}/${config.currencies.length}</span>`;
            } else {
                html = '<p class="text-yellow-400">‚ö†Ô∏è Currency unavailable</p>';
                document.getElementById('currencyStatus').innerHTML = 'üí± Currency: <span class="text-red-400">Failed</span>';
            }
            
            document.getElementById('currencyList').innerHTML = html;
        }

        async function fetchRss(url, limit = 12) {
            const res = await fetch(getCorsProxy(url));
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const text = await res.text();
            const doc = new DOMParser().parseFromString(text, 'text/xml');
            const items = Array.from(doc.querySelectorAll('item')).slice(0, limit);
            return items.map(it => {
                const title = (it.querySelector('title')?.textContent || '').trim();
                const link = (it.querySelector('link')?.textContent || '').trim();
                const pubDate = (it.querySelector('pubDate')?.textContent || '').trim();
                return {
                    title,
                    link,
                    pubDate: pubDate ? new Date(pubDate) : null
                };
            }).filter(x => x.title);
        }

        async function fetchNews() {
            // Demo mode remains the fastest / most reliable option for offline testing
            if (config.newsFeeds.demo) {
                const demo = [
                    '[Á§∫ÁØÑ] Ëæ≤ÊõÜÊñ∞Âπ¥Âç≥Â∞á‰æÜËá®ÔºåÈ†êË®àÂ∞áÊúâÂ§ßÈáè‰∫∫ÊµÅÂâçÂæÄÂêÑÂ§ßÊôØÈªû',
                    '[Á§∫ÁØÑ] Êñ∞Ë•øËò≠ÂÆ£Â∏ÉÊñ∞ÁöÑÊ∞£ÂÄôÊîøÁ≠ñÔºåÁõÆÊ®ô2030Âπ¥Ê∏õÊéí50%',
                    '[Á§∫ÁØÑ] È¶ôÊ∏ØËÇ°Â∏Ç‰ªäÊó•‰∏äÊº≤2.3%ÔºåÊÅíÁîüÊåáÊï∏ÂâµÊñ∞È´ò',
                    '[Á§∫ÁØÑ] Êú¨Âú∞ÁßëÊäÄÂÖ¨Âè∏Áç≤Âæó1ÂÑÑÁæéÂÖÉËûçË≥áÔºåË®àÂäÉÊì¥Â±ïÊ•≠Âãô',
                    '[Á§∫ÁØÑ] Â§©Ê∞£È†êÂ†±ÔºöÊú¨ÈÄ±Êú´Â∞áÊúâÂ§ßÈõ®ÔºåÂ∏ÇÊ∞ëË´ãÊ≥®ÊÑèÈò≤ÁØÑ'
                ];
                document.getElementById('newsContent').innerHTML = demo.map(n => `<span class="ticker-item">${n}</span>`).join('');
                document.getElementById('newsStatus').innerHTML = 'üì∞ News: <span class="text-blue-400">Demo Mode</span>';
                return;
            }

            const feeds = [];
            if (config.newsFeeds.ltn) feeds.push({ name: 'LTN', url: 'https://news.ltn.com.tw/rss/all.xml' });
            if (config.newsFeeds.scmp) feeds.push({ name: 'SCMP', url: 'https://www.scmp.com/rss/2/feed' });
            if (config.newsFeeds.bbc) feeds.push({ name: 'BBC', url: 'http://feeds.bbci.co.uk/news/rss.xml' });

            if (feeds.length === 0) {
                document.getElementById('newsContent').innerHTML = '<span class="ticker-item">No news sources enabled</span>';
                document.getElementById('newsStatus').innerHTML = 'üì∞ News: <span class="text-yellow-400">No sources</span>';
                return;
            }

            document.getElementById('newsStatus').innerHTML = 'üì∞ News: <span class="text-yellow-400">Updating...</span>';

            try {
                const all = [];
                for (const f of feeds) {
                    try {
                        const items = await fetchRss(f.url, 10);
                        items.forEach(it => all.push({ ...it, source: f.name }));
                    } catch (e) {
                        console.warn(`News feed failed: ${f.name}`, e);
                    }
                }

                if (!all.length) throw new Error('No news items');

                all.sort((a, b) => (b.pubDate?.getTime() || 0) - (a.pubDate?.getTime() || 0));
                const top = all.slice(0, 20);

                const ticker = top.map(it => {
                    const label = `<span class="text-slate-400">[${it.source}]</span> `;
                    const safeTitle = it.title.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const body = it.link ? `<a href="${it.link}" target="_blank" rel="noopener noreferrer">${safeTitle}</a>` : safeTitle;
                    return `<span class="ticker-item">${label}${body}</span>`;
                }).join('');

                document.getElementById('newsContent').innerHTML = ticker;
                document.getElementById('newsStatus').innerHTML = `üì∞ News: <span class="text-green-400">${top.length} items</span> <span class="text-slate-400">(${feeds.map(f => f.name).join(', ')})</span>`;
            } catch (error) {
                console.error('News fetch failed', error);
                document.getElementById('newsContent').innerHTML = '<span class="ticker-item">‚ö†Ô∏è News unavailable</span>';
                document.getElementById('newsStatus').innerHTML = 'üì∞ News: <span class="text-red-400">Failed</span>';
            }
        }

        function fetchBibleVerse() {
            const verses = [
                { ref: 'Á¥ÑÁø∞Á¶èÈü≥ 3:16', text: 'Á•ûÊÑõ‰∏ñ‰∫∫ÔºåÁîöËá≥Â∞á‰ªñÁöÑÁç®ÁîüÂ≠êË≥úÁµ¶‰ªñÂÄëÔºåÂè´‰∏ÄÂàá‰ø°‰ªñÁöÑÔºå‰∏çËá≥ÊªÖ‰∫°ÔºåÂèçÂæóÊ∞∏Áîü„ÄÇ' },
                { ref: 'Ë©©ÁØá 23:1', text: 'ËÄ∂ÂíåËèØÊòØÊàëÁöÑÁâßËÄÖÔºåÊàëÂøÖ‰∏çËá¥Áº∫‰πè„ÄÇ' },
                { ref: 'ÁÆ¥Ë®Ä 3:5-6', text: '‰Ω†Ë¶ÅÂ∞àÂøÉ‰ª∞Ë≥¥ËÄ∂ÂíåËèØÔºå‰∏çÂèØÂÄöÈù†Ëá™Â∑±ÁöÑËÅ∞ÊòéÔºåÂú®‰Ω†‰∏ÄÂàáÊâÄË°åÁöÑ‰∫ã‰∏äÈÉΩË¶ÅË™çÂÆö‰ªñÔºå‰ªñÂøÖÊåáÂºï‰Ω†ÁöÑË∑Ø„ÄÇ' },
                { ref: 'ËÖìÁ´ãÊØîÊõ∏ 4:13', text: 'ÊàëÈù†ËëóÈÇ£Âä†Áµ¶ÊàëÂäõÈáèÁöÑÔºåÂá°‰∫ãÈÉΩËÉΩÂÅö„ÄÇ' },
                { ref: 'ÁæÖÈ¶¨Êõ∏ 8:28', text: 'ÊàëÂÄëÊõâÂæóËê¨‰∫ãÈÉΩ‰∫íÁõ∏ÊïàÂäõÔºåÂè´ÊÑõÁ•ûÁöÑ‰∫∫ÂæóÁõäËôïÔºåÂ∞±ÊòØÊåâ‰ªñÊó®ÊÑèË¢´Âè¨ÁöÑ‰∫∫„ÄÇ' }
            ];
            
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const verse = verses[dayOfYear % verses.length];
            
            document.getElementById('bibleVerse').innerHTML = `
                <div class="text-slate-300 leading-relaxed">${verse.text}</div>
                <div class="text-xs text-blue-300 font-semibold text-right mt-2">‚Äî ${verse.ref}</div>
            `;
        }

        function fetchCalendar() {
            const now = new Date();
            const day = now.getDay();
            let events = [];
            
            const schedule = {
                0: [{ title: '‰∏ªÊó•Â¥áÊãú', time: '10:00 AM' }],
                3: [{ title: 'Êü•Á∂ìÁè≠', time: '7:30 PM' }]
            };
            
            if (schedule[day] && config.calendar.personal) {
                schedule[day].forEach(e => events.push({ day: 'Today', ...e }));
            }
            
            let html = '';
            if (events.length === 0) {
                html = '<p class="text-slate-400">No events today</p>';
            } else {
                events.forEach(e => {
                    html += `
                        <div class="calendar-event">
                            <div class="flex justify-between items-start">
                                <span class="font-semibold text-blue-300">${e.day}</span>
                                <span class="text-slate-400">${e.time}</span>
                            </div>
                            <div>${e.title}</div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('calendarContainer').innerHTML = html;
        }

        function fetchAllData() {
            fetchWeather();
            fetchCurrencies();
            fetchNews();
            fetchAlerts();
            fetchBibleVerse();
            fetchCalendar();
            updateReminders();
            fetchStocks();
        }

        // -----------------------------
        // YouTube Players (Music + Video)
        // -----------------------------
        let ytMusicPlayer = null;
        let ytVideoPlayer = null;
        let ytApiLoading = false;

        function loadYouTubeIframeApiOnce() {
            if (window.YT && window.YT.Player) return;
            if (ytApiLoading) return;
            ytApiLoading = true;
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            document.head.appendChild(tag);
        }

        function createYtPlayer(elId, playlistId) {
            return new YT.Player(elId, {
                width: '100%',
                height: '100%',
                playerVars: {
                    playsinline: 1,
                    rel: 0,
                    modestbranding: 1,
                    controls: 1,
                    listType: 'playlist',
                    list: playlistId,
                    loop: 1
                },
                events: {
                    onReady: (e) => {
                        try { e.target.setVolume(Number(config.ytVolume) || 80); } catch {}
                        // Cue only (no autoplay) to satisfy kiosk/browser policies.
                        try { e.target.cuePlaylist({ listType: 'playlist', list: playlistId }); }
                        catch { try { e.target.cuePlaylist(playlistId); } catch {} }
                        try { e.target.setShuffle(true); } catch {}
                    }
                }
            });
        }

        // YouTube iframe API callback
        window.onYouTubeIframeAPIReady = function () {
            try {
                ytMusicPlayer = createYtPlayer('ytMusicPlayer', config.ytMusicPlaylistId);
            } catch (e) {
                console.warn('YT music player init failed', e);
            }
            try {
                ytVideoPlayer = createYtPlayer('ytVideoPlayer', config.ytVideoPlaylistId);
            } catch (e) {
                console.warn('YT video player init failed', e);
            }
        };

        function safeTogglePlay(player) {
            if (!player) return;
            try {
                const st = player.getPlayerState();
                if (st === YT.PlayerState.PLAYING) player.pauseVideo();
                else player.playVideo();
            } catch {
                try { player.playVideo(); } catch {}
            }
        }

        function safeStop(player) {
            if (!player) return;
            try { player.stopVideo(); } catch {}
            try { player.seekTo(0, true); } catch {}
        }

        function reshuffleAndReload(player, playlistId) {
            if (!player) return;
            try { player.cuePlaylist({ listType: 'playlist', list: playlistId }); }
            catch { try { player.cuePlaylist(playlistId); } catch {} }
            setTimeout(() => {
                try { player.setShuffle(true); } catch {}
                try {
                    const pl = player.getPlaylist ? player.getPlaylist() : null;
                    const len = Array.isArray(pl) ? pl.length : 0;
                    const idx = len ? Math.floor(Math.random() * len) : 0;
                    player.playVideoAt(idx);
                } catch {
                    try { player.playVideo(); } catch {}
                }
            }, 250);
        }

        function initYouTubeUI() {
            // Toggle video section visibility
            const section = document.getElementById('videoPlayerSection');
            const btn = document.getElementById('toggleVideoSectionBtn');
            const shouldShow = !!config.ytShowVideo || (window.innerWidth >= 1600 && window.matchMedia('(orientation: landscape)').matches);
            if (shouldShow) {
                section.classList.remove('hidden');
                btn.textContent = 'Èö±ËóèÂΩ±Áâá';
            }
            btn.addEventListener('click', () => {
                const isHidden = section.classList.contains('hidden');
                section.classList.toggle('hidden');
                btn.textContent = isHidden ? 'Èö±ËóèÂΩ±Áâá' : 'È°ØÁ§∫ÂΩ±Áâá';
                config.ytShowVideo = isHidden;
                try { localStorage.setItem('panelConfig', JSON.stringify(config)); } catch {}
            });

            // Music controls
            document.getElementById('musicPrev').addEventListener('click', () => { try { ytMusicPlayer?.previousVideo(); } catch {} });
            document.getElementById('musicPlay').addEventListener('click', () => safeTogglePlay(ytMusicPlayer));
            document.getElementById('musicStop').addEventListener('click', () => safeStop(ytMusicPlayer));
            document.getElementById('musicNext').addEventListener('click', () => { try { ytMusicPlayer?.nextVideo(); } catch {} });
            document.getElementById('musicReshuffle').addEventListener('click', () => reshuffleAndReload(ytMusicPlayer, config.ytMusicPlaylistId));

            // Video controls
            document.getElementById('videoPrev').addEventListener('click', () => { try { ytVideoPlayer?.previousVideo(); } catch {} });
            document.getElementById('videoPlay').addEventListener('click', () => safeTogglePlay(ytVideoPlayer));
            document.getElementById('videoStop').addEventListener('click', () => safeStop(ytVideoPlayer));
            document.getElementById('videoNext').addEventListener('click', () => { try { ytVideoPlayer?.nextVideo(); } catch {} });
            document.getElementById('videoReshuffle').addEventListener('click', () => reshuffleAndReload(ytVideoPlayer, config.ytVideoPlaylistId));

            loadYouTubeIframeApiOnce();
        }

                // -----------------------------
        // Launch v4 overrides (GitHub-friendly)
        // - Weather: Open-Meteo (no key), 30-min refresh, +1/+4/+12/+ÊòéÊó• (Èõ®/UV)
        // - Reminders: demo (birthdays/game) + hardcoded holidays (NZ/HK) now; later can switch to Calendar WebApp (ÊñπÊ°àA)
        // - Alerts ticker: MetService + HKO (optional; may require proxy depending on CORS)
        // -----------------------------

        function safeNum(v) {
            const n = Number(v);
            return Number.isFinite(n) ? (Math.round(n * 10) / 10) : null;
        }

        function weatherCodeToText(code) {
            const m = {
                0: 'Êô¥Êúó',
                1: 'Â§ßËá¥Êô¥Êúó',
                2: 'ÈÉ®ÂàÜÂ§öÈõ≤',
                3: 'Â§öÈõ≤',
                45: 'Èúß',
                48: 'ÈúßÂáá',
                51: 'ÊØõÊØõÈõ®',
                53: 'ÊØõÊØõÈõ®',
                55: 'ÊØõÊØõÈõ®',
                61: 'Â∞èÈõ®',
                63: '‰∏≠Èõ®',
                65: 'Â§ßÈõ®',
                71: 'Â∞èÈõ™',
                73: '‰∏≠Èõ™',
                75: 'Â§ßÈõ™',
                80: 'Èô£Èõ®',
                81: 'Èô£Èõ®',
                82: 'Âº∑Èô£Èõ®',
                95: 'Èõ∑Êö¥',
                96: 'Èõ∑Êö¥ÂÜ∞Èõπ',
                99: 'Èõ∑Êö¥ÂÜ∞Èõπ'
            };
            return m[code] || ('WeatherCode ' + code);
        }

        async function fetchWeather() {
            const now = new Date();
            const parts = [];

            for (const loc of (config.weatherLocations || [])) {
                try {
                    const base = 'https://api.open-meteo.com/v1/forecast';
                    const url = base +
                        '?latitude=' + encodeURIComponent(loc.lat) +
                        '&longitude=' + encodeURIComponent(loc.lon) +
                        '&current=temperature_2m,weather_code' +
                        '&hourly=temperature_2m,precipitation,precipitation_probability,uv_index,weather_code' +
                        '&daily=uv_index_max,precipitation_sum' +
                        '&forecast_days=2&timezone=auto';

                    const resp = await fetch(url, { cache: 'no-store' });
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    const data = await resp.json();

                    const times = (data.hourly.time || []).map(t => new Date(t));
                    let idx = 0;
                    for (let i = 0; i < times.length; i++) {
                        if (times[i] <= now) idx = i;
                        else break;
                    }

                    const currentTemp = Math.round(data.current.temperature_2m);
                    const desc = weatherCodeToText(data.current.weather_code);

                    const uvNow = safeNum((data.hourly.uv_index || [])[idx]);
                    const uvTomorrowMax = safeNum((data.daily.uv_index_max || [])[1]);
                    const rainTomorrow = safeNum((data.daily.precipitation_sum || [])[1]);

                    const fmt = (d) => d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const pick = (off) => {
                        const j = Math.min(idx + off, times.length - 1);
                        const t = times[j] ? fmt(times[j]) : ('+' + off + 'h');
                        const p = safeNum((data.hourly.precipitation_probability || [])[j]);
                        const mm = safeNum((data.hourly.precipitation || [])[j]);
                        const pStr = (p === null) ? '?' : (Math.round(p) + '%');
                        const mmStr = (mm === null) ? '?' : (mm + 'mm');
                        return t + ':' + pStr + '/' + mmStr;
                    };

                    const line1 = 'UV: ' + (uvNow === null ? '?' : uvNow) + (uvTomorrowMax === null ? '' : 'ÔºàÊòéÊó•ÊúÄÈ´ò:' + uvTomorrowMax + 'Ôºâ');
                    const line2 = 'Èõ®: +1h ' + pick(1) + ', +4h ' + pick(4) + ', +12h ' + pick(12) + ', ÊòéÊó•' + (rainTomorrow === null ? '?' : rainTomorrow) + 'mm';

                    parts.push(
                        '<div class="weather-location">' +
                            '<div class="flex justify-between items-start">' +
                                '<div>' +
                                    '<div class="text-sm font-semibold">' + escapeHtml(loc.label) + '</div>' +
                                    '<div class="text-2xl font-bold">' + currentTemp + '¬∞C</div>' +
                                '</div>' +
                                '<div class="text-right">' +
                                    '<div class="text-xs text-slate-400">' + escapeHtml(desc) + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="text-xs text-slate-300 mt-1">‚òÄÔ∏è ' + escapeHtml(line1) + '</div>' +
                            '<div class="text-xs text-slate-300">üíß ' + escapeHtml(line2) + '</div>' +
                        '</div>'
                    );
                } catch (e) {
                    console.warn('Weather failed for', loc && loc.label, e);
                    parts.push(
                        '<div class="weather-location">' +
                            '<div class="text-sm font-semibold">' + escapeHtml((loc && loc.label) || 'Weather') + '</div>' +
                            '<div class="text-xs text-red-300">‚ö†Ô∏è Weather unavailable</div>' +
                        '</div>'
                    );
                }
            }

            const wc = document.getElementById('weatherContainer');
            if (wc) wc.innerHTML = parts.join('');
            const ws = document.getElementById('weatherStatus');
            if (ws) ws.innerHTML = '<i class="fas fa-cloud-sun mr-1"></i>Weather: <span class="text-green-400">Updated</span>';
        }

        // Alerts ticker (ÈáçË¶ÅÂø´Ë®äÔºöÊÉ°Âä£Â§©Ê∞£/Ë≠¶Â†±)
        async function fetchAlerts() {
            const out = [];

            // HKO warnings (tc)
            try {
                const url = 'https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=warnsum&lang=tc';
                const resp = await fetch(url, { cache: 'no-store' });
                if (resp.ok) {
                    const data = await resp.json();
                    if (data && data.details && Array.isArray(data.details) && data.details.length) {
                        data.details.forEach(d => {
                            const name = d.warningStatement || d.warningName || d.type || 'È¶ôÊ∏ØÂ§©Ê∞£Ë≠¶Âëä';
                            out.push({ source: 'HKO', text: name });
                        });
                    }
                }
            } catch (e) {
                console.warn('HKO warnsum failed', e);
            }

            // MetService severe weather (CAP RSS) - may need CORS proxy depending on browser
            try {
                const rss = 'https://alerts.metservice.com/cap/rss';
                const resp = await fetch(getCorsProxy(rss), { cache: 'no-store' });
                if (resp.ok) {
                    const xml = await resp.text();
                    const items = parseRssTitles(xml).slice(0, 6);
                    items.forEach(t => out.push({ source: 'MetService', text: t }));
                }
            } catch (e) {
                console.warn('MetService alerts failed', e);
            }

            const el = document.getElementById('alertsContent');
            if (!el) return;

            if (!out.length) {
                el.innerHTML = '<span class="ticker-item">ÔºàÊú™ËÉΩÂèñÂæóË≠¶Â†±ÔºõÂ¶ÇË¶ÅÁî® MetService RSSÔºåÂèØËÉΩÈúÄË¶ÅÈñãÂïü CORS ProxyÔºèËá™Âª∫ proxyÔºâ</span>';
                return;
            }

            const html = out.map(it => {
                const label = '<span class="text-yellow-300">[' + it.source + ']</span> ';
                return '<span class="ticker-item">' + label + escapeHtml(it.text) + '</span>';
            }).join('');

            el.innerHTML = html;
        }

        function parseRssTitles(xmlText) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xmlText, 'text/xml');
                const items = Array.from(doc.querySelectorAll('item > title'));
                return items.map(n => (n.textContent || '').trim()).filter(Boolean);
            } catch {
                return [];
            }
        }

        // Reminders override (Launch): demo birthdays/game + hardcoded holidays (NZ/HK)
        async function updateReminders() {
            const now = new Date();
            const oneWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const reminders = [];

            // Demo birthday/game (replace later with Calendar WebApp)
            const demoBirthdays = [
                { date: '2026-01-25', name: 'üéÇ John\'s Birthday' },
                { date: '2026-02-14', name: 'üéÇ Valentine\'s Birthday' }
            ];
            const demoGames = [
                { date: '2026-01-22', name: 'üéÆ Game Night @ 20:00' },
                { date: '2026-01-29', name: 'üéÆ Game Night @ 20:00' }
            ];

            if (config.calendar && config.calendar.birthday) {
                demoBirthdays.forEach(e => {
                    const d = new Date(e.date);
                    if (d >= now && d <= oneWeek) reminders.push({ text: e.name, date: e.date });
                });
            }
            if (config.calendar && config.calendar.game) {
                demoGames.forEach(e => {
                    const d = new Date(e.date);
                    if (d >= now && d <= oneWeek) reminders.push({ text: e.name, date: e.date });
                });
            }

            // Holidays (hardcoded fallback already present)
            if (config.calendar && config.calendar.nz && typeof holidays2026 !== 'undefined' && holidays2026.nz) {
                holidays2026.nz.forEach(h => {
                    const d = new Date(h.date);
                    if (d >= now && d <= oneWeek) reminders.push({ text: 'üá≥üáø ' + h.name, date: h.date });
                });
            }
            if (config.calendar && config.calendar.hk && typeof holidays2026 !== 'undefined' && holidays2026.hk) {
                holidays2026.hk.forEach(h => {
                    const d = new Date(h.date);
                    if (d >= now && d <= oneWeek) reminders.push({ text: 'üá≠üá∞ ' + h.name, date: h.date });
                });
            }

            reminders.sort((a, b) => new Date(a.date) - new Date(b.date));

            const box = document.getElementById('upcomingReminders');
            if (!box) return;

            if (!reminders.length) {
                box.innerHTML = '<div class="text-slate-400 text-center mt-4">No upcoming events</div>';
                return;
            }

            box.innerHTML = reminders.map(r => {
                const d = new Date(r.date);
                const daysUntil = Math.ceil((d - now) / (24 * 60 * 60 * 1000));
                const dayText = daysUntil === 0 ? 'Today' : (daysUntil === 1 ? 'Tomorrow' : ('In ' + daysUntil + ' days'));
                return '<div class="reminder-item"><div class="flex justify-between"><span>' + escapeHtml(r.text) + '</span><span class="text-yellow-400">' + dayText + '</span></div></div>';
            }).join('');
        }



function init() {
            loadSavedSettings();
            populateSettingsUI();
            updateDigitalClock();
            updateAnalogClock();
            initYouTubeUI();
            fetchAllData();
            // LaunchÁâàÔºöÁõ∏ÁâáÂäüËÉΩÊö´ÊôÇÁßªÈô§
            setInterval(() => {
                updateDigitalClock();
                updateAnalogClock();
            }, 1000);
            
            setInterval(updateReminders, 3600000);
            setInterval(fetchWeather, 1800000);
            setInterval(fetchCurrencies, 1800000);
            setInterval(fetchNews, 1800000);
            setInterval(fetchAlerts, 1800000);

            // Stocks: check schedule every 5 minutes, but only fetch near the configured times (max 2x/day)
            setInterval(() => maybeRefreshStocks(false), 300000);
            maybeRefreshStocks(false);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>

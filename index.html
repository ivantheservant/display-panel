<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Display Panel - Hybrid API Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            color: #f8fafc; 
            font-family: 'Segoe UI', 'Microsoft JhengHei', 'PMingLiU', Tahoma, sans-serif; 
            overflow: hidden; 
            margin: 0;
            padding: 0;
        }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .card { 
            border-radius: 1.5rem; 
            padding: 1.5rem; 
            height: 100%; 
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.5);
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 1rem;
            height: 100vh;
            padding: 1rem;
        }
        
        /* Analog Clock */
        .clock-face {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle, #1e293b, #0f172a);
            border: 3px solid rgba(148, 163, 184, 0.3);
            position: relative;
        }
        .clock-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            background: #94a3b8;
            border-radius: 6px;
        }
        .hour-hand { width: 4px; height: 35px; background: #f1f5f9; margin-left: -2px; }
        .minute-hand { width: 3px; height: 45px; background: #cbd5e1; margin-left: -1.5px; }
        .second-hand { width: 2px; height: 50px; background: #ef4444; margin-left: -1px; }
        .clock-center {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        /* News Ticker - Scrolling */
        .news-ticker {
            width: 100%;
            overflow: hidden;
            background: rgba(15, 23, 42, 0.5);
            padding: 0.75rem 0;
            border-radius: 0.5rem;
        }
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            animation: scroll-left 90s linear infinite;
            padding-left: 100%;
        }
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .ticker-item {
            display: inline-block;
            margin-right: 3rem;
            padding: 0 1rem;
        }
        .ticker-item::before {
            content: 'â—';
            color: #3b82f6;
            margin-right: 0.5rem;
        }
        
        /* Stock Alert Animation */
        @keyframes alert-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .stock-alert {
            animation: alert-pulse 1.5s ease-in-out infinite;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        .currency-alert {
            animation: alert-pulse 1.5s ease-in-out infinite;
            background: rgba(234, 179, 8, 0.2);
            border: 1px solid rgba(234, 179, 8, 0.5);
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.5);
            border-radius: 10px;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            padding: 2rem;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }
        .settings-panel.open {
            right: 0;
        }
        
        /* Bible Verse Styling */
        .bible-verse {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        /* Calendar Event */
        .calendar-event {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        @media (max-width: 1024px) {
            .grid-container { 
                grid-template-columns: repeat(2, 1fr); 
                overflow-y: auto; 
                height: auto; 
            }
        }
        
        /* TV Optimization */
        @media (min-width: 1920px) {
            body { font-size: 1.1rem; }
            .text-6xl { font-size: 5rem; }
            .text-4xl { font-size: 3rem; }
        }
    </style>
</head>
<body>

    <!-- Settings Button -->
    <button onclick="toggleSettings()" class="fixed top-4 right-4 z-50 p-3 glass rounded-full hover:bg-blue-600 transition-all">
        <i class="fas fa-cog text-xl"></i>
    </button>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel custom-scrollbar">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Settings</h2>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-6">
            <!-- API Keys -->
            <div>
                <h3 class="text-lg font-semibold mb-3 text-blue-400">API Keys</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm mb-1">Weather API (OpenWeatherMap)</label>
                        <input type="text" id="weatherApiKey" value="4d4ff0180678e887714547a90289db00"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 focus:border-blue-500 outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-sm mb-1">News API (NewsAPI.org)</label>
                        <input type="text" id="newsApiKey" value="b222ee4b852643c7aed146a5949b6901"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 focus:border-blue-500 outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Stock API - Hybrid Mode</label>
                        <div class="p-3 bg-blue-900/20 border border-blue-700 rounded text-xs space-y-2">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-green-400 mt-0.5"></i>
                                <div>
                                    <div class="font-semibold text-blue-300">Primary: Yahoo Finance</div>
                                    <div class="text-slate-300">Unlimited, real-time, no key needed</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-shield-alt text-yellow-400 mt-0.5"></i>
                                <div>
                                    <div class="font-semibold text-blue-300">Backup: Alpha Vantage</div>
                                    <div class="text-slate-300">Reliable fallback if Yahoo fails</div>
                                </div>
                            </div>
                        </div>
                        <input type="text" id="stockApiKey" value="E75P2ENCSCY63FGJ" placeholder="Alpha Vantage API Key (backup)"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 focus:border-blue-500 outline-none text-sm mt-2">
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Google Calendar ID (optional)</label>
                        <input type="text" id="calendarId" value="ivantheservant@gmail.com" placeholder="your-email@gmail.com"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 focus:border-blue-500 outline-none text-sm">
                        <p class="text-xs text-slate-400 mt-1">Calendar must be public or use API key</p>
                    </div>
                </div>
            </div>
            
            <!-- Refresh Settings -->
            <div>
                <h3 class="text-lg font-semibold mb-3 text-blue-400">Refresh Intervals</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center">
                        <span>Weather</span>
                        <select id="weatherRefresh" class="p-2 bg-slate-800 rounded border border-slate-700">
                            <option value="1800000">30 min</option>
                            <option value="3600000" selected>60 min</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>News</span>
                        <select id="newsRefresh" class="p-2 bg-slate-800 rounded border border-slate-700">
                            <option value="1800000" selected>30 min</option>
                            <option value="3600000">60 min</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Stocks (Hybrid)</span>
                        <select id="stockRefresh" class="p-2 bg-slate-800 rounded border border-slate-700">
                            <option value="1800000" selected>30 min</option>
                            <option value="3600000">60 min</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Currency</span>
                        <select id="currencyRefresh" class="p-2 bg-slate-800 rounded border border-slate-700">
                            <option value="3600000" selected>60 min</option>
                            <option value="7200000">120 min</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Calendar</span>
                        <select id="calendarRefresh" class="p-2 bg-slate-800 rounded border border-slate-700">
                            <option value="1800000" selected>30 min</option>
                            <option value="3600000">60 min</option>
                        </select>
                    </div>
                </div>
                <p class="text-xs text-slate-400 mt-2">All intervals optimized for free API tiers</p>
            </div>
            
            <button onclick="saveSettings()" class="w-full p-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-all">
                Save & Apply Settings
            </button>
        </div>
    </div>

    <div class="grid-container" id="mainGrid">
        <!-- Clock & Date (spans 2 columns) -->
        <div class="glass card col-span-2">
            <div class="flex items-center justify-between gap-4">
                <!-- Digital Clock -->
                <div class="flex-1">
                    <div id="digitalClock" class="text-6xl font-bold tracking-tight">00:00:00</div>
                    <div id="dateStr" class="text-xl text-slate-400 mt-2">Loading...</div>
                </div>
                <!-- Analog Clock -->
                <div class="clock-face">
                    <div class="clock-hand hour-hand" id="hourHand"></div>
                    <div class="clock-hand minute-hand" id="minuteHand"></div>
                    <div class="clock-hand second-hand" id="secondHand"></div>
                    <div class="clock-center"></div>
                </div>
            </div>
        </div>

        <!-- Weather Multi-location -->
        <div class="glass card col-span-2">
            <h3 class="text-lg font-semibold mb-3"><i class="fas fa-cloud-sun mr-2"></i>Weather</h3>
            <div id="weatherContainer" class="grid grid-cols-3 gap-2 flex-1">
                <div class="flex items-center justify-center"><div class="loading"></div></div>
            </div>
        </div>

        <!-- Daily Bible Verse -->
        <div class="glass card col-span-2">
            <h3 class="text-lg font-semibold mb-3"><i class="fas fa-book-bible mr-2"></i>ä»Šæ—¥é‡‘å¥ Daily Verse</h3>
            <div id="bibleVerse" class="bible-verse flex-1 overflow-y-auto custom-scrollbar">
                <div class="loading mx-auto"></div>
            </div>
        </div>

        <!-- Google Calendar -->
        <div class="glass card col-span-2">
            <h3 class="text-lg font-semibold mb-3"><i class="fas fa-calendar-alt mr-2"></i>Schedule (Today & Tomorrow)</h3>
            <div id="calendarContainer" class="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                <p class="text-sm text-slate-400">Configuring calendar events...</p>
            </div>
        </div>

        <!-- Stocks with Purchase Price & Alerts -->
        <div class="glass card col-span-2 row-span-2">
            <h3 class="text-lg font-semibold mb-3">
                <i class="fas fa-chart-line mr-2"></i>My Stocks 
                <span class="text-xs text-slate-400">(è²·å…¥åƒ¹ tracking)</span>
            </h3>
            <div id="stocksList" class="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                <div class="flex items-center justify-center h-full">
                    <div class="loading"></div>
                </div>
            </div>
            <div id="stockStatus" class="text-xs text-slate-400 mt-2 text-center"></div>
        </div>

        <!-- Currency with Alerts -->
        <div class="glass card col-span-2">
            <h3 class="text-lg font-semibold mb-3">
                <i class="fas fa-exchange-alt mr-2"></i>Currencies
                <span class="text-xs text-slate-400">(Alert thresholds)</span>
            </h3>
            <div id="currencyList" class="space-y-3 flex-1">
                <div class="flex items-center justify-center h-full">
                    <div class="loading"></div>
                </div>
            </div>
        </div>

        <!-- News Scrolling Ticker (spans full width at bottom) -->
        <div class="glass card col-span-4" style="grid-row: 4;">
            <h3 class="text-lg font-semibold mb-3">
                <i class="fas fa-newspaper mr-2"></i>Breaking News (HK â€¢ NZ â€¢ World â€¢ ä¸­åœ‹ â€¢ å°ç£)
            </h3>
            <div class="news-ticker">
                <div class="ticker-content" id="tickerContent">
                    <span class="ticker-item">Loading news from all regions...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration with your settings
        const config = {
            weatherApiKey: '4d4ff0180678e887714547a90289db00',
            newsApiKey: 'b222ee4b852643c7aed146a5949b6901',
            stockApiKey: 'E75P2ENCSCY63FGJ', // Alpha Vantage backup
            calendarId: 'ivantheservant@gmail.com',
            
            // Weather locations
            weatherLocations: ['Auckland,NZ', 'Botany Downs,NZ', 'Hong Kong,HK'],
            
            // Stocks with purchase prices - CORRECTED SYMBOLS
            stocks: [
                { symbol: 'AAPL', buyPrice: 613 },
                { symbol: 'AVAV', buyPrice: 240 },
                { symbol: 'DXYZ', buyPrice: 57.38 },
                { symbol: 'GOOG', buyPrice: 337 },
                { symbol: 'ISRG', buyPrice: 479 },
                { symbol: 'RBLX', buyPrice: 117.53 },
                { symbol: 'RNMBY', buyPrice: 408.32 },
                { symbol: 'TEM', buyPrice: 70.55 },
                { symbol: 'TSLA', buyPrice: 390.42 },
                { symbol: 'TSM', buyPrice: 234.81 },
                { symbol: 'PLTR', buyPrice: 126.32 },
                { symbol: 'NVDA', buyPrice: 143.63 }
            ],
            
            // Currency alerts
            currencies: [
                { pair: 'NZD-USD', alert: 0.55, below: true },
                { pair: 'NZD-HKD', alert: 4.5, below: true }
            ],
            
            // Refresh intervals (optimized for free tiers)
            refreshIntervals: {
                weather: 3600000, // 60 min
                news: 1800000, // 30 min
                stocks: 1800000, // 30 min (hybrid mode)
                currency: 3600000, // 60 min
                calendar: 1800000, // 30 min
                bible: 86400000 // 24 hours
            }
        };

        // Store previous day data for comparison
        let previousData = {
            stocks: {},
            currencies: {}
        };

        // News cache (12 hours retention)
        let newsCache = {
            items: [],
            timestamp: 0
        };

        // Timers
        let refreshTimers = {};

        // Load saved data
        function loadSavedData() {
            const saved = localStorage.getItem('displayPanelData');
            if (saved) {
                const data = JSON.parse(saved);
                previousData = data.previousData || previousData;
                newsCache = data.newsCache || newsCache;
            }
        }

        // Save data
        function saveData() {
            localStorage.setItem('displayPanelData', JSON.stringify({
                previousData,
                newsCache,
                timestamp: Date.now()
            }));
        }

        // Toggle settings
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
        }

        // Save settings
        function saveSettings() {
            config.weatherApiKey = document.getElementById('weatherApiKey').value;
            config.newsApiKey = document.getElementById('newsApiKey').value;
            config.stockApiKey = document.getElementById('stockApiKey').value;
            config.calendarId = document.getElementById('calendarId').value;
            
            config.refreshIntervals.weather = parseInt(document.getElementById('weatherRefresh').value);
            config.refreshIntervals.news = parseInt(document.getElementById('newsRefresh').value);
            config.refreshIntervals.stocks = parseInt(document.getElementById('stockRefresh').value);
            config.refreshIntervals.currency = parseInt(document.getElementById('currencyRefresh').value);
            config.refreshIntervals.calendar = parseInt(document.getElementById('calendarRefresh').value);
            
            localStorage.setItem('displayPanelConfig', JSON.stringify(config));
            toggleSettings();
            
            // Restart timers
            clearAllTimers();
            fetchAllData();
            startAllTimers();
        }

        // Update digital clock
        function updateDigitalClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
            const dateStr = now.toLocaleDateString('zh-HK', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('digitalClock').innerText = timeStr;
            document.getElementById('dateStr').innerText = dateStr;
        }

        // Update analog clock
        function updateAnalogClock() {
            const now = new Date();
            const seconds = now.getSeconds();
            const minutes = now.getMinutes();
            const hours = now.getHours() % 12;
            
            const secondDeg = (seconds / 60) * 360;
            const minuteDeg = ((minutes + seconds / 60) / 60) * 360;
            const hourDeg = ((hours + minutes / 60) / 12) * 360;
            
            document.getElementById('secondHand').style.transform = `rotate(${secondDeg}deg)`;
            document.getElementById('minuteHand').style.transform = `rotate(${minuteDeg}deg)`;
            document.getElementById('hourHand').style.transform = `rotate(${hourDeg}deg)`;
        }

        // Fetch multi-location weather
        async function fetchWeather() {
            if (!config.weatherApiKey) return;
            
            let html = '';
            
            for (const location of config.weatherLocations) {
                try {
                    const response = await fetch(
                        `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(location)}&appid=${config.weatherApiKey}&units=metric`
                    );
                    const data = await response.json();
                    
                    if (data.cod === 200) {
                        const cityName = data.name;
                        const temp = Math.round(data.main.temp);
                        const icon = getWeatherIcon(data.weather[0].icon);
                        const desc = data.weather[0].description;
                        
                        html += `
                            <div class="bg-slate-800/30 rounded-lg p-3 text-center">
                                <div class="text-sm text-slate-400 mb-1">${cityName}</div>
                                <i class="${icon} text-2xl mb-2"></i>
                                <div class="text-3xl font-bold">${temp}Â°C</div>
                                <div class="text-xs text-slate-300 capitalize mt-1">${desc}</div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error(`Weather error for ${location}:`, error);
                }
            }
            
            document.getElementById('weatherContainer').innerHTML = html || '<p class="text-red-400 col-span-3">Weather data unavailable</p>';
        }

        // Get weather icon
        function getWeatherIcon(iconCode) {
            const iconMap = {
                '01d': 'fas fa-sun text-yellow-400',
                '01n': 'fas fa-moon text-blue-300',
                '02d': 'fas fa-cloud-sun text-yellow-400',
                '02n': 'fas fa-cloud-moon text-blue-300',
                '03d': 'fas fa-cloud text-slate-400',
                '03n': 'fas fa-cloud text-slate-400',
                '04d': 'fas fa-cloud text-slate-500',
                '04n': 'fas fa-cloud text-slate-500',
                '09d': 'fas fa-cloud-showers-heavy text-blue-400',
                '09n': 'fas fa-cloud-showers-heavy text-blue-400',
                '10d': 'fas fa-cloud-rain text-blue-500',
                '10n': 'fas fa-cloud-rain text-blue-500',
                '11d': 'fas fa-bolt text-yellow-300',
                '11n': 'fas fa-bolt text-yellow-300',
                '13d': 'fas fa-snowflake text-blue-200',
                '13n': 'fas fa-snowflake text-blue-200',
                '50d': 'fas fa-smog text-slate-400',
                '50n': 'fas fa-smog text-slate-400'
            };
            return iconMap[iconCode] || 'fas fa-cloud text-slate-400';
        }

        // HYBRID STOCK FETCHING - Yahoo first, Alpha Vantage backup
        async function fetchStocks() {
            if (!config.stocks || config.stocks.length === 0) return;
            
            document.getElementById('stockStatus').innerText = 'ğŸ”„ Fetching stock data...';
            
            // Try Yahoo Finance first
            try {
                await fetchStocksYahoo();
                document.getElementById('stockStatus').innerText = 'âœ… Using Yahoo Finance (real-time)';
                return;
            } catch (error) {
                console.log('Yahoo Finance failed, trying Alpha Vantage backup...', error);
                document.getElementById('stockStatus').innerText = 'ğŸ”„ Yahoo failed, using Alpha Vantage backup...';
                
                // Fallback to Alpha Vantage
                if (config.stockApiKey) {
                    await fetchStocksAlphaVantage();
                } else {
                    throw new Error('No backup API key configured');
                }
            }
        }

        // Yahoo Finance implementation
        async function fetchStocksYahoo() {
            const symbols = config.stocks.map(s => s.symbol).join(',');
            
            const response = await fetch(
                `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols}`
            );
            
            if (!response.ok) {
                throw new Error(`Yahoo Finance HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!data.quoteResponse || !data.quoteResponse.results || data.quoteResponse.results.length === 0) {
                throw new Error('No data from Yahoo Finance');
            }
            
            displayStocks(data.quoteResponse.results, 'yahoo');
        }

        // Alpha Vantage implementation (slower, sequential)
        async function fetchStocksAlphaVantage() {
            let results = [];
            
            for (const stock of config.stocks) {
                try {
                    const response = await fetch(
                        `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${stock.symbol}&apikey=${config.stockApiKey}`
                    );
                    const data = await response.json();
                    
                    if (data['Global Quote'] && data['Global Quote']['05. price']) {
                        const quote = data['Global Quote'];
                        results.push({
                            symbol: stock.symbol,
                            regularMarketPrice: parseFloat(quote['05. price']),
                            regularMarketChange: parseFloat(quote['09. change']),
                            regularMarketChangePercent: parseFloat(quote['10. change percent'].replace('%', ''))
                        });
                    }
                    
                    // Delay to respect Alpha Vantage rate limits
                    if (config.stocks.indexOf(stock) < config.stocks.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 13000)); // 13 sec between calls
                    }
                } catch (error) {
                    console.error(`Alpha Vantage error for ${stock.symbol}:`, error);
                }
            }
            
            if (results.length > 0) {
                displayStocks(results, 'alphavantage');
                document.getElementById('stockStatus').innerText = `âœ… Using Alpha Vantage (${results.length}/${config.stocks.length} stocks)`;
            } else {
                throw new Error('No data from Alpha Vantage');
            }
        }

        // Display stocks (works for both APIs)
        function displayStocks(results, source) {
            let html = '<div class="space-y-2">';
            
            results.forEach(quote => {
                const stockConfig = config.stocks.find(s => s.symbol === quote.symbol);
                if (!stockConfig) return;
                
                const currentPrice = quote.regularMarketPrice || 0;
                const change = quote.regularMarketChange || 0;
                const changePercent = quote.regularMarketChangePercent || 0;
                
                // Check if below buy price
                const isBelowBuyPrice = currentPrice < stockConfig.buyPrice;
                const priceVsBuy = ((currentPrice - stockConfig.buyPrice) / stockConfig.buyPrice * 100).toFixed(2);
                
                // Compare with previous day
                const prevPrice = previousData.stocks[quote.symbol] || currentPrice;
                const dayChange = currentPrice - prevPrice;
                const dayChangePercent = ((dayChange / prevPrice) * 100).toFixed(2);
                
                // Store current price
                previousData.stocks[quote.symbol] = currentPrice;
                
                const alertClass = isBelowBuyPrice ? 'stock-alert' : 'bg-slate-800/30';
                const changeColor = change >= 0 ? 'text-green-400' : 'text-red-400';
                const dayChangeColor = dayChange >= 0 ? 'text-green-400' : 'text-red-400';
                const priceVsBuyColor = priceVsBuy >= 0 ? 'text-green-400' : 'text-red-400';
                
                html += `
                    <div class="${alertClass} rounded-lg p-3 transition-all">
                        <div class="flex justify-between items-start mb-1">
                            <div>
                                <span class="font-bold text-lg">${quote.symbol}</span>
                                ${isBelowBuyPrice ? '<i class="fas fa-exclamation-triangle text-red-400 ml-2" title="Below buy price!"></i>' : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold">$${currentPrice.toFixed(2)}</div>
                                <div class="${changeColor} text-sm">${change >= 0 ? '+' : ''}${changePercent.toFixed(2)}%</div>
                            </div>
                        </div>
                        <div class="flex justify-between text-xs text-slate-400">
                            <div>Buy: $${stockConfig.buyPrice}</div>
                            <div class="${priceVsBuyColor}">${priceVsBuy >= 0 ? '+' : ''}${priceVsBuy}% vs buy</div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span class="text-slate-400">vs Yesterday:</span>
                            <span class="${dayChangeColor}">${dayChange >= 0 ? '+' : ''}${dayChange.toFixed(2)} (${dayChangePercent}%)</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('stocksList').innerHTML = html;
            saveData();
        }

        // Fetch currencies with alerts
        async function fetchCurrencies() {
            let html = '<div class="space-y-3">';
            
            for (const curr of config.currencies) {
                try {
                    const [base, quote] = curr.pair.split('-');
                    const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${base}`);
                    const data = await response.json();
                    
                    if (data.rates && data.rates[quote]) {
                        const currentRate = data.rates[quote];
                        
                        // Check alert condition
                        const isAlert = curr.below ? currentRate < curr.alert : currentRate > curr.alert;
                        
                        // Compare with previous day
                        const prevRate = previousData.currencies[curr.pair] || currentRate;
                        const dayChange = currentRate - prevRate;
                        const dayChangePercent = ((dayChange / prevRate) * 100).toFixed(2);
                        
                        // Store current rate
                        previousData.currencies[curr.pair] = currentRate;
                        
                        const alertClass = isAlert ? 'currency-alert' : 'bg-slate-800/30';
                        const dayChangeColor = dayChange >= 0 ? 'text-green-400' : 'text-red-400';
                        
                        html += `
                            <div class="${alertClass} rounded-lg p-3">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-semibold">${base} / ${quote}</span>
                                    <div class="text-right">
                                        <div class="font-mono text-lg font-bold">${currentRate.toFixed(4)}</div>
                                        ${isAlert ? '<i class="fas fa-bell text-yellow-400 text-sm ml-2" title="Alert threshold reached!"></i>' : ''}
                                    </div>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="text-slate-400">Alert: ${curr.below ? '<' : '>'} ${curr.alert}</span>
                                    <span class="${dayChangeColor}">vs Yesterday: ${dayChange >= 0 ? '+' : ''}${dayChange.toFixed(4)} (${dayChangePercent}%)</span>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error(`Currency error for ${curr.pair}:`, error);
                }
            }
            
            html += '</div>';
            document.getElementById('currencyList').innerHTML = html;
            saveData();
        }

        // Fetch news from ALL regions and mix them together
        async function fetchNews() {
            if (!config.newsApiKey) {
                document.getElementById('tickerContent').innerHTML = 
                    '<span class="ticker-item">âš ï¸ Add News API key in Settings to view news</span>';
                return;
            }
            
            // Check if cache is still valid (12 hours)
            const now = Date.now();
            if (newsCache.timestamp && (now - newsCache.timestamp) < 43200000 && newsCache.items.length > 0) {
                updateNewsTicker();
                return;
            }
            
            const queries = [
                { name: 'HK', query: 'Hong Kong OR é¦™æ¸¯' },
                { name: 'NZ', query: 'New Zealand OR Auckland' },
                { name: 'World', query: 'United States OR Europe OR breaking' },
                { name: 'China', query: 'ä¸­åœ‹ OR China Beijing' },
                { name: 'Taiwan', query: 'å°ç£ OR Taiwan' }
            ];
            
            let allNews = [];
            
            // Fetch from all regions
            for (const region of queries) {
                try {
                    const response = await fetch(
                        `https://newsapi.org/v2/everything?q=${encodeURIComponent(region.query)}&sortBy=publishedAt&pageSize=5&language=en&apiKey=${config.newsApiKey}`
                    );
                    const data = await response.json();
                    
                    if (data.status === 'ok' && data.articles && data.articles.length > 0) {
                        data.articles.forEach(article => {
                            allNews.push({
                                title: `[${region.name}] ${article.title}`,
                                region: region.name
                            });
                        });
                    }
                } catch (error) {
                    console.error(`News fetch error for ${region.name}:`, error);
                }
                
                // Small delay between API calls
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Shuffle news to mix regions
            allNews = allNews.sort(() => Math.random() - 0.5);
            
            if (allNews.length > 0) {
                newsCache = {
                    items: allNews.map(n => n.title),
                    timestamp: now
                };
                saveData();
                updateNewsTicker();
            } else {
                document.getElementById('tickerContent').innerHTML = 
                    '<span class="ticker-item">âš ï¸ No news available. Check API key (may have hit 100/day limit)</span>';
            }
        }

        // Update news ticker display
        function updateNewsTicker() {
            if (!newsCache.items || newsCache.items.length === 0) {
                return;
            }
            
            let tickerHTML = '';
            newsCache.items.forEach(title => {
                tickerHTML += `<span class="ticker-item">${title}</span>`;
            });
            
            document.getElementById('tickerContent').innerHTML = tickerHTML;
        }

        // Fetch daily Bible verse
        async function fetchBibleVerse() {
            const verses = [
                { ref: 'ç´„ç¿°ç¦éŸ³ 3:16', text: 'ç¥æ„›ä¸–äººï¼Œç”šè‡³å°‡ä»–çš„ç¨ç”Ÿå­è³œçµ¦ä»–å€‘ï¼Œå«ä¸€åˆ‡ä¿¡ä»–çš„ï¼Œä¸è‡³æ»…äº¡ï¼Œåå¾—æ°¸ç”Ÿã€‚' },
                { ref: 'è©©ç¯‡ 23:1', text: 'è€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚' },
                { ref: 'ç®´è¨€ 3:5-6', text: 'ä½ è¦å°ˆå¿ƒä»°è³´è€¶å’Œè¯ï¼Œä¸å¯å€šé è‡ªå·±çš„è°æ˜ï¼Œåœ¨ä½ ä¸€åˆ‡æ‰€è¡Œçš„äº‹ä¸Šéƒ½è¦èªå®šä»–ï¼Œä»–å¿…æŒ‡å¼•ä½ çš„è·¯ã€‚' },
                { ref: 'è…“ç«‹æ¯”æ›¸ 4:13', text: 'æˆ‘é è‘—é‚£åŠ çµ¦æˆ‘åŠ›é‡çš„ï¼Œå‡¡äº‹éƒ½èƒ½åšã€‚' },
                { ref: 'ç¾…é¦¬æ›¸ 8:28', text: 'æˆ‘å€‘æ›‰å¾—è¬äº‹éƒ½äº’ç›¸æ•ˆåŠ›ï¼Œå«æ„›ç¥çš„äººå¾—ç›Šè™•ï¼Œå°±æ˜¯æŒ‰ä»–æ—¨æ„è¢«å¬çš„äººã€‚' },
                { ref: 'é¦¬å¤ªç¦éŸ³ 11:28', text: 'å‡¡å‹è‹¦æ“”é‡æ“”çš„äººå¯ä»¥åˆ°æˆ‘é€™è£¡ä¾†ï¼Œæˆ‘å°±ä½¿ä½ å€‘å¾—å®‰æ¯ã€‚' },
                { ref: 'ä»¥è³½äºæ›¸ 40:31', text: 'ä½†é‚£ç­‰å€™è€¶å’Œè¯çš„å¿…é‡æ–°å¾—åŠ›ã€‚ä»–å€‘å¿…å¦‚é·¹å±•ç¿…ä¸Šé¨°ï¼›ä»–å€‘å¥”è·‘å»ä¸å›°å€¦ï¼Œè¡Œèµ°å»ä¸ç–²ä¹ã€‚' },
                { ref: 'è€¶åˆ©ç±³æ›¸ 29:11', text: 'è€¶å’Œè¯èªªï¼šæˆ‘çŸ¥é“æˆ‘å‘ä½ å€‘æ‰€æ‡·çš„æ„å¿µæ˜¯è³œå¹³å®‰çš„æ„å¿µï¼Œä¸æ˜¯é™ç½ç¦çš„æ„å¿µï¼Œè¦å«ä½ å€‘æœ«å¾Œæœ‰æŒ‡æœ›ã€‚' },
                { ref: 'è©©ç¯‡ 46:1', text: 'ç¥æ˜¯æˆ‘å€‘çš„é¿é›£æ‰€ï¼Œæ˜¯æˆ‘å€‘çš„åŠ›é‡ï¼Œæ˜¯æˆ‘å€‘åœ¨æ‚£é›£ä¸­éš¨æ™‚çš„å¹«åŠ©ã€‚' },
                { ref: 'å½¼å¾—å‰æ›¸ 5:7', text: 'ä½ å€‘è¦å°‡ä¸€åˆ‡çš„æ†‚æ…®å¸çµ¦ç¥ï¼Œå› ç‚ºä»–é¡§å¿µä½ å€‘ã€‚' }
            ];
            
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const verse = verses[dayOfYear % verses.length];
            
            document.getElementById('bibleVerse').innerHTML = `
                <div class="mb-2 text-slate-300 leading-relaxed">${verse.text}</div>
                <div class="text-sm text-blue-300 font-semibold text-right">â€” ${verse.ref}</div>
            `;
        }

        // Fetch Google Calendar events (placeholder)
        async function fetchCalendar() {
            const now = new Date();
            const day = now.getDay();
            
            let events = [];
            
            // Regular weekly schedule
            const schedule = {
                0: [{ title: 'ä¸»æ—¥å´‡æ‹œ Sunday Service', time: '10:00 AM' }],
                3: [{ title: 'æŸ¥ç¶“ç­ Bible Study', time: '7:30 PM' }]
            };
            
            // Today's events
            if (schedule[day]) {
                schedule[day].forEach(event => {
                    events.push({ ...event, day: 'Today' });
                });
            }
            
            // Tomorrow's events
            const tomorrow = (day + 1) % 7;
            if (schedule[tomorrow]) {
                schedule[tomorrow].forEach(event => {
                    events.push({ ...event, day: 'Tomorrow' });
                });
            }
            
            // Display
            let html = '';
            if (events.length === 0) {
                html = '<p class="text-sm text-slate-400">No scheduled events today or tomorrow</p>';
            } else {
                events.forEach(event => {
                    html += `
                        <div class="calendar-event">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-semibold text-blue-300">${event.day}</span>
                                <span class="text-xs text-slate-400">${event.time}</span>
                            </div>
                            <p class="text-sm">${event.title}</p>
                        </div>
                    `;
                });
            }
            
            document.getElementById('calendarContainer').innerHTML = html;
        }

        // Fetch all data
        function fetchAllData() {
            fetchWeather();
            fetchNews();
            fetchStocks();
            fetchCurrencies();
            fetchBibleVerse();
            fetchCalendar();
        }

        // Start all timers
        function startAllTimers() {
            refreshTimers.weather = setInterval(fetchWeather, config.refreshIntervals.weather);
            refreshTimers.news = setInterval(fetchNews, config.refreshIntervals.news);
            refreshTimers.stocks = setInterval(fetchStocks, config.refreshIntervals.stocks);
            refreshTimers.currency = setInterval(fetchCurrencies, config.refreshIntervals.currency);
            refreshTimers.calendar = setInterval(fetchCalendar, config.refreshIntervals.calendar);
            refreshTimers.bible = setInterval(fetchBibleVerse, config.refreshIntervals.bible);
        }

        // Clear all timers
        function clearAllTimers() {
            Object.values(refreshTimers).forEach(timer => clearInterval(timer));
            refreshTimers = {};
        }

        // Initialize
        function init() {
            loadSavedData();
            updateDigitalClock();
            updateAnalogClock();
            fetchAllData();
            startAllTimers();
            
            // Update clocks every second
            setInterval(() => {
                updateDigitalClock();
                updateAnalogClock();
            }, 1000);
            
            // Clean old news cache
            setInterval(() => {
                const now = Date.now();
                if (newsCache.timestamp && now - newsCache.timestamp > 43200000) {
                    newsCache = { items: [], timestamp: 0 };
                    saveData();
                }
            }, 3600000);
        }

        // Start when page loads
        window.addEventListener('load', init);

        // Prevent screen sleep
        let wakeLock = null;
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').then(lock => {
                wakeLock = lock;
                console.log('Screen Wake Lock active');
            }).catch(err => {
                console.log('Wake Lock error:', err);
            });
        }

        // Save data before unload
        window.addEventListener('beforeunload', saveData);
    </script>
</body>
</html>

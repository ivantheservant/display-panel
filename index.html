<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Panel - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            color: #f8fafc; 
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            overflow: hidden;
            margin: 0; padding: 0;
        }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .card { 
            border-radius: 1rem; 
            padding: 1rem; 
            height: 100%; 
            display: flex;
            flex-direction: column;
        }
        
        /* Landscape-optimized Grid */
        .grid-container {
            display: grid;
            gap: 0.75rem;
            height: 100vh;
            padding: 0.75rem;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
        }
        
        /* Portrait fallback */
        @media (orientation: portrait) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: auto;
            }
        }
        
        /* Small screens */
        @media (max-width: 768px) {
            .grid-container {
                gap: 0.5rem;
                padding: 0.5rem;
            }
            .card { padding: 0.5rem; font-size: 0.75rem; }
        }
        
        /* Clock */
        .clock-face {
            width: 100px; height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, #1e293b, #0f172a);
            border: 2px solid rgba(148, 163, 184, 0.3);
            position: relative;
        }
        .clock-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            border-radius: 6px;
        }
        .hour-hand { width: 3px; height: 30px; background: #f1f5f9; margin-left: -1.5px; }
        .minute-hand { width: 2px; height: 40px; background: #cbd5e1; margin-left: -1px; }
        .second-hand { width: 1px; height: 42px; background: #ef4444; margin-left: -0.5px; }
        .clock-center {
            position: absolute;
            width: 6px; height: 6px;
            background: #ef4444;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        /* Tickers */
        .ticker {
            width: 100%;
            overflow: hidden;
            background: rgba(15, 23, 42, 0.5);
            padding: 0.75rem 0;
            border-radius: 0.5rem;
        }
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
        }
        .news-ticker-content { animation: scroll-left 100s linear infinite; }
        .stock-ticker-content { animation: scroll-left 80s linear infinite; }
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .ticker-item {
            display: inline-block;
            margin-right: 3rem;
            padding: 0 0.5rem;
            font-size: 1rem;
        }
        .ticker-item::before {
            content: 'â—';
            color: #3b82f6;
            margin-right: 0.75rem;
        }
        
        /* Alerts */
        @keyframes alert-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .stock-alert {
            animation: alert-pulse 1.5s ease-in-out infinite;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        
        /* Settings */
        .settings-panel {
            position: fixed;
            top: 0; right: -450px;
            width: 450px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }
        .settings-panel.open { right: 0; }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 10px; }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Bible & Calendar */
        .bible-verse {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            border-left: 3px solid #3b82f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .calendar-event {
            background: rgba(59, 130, 246, 0.1);
            border-left: 2px solid #3b82f6;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        .reminder-item {
            background: rgba(234, 179, 8, 0.1);
            border-left: 2px solid #eab308;
            padding: 0.4rem;
            border-radius: 0.5rem;
            margin-top: 0.3rem;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>

    <!-- Settings Button -->
    <button onclick="toggleSettings()" class="fixed top-3 right-3 z-50 p-2 glass rounded-full hover:bg-blue-600 transition-all">
        <i class="fas fa-cog text-lg"></i>
    </button>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel custom-scrollbar">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Settings</h2>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-4 text-sm">
            <!-- API Keys -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">API Keys</h3>
                <div class="space-y-2">
                    <div>
                        <label class="block text-xs mb-1">Weather (OpenWeatherMap)</label>
                        <input type="text" id="weatherApiKey" value="4d4ff0180678e887714547a90289db00"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Stocks API Selection</label>
                        <select id="stockApiProvider" class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                            <option value="alphavantage">Alpha Vantage</option>
                            <option value="yahoo">Yahoo Finance (Backup)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Alpha Vantage Key</label>
                        <input type="text" id="stockApiKey" value="E75P2ENCSCY63FGJ"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                        <p class="text-xs text-slate-400 mt-1">Refreshes: 2x/day (US market mid & close)</p>
                    </div>
                </div>
            </div>
            
            <!-- News Sources -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">News Sources (Traditional Chinese)</h3>
                <div class="space-y-1">
                    <label class="flex items-center">
                        <input type="checkbox" id="newsHKET" checked class="mr-2">
                        <span>é¦™æ¸¯ç¶“æ¿Ÿæ—¥å ± (HKET)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="newsSCMP" checked class="mr-2">
                        <span>South China Morning Post</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="newsBBC" checked class="mr-2">
                        <span>BBC News</span>
                    </label>
                </div>
            </div>
            
            <!-- Calendar Toggles -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">Calendar Display</h3>
                <div class="space-y-1">
                    <label class="flex items-center">
                        <input type="checkbox" id="calPersonal" checked class="mr-2">
                        <span>Personal Events</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calBirthday" checked class="mr-2">
                        <span>Birthdays (1 week reminder)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calFamily" checked class="mr-2">
                        <span>Family Events</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calGame" checked class="mr-2">
                        <span>Game Events (1 week reminder)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calNZ" checked class="mr-2">
                        <span>NZ Holidays (1 week reminder)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="calHK" checked class="mr-2">
                        <span>HK Holidays (1 week reminder)</span>
                    </label>
                </div>
            </div>
            
            <!-- Stock Refresh Times -->
            <div>
                <h3 class="font-semibold mb-2 text-blue-400">Stock Refresh Schedule</h3>
                <div class="space-y-2">
                    <div>
                        <label class="block text-xs mb-1">US Market Mid-point (EST)</label>
                        <input type="time" id="stockRefreshMid" value="13:00"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                    <div>
                        <label class="block text-xs mb-1">US Market Close (EST)</label>
                        <input type="time" id="stockRefreshClose" value="17:00"
                            class="w-full p-2 bg-slate-800 rounded border border-slate-700 text-xs">
                    </div>
                </div>
            </div>
            
            <button onclick="saveSettings()" class="w-full p-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">
                Save & Apply
            </button>
        </div>
    </div>

    <div class="grid-container" id="mainGrid">
        <!-- Clock, Date & Reminders (Combined) -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <div class="flex items-center justify-between gap-3 mb-2">
                <div class="flex-1">
                    <div id="digitalClock" class="text-4xl font-bold">00:00:00</div>
                    <div id="dateStr" class="text-sm text-slate-400 mt-1">Loading...</div>
                </div>
                <div class="clock-face">
                    <div class="clock-hand hour-hand" id="hourHand"></div>
                    <div class="clock-hand minute-hand" id="minuteHand"></div>
                    <div class="clock-hand second-hand" id="secondHand"></div>
                    <div class="clock-center"></div>
                </div>
            </div>
            <div id="upcomingReminders" class="flex-1 overflow-y-auto custom-scrollbar text-xs">
                <!-- Reminders will be inserted here -->
            </div>
        </div>

        <!-- Weather Compact -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-cloud-sun mr-1"></i>Weather</h3>
            <div id="weatherContainer" class="flex-1 overflow-y-auto custom-scrollbar text-xs">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Bible Verse -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-book-bible mr-1"></i>ä»Šæ—¥é‡‘å¥</h3>
            <div id="bibleVerse" class="bible-verse flex-1 overflow-y-auto custom-scrollbar">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-calendar-alt mr-1"></i>Schedule</h3>
            <div id="calendarContainer" class="flex-1 overflow-y-auto custom-scrollbar text-xs space-y-1">
                <p class="text-slate-400">Loading...</p>
            </div>
        </div>

        <!-- Currencies -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <h3 class="text-sm font-semibold mb-2">
                <i class="fas fa-exchange-alt mr-1"></i>Currencies
            </h3>
            <div id="currencyList" class="space-y-2 flex-1 text-xs">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Placeholder for balance -->
        <div class="glass card" style="grid-column: span 2; grid-row: span 2;">
            <h3 class="text-sm font-semibold mb-2"><i class="fas fa-info-circle mr-1"></i>Status</h3>
            <div id="systemStatus" class="text-xs space-y-1 text-slate-300">
                <div>â° Clock: <span class="text-green-400">Running</span></div>
                <div id="weatherStatus">â˜ï¸ Weather: <span class="text-yellow-400">Updating...</span></div>
                <div id="stockStatusPanel">ğŸ“ˆ Stocks: <span class="text-yellow-400">Updating...</span></div>
                <div id="newsStatus">ğŸ“° News: <span class="text-yellow-400">Updating...</span></div>
            </div>
        </div>

        <!-- News Ticker (Larger, bottom) -->
        <div class="glass card" style="grid-column: span 6; grid-row: 5;">
            <h3 class="text-sm font-semibold mb-2">
                <i class="fas fa-newspaper mr-1"></i>Breaking News (ç¹é«”ä¸­æ–‡)
            </h3>
            <div class="ticker">
                <div class="ticker-content news-ticker-content" id="newsContent">
                    <span class="ticker-item">Loading news feeds...</span>
                </div>
            </div>
        </div>

        <!-- Stocks Ticker (Larger, bottom) -->
        <div class="glass card" style="grid-column: span 6; grid-row: 6;">
            <h3 class="text-sm font-semibold mb-2">
                <i class="fas fa-chart-line mr-1"></i>My Stocks (è²·å…¥åƒ¹å°æ¯”)
            </h3>
            <div class="ticker">
                <div class="ticker-content stock-ticker-content" id="stocksContent">
                    <span class="ticker-item">Loading stocks...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            weatherApiKey: '4d4ff0180678e887714547a90289db00',
            stockApiKey: 'E75P2ENCSCY63FGJ',
            stockApiProvider: 'alphavantage', // or 'yahoo'
            weatherLocations: ['Auckland,NZ', 'Botany Downs,NZ', 'Hong Kong,HK'],
            stocks: [
                { symbol: 'AAPL', buyPrice: 613 },
                { symbol: 'AVAV', buyPrice: 240 },
                { symbol: 'DXYZ', buyPrice: 57.38 },
                { symbol: 'GOOG', buyPrice: 337 },
                { symbol: 'ISRG', buyPrice: 479 },
                { symbol: 'RBLX', buyPrice: 117.53 },
                { symbol: 'RNMBY', buyPrice: 408.32 },
                { symbol: 'TEM', buyPrice: 70.55 },
                { symbol: 'TSLA', buyPrice: 390.42 },
                { symbol: 'TSM', buyPrice: 234.81 },
                { symbol: 'PLTR', buyPrice: 126.32 },
                { symbol: 'NVDA', buyPrice: 143.63 }
            ],
            currencies: [
                { pair: 'NZD-USD', alert: 0.55, below: true },
                { pair: 'NZD-HKD', alert: 4.5, below: true }
            ],
            calendar: {
                personal: true,
                birthday: true,
                family: true,
                game: true,
                nz: true,
                hk: true
            },
            stockRefreshTimes: {
                mid: '13:00', // 1pm EST (US market mid)
                close: '17:00' // 5pm EST (US market close)
            },
            newsFeeds: {
                hket: true,
                scmp: true,
                bbc: true
            }
        };

        let stockCache = [];
        let lastStockUpdate = null;

        // Holidays 2026
        const holidays2026 = {
            nz: [
                { date: '2026-01-26', name: 'Auckland Anniversary' },
                { date: '2026-02-06', name: 'Waitangi Day' },
                { date: '2026-04-10', name: 'Good Friday' },
                { date: '2026-04-13', name: 'Easter Monday' },
                { date: '2026-04-27', name: 'ANZAC Day (obs)' },
                { date: '2026-06-01', name: 'Queen\'s Birthday' },
                { date: '2026-10-26', name: 'Labour Day' },
                { date: '2026-12-25', name: 'Christmas' },
                { date: '2026-12-26', name: 'Boxing Day' }
            ],
            hk: [
                { date: '2026-01-29', name: 'è¾²æ›†æ–°å¹´' },
                { date: '2026-01-30', name: 'è¾²æ›†æ–°å¹´' },
                { date: '2026-01-31', name: 'è¾²æ›†æ–°å¹´' },
                { date: '2026-04-03', name: 'æ¸…æ˜ç¯€' },
                { date: '2026-04-10', name: 'Good Friday' },
                { date: '2026-04-11', name: 'Easter Saturday' },
                { date: '2026-04-13', name: 'Easter Monday' },
                { date: '2026-05-01', name: 'å‹å‹•ç¯€' },
                { date: '2026-05-25', name: 'ä½›èª•' },
                { date: '2026-06-25', name: 'ç«¯åˆç¯€' },
                { date: '2026-07-01', name: 'é¦™æ¸¯ç‰¹å€æˆç«‹ç´€å¿µæ—¥' },
                { date: '2026-10-01', name: 'åœ‹æ…¶æ—¥' },
                { date: '2026-10-02', name: 'ä¸­ç§‹ç¯€ç¿Œæ—¥' },
                { date: '2026-10-26', name: 'é‡é™½ç¯€' },
                { date: '2026-12-25', name: 'Christmas' },
                { date: '2026-12-26', name: 'Boxing Day' }
            ]
        };

        // Sample birthdays and game events (replace with your actual data)
        const birthdays = [
            { date: '2026-01-25', name: 'John\'s Birthday' },
            { date: '2026-02-14', name: 'Mary\'s Birthday' }
        ];

        const gameEvents = [
            { date: '2026-01-22', time: '20:00', name: 'Game Night' },
            { date: '2026-01-29', time: '19:30', name: 'Raid Event' }
        ];

        function loadSavedSettings() {
            const saved = localStorage.getItem('panelConfig');
            if (saved) {
                const savedConfig = JSON.parse(saved);
                Object.assign(config, savedConfig);
            }
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
        }

        function saveSettings() {
            config.weatherApiKey = document.getElementById('weatherApiKey').value;
            config.stockApiKey = document.getElementById('stockApiKey').value;
            config.stockApiProvider = document.getElementById('stockApiProvider').value;
            config.calendar.personal = document.getElementById('calPersonal').checked;
            config.calendar.birthday = document.getElementById('calBirthday').checked;
            config.calendar.family = document.getElementById('calFamily').checked;
            config.calendar.game = document.getElementById('calGame').checked;
            config.calendar.nz = document.getElementById('calNZ').checked;
            config.calendar.hk = document.getElementById('calHK').checked;
            config.newsFeeds.hket = document.getElementById('newsHKET').checked;
            config.newsFeeds.scmp = document.getElementById('newsSCMP').checked;
            config.newsFeeds.bbc = document.getElementById('newsBBC').checked;
            config.stockRefreshTimes.mid = document.getElementById('stockRefreshMid').value;
            config.stockRefreshTimes.close = document.getElementById('stockRefreshClose').value;
            
            localStorage.setItem('panelConfig', JSON.stringify(config));
            toggleSettings();
            fetchAllData();
        }

        function updateDigitalClock() {
            const now = new Date();
            document.getElementById('digitalClock').innerText = now.toLocaleTimeString('en-GB', { hour12: false });
            document.getElementById('dateStr').innerText = now.toLocaleDateString('zh-HK', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
        }

        function updateAnalogClock() {
            const now = new Date();
            const s = now.getSeconds(), m = now.getMinutes(), h = now.getHours() % 12;
            document.getElementById('secondHand').style.transform = `rotate(${(s / 60) * 360}deg)`;
            document.getElementById('minuteHand').style.transform = `rotate(${((m + s / 60) / 60) * 360}deg)`;
            document.getElementById('hourHand').style.transform = `rotate(${((h + m / 60) / 12) * 360}deg)`;
        }

        // Update reminders (festivals, birthdays, games within 1 week)
        function updateReminders() {
            const now = new Date();
            const oneWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            let reminders = [];

            // Check NZ holidays
            if (config.calendar.nz) {
                holidays2026.nz.forEach(h => {
                    const eventDate = new Date(h.date);
                    if (eventDate >= now && eventDate <= oneWeek) {
                        const daysUntil = Math.ceil((eventDate - now) / (24 * 60 * 60 * 1000));
                        reminders.push({
                            text: `ğŸ‡³ğŸ‡¿ ${h.name}`,
                            days: daysUntil,
                            date: h.date
                        });
                    }
                });
            }

            // Check HK holidays
            if (config.calendar.hk) {
                holidays2026.hk.forEach(h => {
                    const eventDate = new Date(h.date);
                    if (eventDate >= now && eventDate <= oneWeek) {
                        const daysUntil = Math.ceil((eventDate - now) / (24 * 60 * 60 * 1000));
                        reminders.push({
                            text: `ğŸ‡­ğŸ‡° ${h.name}`,
                            days: daysUntil,
                            date: h.date
                        });
                    }
                });
            }

            // Check birthdays
            if (config.calendar.birthday) {
                birthdays.forEach(b => {
                    const eventDate = new Date(b.date);
                    if (eventDate >= now && eventDate <= oneWeek) {
                        const daysUntil = Math.ceil((eventDate - now) / (24 * 60 * 60 * 1000));
                        reminders.push({
                            text: `ğŸ‚ ${b.name}`,
                            days: daysUntil,
                            date: b.date
                        });
                    }
                });
            }

            // Check game events
            if (config.calendar.game) {
                gameEvents.forEach(g => {
                    const eventDate = new Date(g.date);
                    if (eventDate >= now && eventDate <= oneWeek) {
                        const daysUntil = Math.ceil((eventDate - now) / (24 * 60 * 60 * 1000));
                        reminders.push({
                            text: `ğŸ® ${g.name} @ ${g.time}`,
                            days: daysUntil,
                            date: g.date
                        });
                    }
                });
            }

            // Sort by date
            reminders.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Display
            let html = '';
            if (reminders.length === 0) {
                html = '<div class="text-slate-400 text-center mt-4">No upcoming events</div>';
            } else {
                reminders.forEach(r => {
                    const dayText = r.days === 0 ? 'Today' : r.days === 1 ? 'Tomorrow' : `In ${r.days} days`;
                    html += `<div class="reminder-item">
                        <div class="flex justify-between">
                            <span>${r.text}</span>
                            <span class="text-yellow-400">${dayText}</span>
                        </div>
                    </div>`;
                });
            }

            document.getElementById('upcomingReminders').innerHTML = html;
        }

        // Weather
        async function fetchWeather() {
            if (!config.weatherApiKey) return;
            
            let html = '';
            
            for (const loc of config.weatherLocations) {
                try {
                    const curr = await fetch(
                        `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(loc)}&appid=${config.weatherApiKey}&units=metric`
                    );
                    const currData = await curr.json();
                    
                    const forecast = await fetch(
                        `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(loc)}&appid=${config.weatherApiKey}&units=metric`
                    );
                    const fcData = await forecast.json();
                    
                    const uv = await fetch(
                        `https://api.openweathermap.org/data/2.5/uvi?lat=${currData.coord.lat}&lon=${currData.coord.lon}&appid=${config.weatherApiKey}`
                    );
                    const uvData = await uv.json();
                    
                    const next24h = fcData.list.slice(0, 8);
                    const rainForecast = next24h.map(f => {
                        const time = new Date(f.dt * 1000).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                        const pop = Math.round((f.pop || 0) * 100);
                        return `${time}:${pop}%`;
                    }).join(', ');
                    
                    html += `
                        <div class="mb-2 pb-2 border-b border-slate-700">
                            <div class="font-semibold">${currData.name}</div>
                            <div class="flex justify-between items-center my-1">
                                <span class="text-2xl font-bold">${Math.round(currData.main.temp)}Â°C</span>
                                <span class="capitalize">${currData.weather[0].description}</span>
                            </div>
                            <div class="text-xs space-y-0.5 text-slate-300">
                                <div>â˜€ï¸ UV: ${uvData.value.toFixed(1)}</div>
                                <div>ğŸ’§ 24h: ${rainForecast}</div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error(`Weather error: ${loc}`, error);
                }
            }
            
            document.getElementById('weatherContainer').innerHTML = html || '<p class="text-red-400">Weather unavailable</p>';
            document.getElementById('weatherStatus').innerHTML = 'â˜ï¸ Weather: <span class="text-green-400">Updated</span>';
        }

        // Check if it's time to refresh stocks
        function shouldRefreshStocks() {
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5); // HH:MM
            
            // Convert EST times to local time (assuming Auckland is UTC+13)
            // This is a simplified check - you may want to use proper timezone conversion
            const midTime = config.stockRefreshTimes.mid;
            const closeTime = config.stockRefreshTimes.close;
            
            // Check if current time matches refresh times (within 1 minute window)
            if (currentTime === midTime || currentTime === closeTime) {
                // Check if we haven't updated in the last hour
                if (!lastStockUpdate || (now - lastStockUpdate) > 3600000) {
                    return true;
                }
            }
            
            // Also refresh on initial load or if no cache
            if (stockCache.length === 0) return true;
            
            return false;
        }

        // Stocks - with backup API
        async function fetchStocks() {
            if (config.stockApiProvider === 'alphavantage') {
                await fetchStocksAlphaVantage();
            } else {
                await fetchStocksYahoo();
            }
        }

        async function fetchStocksAlphaVantage() {
            if (!config.stockApiKey) {
                displayStocksError('No API key configured');
                return;
            }
            
            document.getElementById('stockStatusPanel').innerHTML = 'ğŸ“ˆ Stocks: <span class="text-yellow-400">Updating...</span>';
            
            let results = [];
            
            try {
                // Use batch approach with small delay
                for (let i = 0; i < config.stocks.length; i++) {
                    const stock = config.stocks[i];
                    
                    try {
                        const res = await fetch(
                            `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${stock.symbol}&apikey=${config.stockApiKey}`
                        );
                        const data = await res.json();
                        
                        if (data['Global Quote'] && data['Global Quote']['05. price']) {
                            const q = data['Global Quote'];
                            results.push({
                                symbol: stock.symbol,
                                price: parseFloat(q['05. price']),
                                change: parseFloat(q['09. change']),
                                changePct: parseFloat(q['10. change percent'].replace('%', '')),
                                buyPrice: stock.buyPrice
                            });
                        } else if (data['Note']) {
                            console.warn('API limit reached:', data['Note']);
                            // Use cached data if available
                            if (stockCache.length > 0) {
                                displayStocksTicker(stockCache);
                                document.getElementById('stockStatusPanel').innerHTML = 
                                    'ğŸ“ˆ Stocks: <span class="text-yellow-400">Using cached data</span>';
                                return;
                            }
                        }
                        
                        // Progress update
                        document.getElementById('stockStatusPanel').innerHTML = 
                            `ğŸ“ˆ Stocks: <span class="text-yellow-400">${i + 1}/${config.stocks.length}</span>`;
                        
                        // Small delay to avoid rate limit (15 seconds for 5 calls/min)
                        if (i < config.stocks.length - 1) {
                            await new Promise(r => setTimeout(r, 15000));
                        }
                    } catch (err) {
                        console.error(`Stock error: ${stock.symbol}`, err);
                    }
                }
                
                if (results.length > 0) {
                    stockCache = results;
                    lastStockUpdate = new Date();
                    displayStocksTicker(results);
                    document.getElementById('stockStatusPanel').innerHTML = 
                        `ğŸ“ˆ Stocks: <span class="text-green-400">${results.length}/${config.stocks.length} updated</span>`;
                } else {
                    displayStocksError('No data received');
                }
            } catch (error) {
                console.error('Stock fetch error:', error);
                displayStocksError(error.message);
            }
        }

        // Yahoo Finance backup (uses unofficial API)
        async function fetchStocksYahoo() {
            document.getElementById('stockStatusPanel').innerHTML = 'ğŸ“ˆ Stocks: <span class="text-yellow-400">Using Yahoo backup...</span>';
            
            try {
                const symbols = config.stocks.map(s => s.symbol).join(',');
                const res = await fetch(
                    `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols}`
                );
                const data = await res.json();
                
                if (data.quoteResponse && data.quoteResponse.result) {
                    const results = data.quoteResponse.result.map(q => {
                        const stockConfig = config.stocks.find(s => s.symbol === q.symbol);
                        return {
                            symbol: q.symbol,
                            price: q.regularMarketPrice,
                            change: q.regularMarketChange,
                            changePct: q.regularMarketChangePercent,
                            buyPrice: stockConfig ? stockConfig.buyPrice : 0
                        };
                    });
                    
                    stockCache = results;
                    lastStockUpdate = new Date();
                    displayStocksTicker(results);
                    document.getElementById('stockStatusPanel').innerHTML = 
                        `ğŸ“ˆ Stocks: <span class="text-green-400">${results.length} updated (Yahoo)</span>`;
                } else {
                    displayStocksError('Yahoo API failed');
                }
            } catch (error) {
                console.error('Yahoo stock error:', error);
                displayStocksError(error.message);
            }
        }

        function displayStocksTicker(results) {
            let ticker = '';
            results.forEach(s => {
                const below = s.price < s.buyPrice;
                const vsBuy = ((s.price - s.buyPrice) / s.buyPrice * 100).toFixed(1);
                const icon = s.changePct >= 0 ? 'ğŸŸ¢' : 'ğŸ”´';
                const alert = below ? ' âš ï¸' : '';
                ticker += `<span class="ticker-item"><strong>${s.symbol}</strong>: $${s.price.toFixed(2)} ${icon} ${s.changePct >= 0 ? '+' : ''}${s.changePct.toFixed(1)}% | Buy: $${s.buyPrice} (${vsBuy >= 0 ? '+' : ''}${vsBuy}%)${alert}</span>`;
            });
            
            document.getElementById('stocksContent').innerHTML = ticker;
        }

        function displayStocksError(msg) {
            document.getElementById('stocksContent').innerHTML = 
                `<span class="ticker-item text-red-400">âŒ Stock update failed: ${msg}</span>`;
            document.getElementById('stockStatusPanel').innerHTML = 
                `ğŸ“ˆ Stocks: <span class="text-red-400">Failed</span>`;
        }

        // Currency
        async function fetchCurrencies() {
            let html = '';
            
            for (const c of config.currencies) {
                try {
                    const [base, quote] = c.pair.split('-');
                    const res = await fetch(`https://api.exchangerate-api.com/v4/latest/${base}`);
                    const data = await res.json();
                    
                    if (data.rates && data.rates[quote]) {
                        const rate = data.rates[quote];
                        const isAlert = c.below ? rate < c.alert : rate > c.alert;
                        
                        const alertClass = isAlert ? 'stock-alert' : 'bg-slate-800/30';
                        
                        html += `
                            <div class="${alertClass} rounded p-2">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">${base}/${quote}</span>
                                    <div class="text-right">
                                        <div class="font-mono font-bold">${rate.toFixed(4)}</div>
                                        ${isAlert ? '<i class="fas fa-bell text-yellow-400 text-xs"></i>' : ''}
                                    </div>
                                </div>
                                <div class="text-xs mt-1 text-slate-400">
                                    Alert: ${c.below ? '<' : '>'} ${c.alert}
                                </div>
                            </div>
                        `;
                    }
                } catch (err) {
                    console.error(`Currency error: ${c.pair}`, err);
                }
            }
            
            document.getElementById('currencyList').innerHTML = html;
        }

        // News with Traditional Chinese sources
        async function fetchNews() {
            let allNews = [];
            
            // Traditional Chinese sources
            const feeds = [];
            
            if (config.newsFeeds.hket) {
                feeds.push({ 
                    name: 'ç¶“æ¿Ÿæ—¥å ±', 
                    url: 'https://www.hket.com/rss/hongkong',
                    lang: 'tc'
                });
            }
            
            if (config.newsFeeds.scmp) {
                feeds.push({ 
                    name: 'SCMP', 
                    url: 'https://www.scmp.com/rss/2/feed',
                    lang: 'en'
                });
            }
            
            if (config.newsFeeds.bbc) {
                feeds.push({ 
                    name: 'BBC', 
                    url: 'https://feeds.bbci.co.uk/news/rss.xml',
                    lang: 'en'
                });
            }
            
            for (const feed of feeds) {
                try {
                    const res = await fetch(
                        `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}`
                    );
                    const data = await res.json();
                    
                    if (data.status === 'ok' && data.items) {
                        data.items.slice(0, 5).forEach(item => {
                            allNews.push(`[${feed.name}] ${item.title}`);
                        });
                    }
                } catch (err) {
                    console.error(`RSS error: ${feed.name}`, err);
                }
            }
            
            if (allNews.length > 0) {
                let ticker = '';
                allNews.forEach(n => {
                    ticker += `<span class="ticker-item">${n}</span>`;
                });
                document.getElementById('newsContent').innerHTML = ticker;
                document.getElementById('newsStatus').innerHTML = 'ğŸ“° News: <span class="text-green-400">Updated</span>';
            } else {
                document.getElementById('newsContent').innerHTML = '<span class="ticker-item">âš ï¸ RSS feeds unavailable</span>';
                document.getElementById('newsStatus').innerHTML = 'ğŸ“° News: <span class="text-red-400">Failed</span>';
            }
        }

        // Bible Verse
        function fetchBibleVerse() {
            const verses = [
                { ref: 'ç´„ç¿°ç¦éŸ³ 3:16', text: 'ç¥æ„›ä¸–äººï¼Œç”šè‡³å°‡ä»–çš„ç¨ç”Ÿå­è³œçµ¦ä»–å€‘ï¼Œå«ä¸€åˆ‡ä¿¡ä»–çš„ï¼Œä¸è‡³æ»…äº¡ï¼Œåå¾—æ°¸ç”Ÿã€‚' },
                { ref: 'è©©ç¯‡ 23:1', text: 'è€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚' },
                { ref: 'ç®´è¨€ 3:5-6', text: 'ä½ è¦å°ˆå¿ƒä»°è³´è€¶å’Œè¯ï¼Œä¸å¯å€šé è‡ªå·±çš„è°æ˜ï¼Œåœ¨ä½ ä¸€åˆ‡æ‰€è¡Œçš„äº‹ä¸Šéƒ½è¦èªå®šä»–ï¼Œä»–å¿…æŒ‡å¼•ä½ çš„è·¯ã€‚' },
                { ref: 'è…“ç«‹æ¯”æ›¸ 4:13', text: 'æˆ‘é è‘—é‚£åŠ çµ¦æˆ‘åŠ›é‡çš„ï¼Œå‡¡äº‹éƒ½èƒ½åšã€‚' },
                { ref: 'ç¾…é¦¬æ›¸ 8:28', text: 'æˆ‘å€‘æ›‰å¾—è¬äº‹éƒ½äº’ç›¸æ•ˆåŠ›ï¼Œå«æ„›ç¥çš„äººå¾—ç›Šè™•ï¼Œå°±æ˜¯æŒ‰ä»–æ—¨æ„è¢«å¬çš„äººã€‚' },
                { ref: 'ä»¥è³½äºæ›¸ 40:31', text: 'ä½†é‚£ç­‰å€™è€¶å’Œè¯çš„å¿…é‡æ–°å¾—åŠ›ã€‚ä»–å€‘å¿…å¦‚é·¹å±•ç¿…ä¸Šé¨°ï¼›ä»–å€‘å¥”è·‘å»ä¸å›°å€¦ï¼Œè¡Œèµ°å»ä¸ç–²ä¹ã€‚' },
                { ref: 'é¦¬å¤ªç¦éŸ³ 11:28', text: 'å‡¡å‹è‹¦æ“”é‡æ“”çš„äººå¯ä»¥åˆ°æˆ‘é€™è£¡ä¾†ï¼Œæˆ‘å°±ä½¿ä½ å€‘å¾—å®‰æ¯ã€‚' }
            ];
            
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const verse = verses[dayOfYear % verses.length];
            
            document.getElementById('bibleVerse').innerHTML = `
                <div class="text-slate-300 leading-relaxed">${verse.text}</div>
                <div class="text-xs text-blue-300 font-semibold text-right mt-2">â€” ${verse.ref}</div>
            `;
        }

        // Calendar
        function fetchCalendar() {
            const now = new Date();
            const day = now.getDay();
            const today = now.toISOString().slice(0, 10);
            const tomorrowDate = new Date(now.getTime() + 86400000).toISOString().slice(0, 10);
            
            let events = [];
            
            // Today's holidays
            if (config.calendar.nz) {
                const nzToday = holidays2026.nz.find(h => h.date === today);
                if (nzToday) events.push({ day: 'Today', time: 'All day', title: `ğŸ‡³ğŸ‡¿ ${nzToday.name}` });
            }
            
            if (config.calendar.hk) {
                const hkToday = holidays2026.hk.find(h => h.date === today);
                if (hkToday) events.push({ day: 'Today', time: 'All day', title: `ğŸ‡­ğŸ‡° ${hkToday.name}` });
            }
            
            // Weekly schedule
            const schedule = {
                0: [{ title: 'ä¸»æ—¥å´‡æ‹œ', time: '10:00 AM' }],
                3: [{ title: 'æŸ¥ç¶“ç­', time: '7:30 PM' }]
            };
            
            if (schedule[day] && config.calendar.personal) {
                schedule[day].forEach(e => events.push({ day: 'Today', ...e }));
            }
            
            const tomorrowDay = (day + 1) % 7;
            if (schedule[tomorrowDay] && config.calendar.personal) {
                schedule[tomorrowDay].forEach(e => events.push({ day: 'Tomorrow', ...e }));
            }
            
            // Display
            let html = '';
            if (events.length === 0) {
                html = '<p class="text-slate-400">No events today/tomorrow</p>';
            } else {
                events.forEach(e => {
                    html += `
                        <div class="calendar-event">
                            <div class="flex justify-between items-start">
                                <span class="font-semibold text-blue-300">${e.day}</span>
                                <span class="text-slate-400">${e.time}</span>
                            </div>
                            <div>${e.title}</div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('calendarContainer').innerHTML = html;
        }

        function fetchAllData() {
            fetchWeather();
            fetchCurrencies();
            fetchNews();
            fetchBibleVerse();
            fetchCalendar();
            updateReminders();
            
            // Only fetch stocks if it's the right time
            if (shouldRefreshStocks()) {
                fetchStocks();
            } else if (stockCache.length > 0) {
                // Use cached data
                displayStocksTicker(stockCache);
                document.getElementById('stockStatusPanel').innerHTML = 
                    'ğŸ“ˆ Stocks: <span class="text-blue-400">Using cached data</span>';
            }
        }

        function init() {
            loadSavedSettings();
            updateDigitalClock();
            updateAnalogClock();
            fetchAllData();
            
            // Update clock every second
            setInterval(() => {
                updateDigitalClock();
                updateAnalogClock();
            }, 1000);
            
            // Update reminders every hour
            setInterval(updateReminders, 3600000);
            
            // Update weather every hour
            setInterval(fetchWeather, 3600000);
            
            // Update currencies every 30 min
            setInterval(fetchCurrencies, 1800000);
            
            // Update news every 30 min
            setInterval(fetchNews, 1800000);
            
            // Check for stock refresh every minute
            setInterval(() => {
                if (shouldRefreshStocks()) {
                    fetchStocks();
                }
            }, 60000);
        }

        window.addEventListener('load', init);

        // Wake Lock
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(e => console.log('Wake Lock:', e));
        }
    </script>
</body>
</html>
